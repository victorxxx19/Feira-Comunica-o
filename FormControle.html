<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
      /* ======================================================
         ESTILOS PARA FORMCONTROLE (v10 - Layout com Badges)
      ====================================================== */

      /* --- 1. Configuração Geral --- */
      body {
          background-color: #F4F6F8; /* Fundo suave */
          margin: 0;
          padding: 0 0 80px 0; /* Espaço para o rodapé fixo */
          font-family: 'Roboto', 'Segoe UI', sans-serif;
      }

      #divObjetos {
          max-width: 98%; 
          margin: 20px auto; 
          padding: 0;
          background-color: transparent;
      }
      
      /* --- 2. Cabeçalho --- */
      .header-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding: 15px 25px;
          background-color: #ffffff;
          border-radius: 8px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      .header-container h4 {
          font-size: 1.6rem;
          font-weight: 600;
          color: #37417c;
          display: flex;
          align-items: center;
          margin: 0;
      }
      .header-container h4 > i {
          font-size: 2rem;
          margin-right: 15px;
      }
      .header-logo {
          max-height: 45px;
          width: auto;
      }
      .subtitulo-descricao {
          font-size: 0.9rem;
          font-style: italic;
          color: #555;
          margin-top: -10px;
          margin-bottom: 20px;
          padding-left: 5px;
      }

      /* --- 3. Container da Tabela (O Card Branco) --- */
      #tabela-container {
          border: 1px solid #E0E0E0;
          border-radius: 8px;
          overflow-x: auto; /* Permite scroll horizontal se necessário */
          overflow-y: hidden;
          background-color: #fff;
          min-height: 65vh;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }

      /* --- 4. Tabela Principal --- */
      #tabela-pedidos {
        width: 100%;
      }
      #tabela-pedidos thead {
          background-color: #37417c; 
          color: #ffffff;
      }
      #tabela-pedidos thead th {
          padding: 14px 12px;
          text-align: left;
          font-weight: 600; 
          white-space: nowrap; 
          font-size: 0.8rem;
          text-transform: uppercase;
      }
      #tabela-pedidos.striped td {
          padding: 10px 12px; 
          vertical-align: middle;
          text-align: left; 
          font-weight: 500; 
          color: #333;
          font-size: 0.9rem;
          border-bottom: 1px solid #eee;
      }
      
      /* Alinhamentos específicos */
      .col-pedido, .col-data {
        font-weight: 600;
        white-space: nowrap;
      }
      .col-status-atual, .col-acao {
        text-align: center !important;
      }
      .col-cliente, .col-descricao {
        min-width: 180px; /* Espaço para textos */
      }
      .col-faca, .col-cliche {
        min-width: 120px;
        font-weight: 600;
      }
      .col-obs { min-width: 200px; }


      .link-pedido {
          color: #0d47a1; 
          font-weight: 700;
          cursor: pointer;
          text-decoration: underline;
      }
      .link-pedido:hover {
          color: #1565c0;
      }

      /* --- 5. (NOVO) Status Flags / Badges --- */
      .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 5px 12px;
        border-radius: 16px; /* Pill shape */
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #fff;
        white-space: nowrap;
      }
      .status-badge .icon {
        font-size: 1rem;
        margin-right: 6px;
      }

      /* Cores das Flags */
      .status-faca { background-color: #7E57C2; } /* Roxo */
      .status-cliche { background-color: #FFA726; } /* Laranja */
      .status-faca-cliche { background-color: #42A5F5; } /* Azul */
      .status-disponivel { background-color: #66BB6A; } /* Verde */
      .status-outro { background-color: #BDBDBD; color: #333; } /* Cinza */


      /* --- 6. (NOVO) Botão de Ação --- */
      .btn-liberar {
        background-color: #4CAF50 !important; /* Verde */
        color: white !important;
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0 12px;
        height: 32px;
        line-height: 32px;
        border-radius: 4px;
        text-transform: none;
      }
      .btn-liberar:hover {
        background-color: #43A047 !important;
      }
      .btn-liberar i {
        font-size: 1.1rem;
        margin-right: 5px;
        vertical-align: middle;
        margin-top: -2px; /* Ajuste fino */
      }
      /* Quando o botão está desabilitado (Status NÃO é Disponível) */
      .btn-liberar.disabled {
        background-color: #E0E0E0 !important; /* Cinza claro */
        color: #9E9E9E !important;
        cursor: not-allowed;
      }
      
      /* --- 7. Input de Observação --- */
      #tabela-pedidos td .input-field {
          margin: 0; padding: 0;
      }
      #tabela-pedidos input[type="text"].obs-input {
          border-bottom: 1px solid #ccc !important;
          box-shadow: none !important;
          text-align: left;
          font-weight: 500;
          color: #000;
          height: 2.5rem !important; 
          line-height: 2.5rem !important;
          margin-bottom: 0;
          padding: 0 8px;
          border-radius: 4px;
      }
      #tabela-pedidos input[type="text"].obs-input:focus {
          border-bottom: 2px solid #37417c !important;
      }
      /* Destaca input com texto */
      #tabela-pedidos input[type="text"].obs-input.dirty {
         border: 1px solid #37417c;
         background-color: #f5f7fa;
      }

      /* --- 8. Rodapé Fixo --- */
      #footer-bar {
          position: fixed; bottom: 0; left: 0; width: 100%;
          background-color: #ffffff; border-top: 1px solid #ddd;
          padding: 12px 24px; display: flex;
          justify-content: flex-end;
          box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
          z-index: 999;
      }
      
      /* --- 9. Modal de Detalhes (Estilo Original) --- */
      .modal { border-radius: 12px !important; }
      .modal h4 { color: #37417c; font-weight: 600; }
      .modal .modal-footer .btn-flat { color: #E53935 !important; }
      .modal .modal-footer .btn { background-color: #37417c !important; }
      #detalhes-pedido-modal {
          max-width: 1200px !important; width: 95% !important;
          max-height: 90% !important;
      }
      #detalhes-pedido-modal h4 {
          border-bottom: 2px solid;
          border-image: linear-gradient(to right, #37417c, #C8E154) 1;
          padding-bottom: 15px; margin-bottom: 20px !important;
      }
      .detalhes-pedido-grid-3-col {
          display: grid; grid-template-columns: repeat(3, 1fr);
          gap: 12px 24px; margin-bottom: 20px;
      }
      .detalhes-pedido-item { display: flex; flex-direction: column; }
      .detalhes-pedido-label {
          font-size: 0.75rem; color: #666; text-transform: uppercase;
          font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px;
      }
      .detalhes-pedido-valor {
          font-size: 0.95rem; color: #000; font-weight: 500;
          padding: 8px 12px; background-color: #f5f7fa;
          border-radius: 6px; border-left: 3px solid #37417c;
          min-height: 38px; word-wrap: break-word;
      }
      .detalhes-pedido-secao {
          margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;
      }
      .detalhes-pedido-secao-titulo {
          font-size: 0.85rem; color: #37417c; text-transform: uppercase;
          font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px;
          display: flex; align-items: center;
      }
      .detalhes-pedido-secao-titulo i { margin-right: 8px; font-size: 1.1rem; }
      .detalhes-pedido-obs {
          background-color: #fff3cd; border-left: 4px solid #ffc107;
          padding: 12px 16px; border-radius: 6px; color: #856404;
          font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;
          word-wrap: break-word;
      }
      .detalhes-pedido-obs.vazio {
          background-color: #f5f7fa; border-left-color: #ccc;
          color: #999; font-style: italic;
      }
    </style>
</head>

<body>
    
    <div id="toast-custom-container" 
         style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000;">
    </div>

    <div id="divObjetos">

        <div class="header-container">
            <h4>
                <i class="material-icons">assignment_turned_in</i>
                PCP: Controle de Liberação de Pedidos
            </h4>
            <img src="[meucodebase64]" alt="Logo" class="header-logo">
        </div>

        <p class="subtitulo-descricao">
            Pedidos aguardando insumos ou conferência para liberação.
        </p>

        <div id="loader" class="center-align" style="padding: 50px;">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                </div>
            </div>
            <p>Buscando pedidos... Aguarde.</p>
        </div>
        
        <div id="tabela-container" style="display: none;">
            
            <table id="tabela-pedidos" class="striped">
                <thead>
                    <tr>
                        <th class="col-pedido">Nº Pedido</th>
                        <th class="col-data">Data de Entrega</th>
                        <th class="col-cliente">Cliente</th>
                        <th class="col-descricao">Descrição</th>
                        <th class="col-faca">Faca</th>
                        <th class="col-cliche">Clichê</th>
                        <th class="col-status-atual">Status Atual</th>
                        <th class="col-obs">Observação PCP</th>
                        <th class="col-acao">Ação</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                </tbody>
            </table>
        </div>
        
        <p id="sem-pedidos" class="center-align" style="display: none; font-size: 1.2rem; margin-top: 30px;">
            <i class="material-icons left">check_circle</i>Não há pedidos pendentes para o PCP.
        </p>

    </div> 
    
    <div id="footer-bar">
        <button id="btnSalvarObs" class="btn waves-effect green" disabled>
            Salvar Observações
            <i class="material-icons right">save</i>
        </button>
    </div>

    <div id="detalhes-pedido-modal" class="modal">
        <div class="modal-content">
            <h4 id="detalhes-titulo">Detalhes do Pedido</h4>
            
            <div id="detalhes-loading" style="text-align: center; padding: 40px; display: block;">
                 <div class="preloader-wrapper big active">
                   <div class="spinner-layer spinner-blue-only">
                     <div class="circle-clipper left"><div class="circle"></div></div>
                     <div class="gap-patch"><div class="circle"></div></div>
                     <div class="circle-clipper right"><div class="circle"></div></div>
                   </div>
                 </div>
                 <p>Buscando dados...</p>
            </div>
            
            <div id="detalhes-conteudo" style="display: none;">
                <div class="detalhes-pedido-grid-3-col">
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">N° Pedido</span><span id="detalhe-num-pedido" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Pedido</span><span id="detalhe-data-pedido" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Pedido</span><span id="detalhe-tipo-pedido" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Quantidade Pedida</span><span id="detalhe-quantidade" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Vendedora</span><span id="detalhe-vendedora" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Expedição</span><span id="detalhe-tipo-expedicao" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Entrega</span><span id="detalhe-data-entrega" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Conclusão</span><span id="detalhe-data-conclusao" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Status do Pedido</span><span id="detalhe-status" class="detalhes-pedido-valor"></span></div>
                    
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cód. Produto</span><span id="detalhe-cod-produto" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cliente</span><span id="detalhe-cliente" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item span-2"><span class="detalhes-pedido-label">Descrição do Produto</span><span id="detalhe-descricao" class="detalhes-pedido-valor"></span></div>
                    
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Faca</span><span id="detalhe-faca" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Clichê</span><span id="detalhe-cliche" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Substrato</span><span id="detalhe-substrato" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Cola</span><span id="detalhe-tipo-cola" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Largura (mm)</span><span id="detalhe-largura" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Altura (mm)</span><span id="detalhe-altura" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Puxada (mm)</span><span id="detalhe-puxada" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Qtd. Cores</span><span id="detalhe-qtd-cores" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Carreiras</span><span id="detalhe-carreiras" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Acabamento</span><span id="detalhe-tipo-acabamento" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cold</span><span id="detalhe-cold" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Metragem Calculada (m)</span><span id="detalhe-metragem" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Sem Excedente?</span><span id="detalhe-sem-excedente" class="detalhes-pedido-valor"></span></div>
                    
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Máquina (Prod)</span><span id="detalhe-maquina" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Fila (Prod)</span><span id="detalhe-fila" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Impressor</span><span id="detalhe-impressor" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Início Produção</span><span id="detalhe-data-inicio-prod" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Fim Produção</span><span id="detalhe-data-fim-prod" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Fornecedor Substrato</span><span id="detalhe-fornecedor-substrato" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Lote Substrato</span><span id="detalhe-lote-substrato" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Metragem Real (m)</span><span id="detalhe-metragem-real" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Refugo (m)</span><span id="detalhe-refugo-metragem" class="detalhes-pedido-valor"></span></div>
                    
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Unidade CQ</span><span id="detalhe-unidade-cq" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Inspetor</span><span id="detalhe-inspetor" class="detalhes-pedido-valor"></span></div>
                    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Qtd. Aprovada CQ</span><span id="detalhe-qtd-aprovada-cq" class="detalhes-pedido-valor"></span></div>
                </div>

                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">announcement</i> Observações PCP</h6>
                    <div id="detalhe-obs-pcp" class="detalhes-pedido-obs vazio">Nenhuma observação.</div>
                </div>
                
                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">build</i> Problemas da Produção</h6>
                    <div id="detalhe-problemas-producao" class="detalhes-pedido-obs vazio">Nenhum problema relatado.</div>
                </div>

                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">info</i> Observações/Problemas CQ</h6>
                    <div id="detalhe-obs-cq" class="detalhes-pedido-obs vazio">Nenhuma observação.</div>
                </div>
                
                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">warning</i> Motivo Metragem a Mais</h6>
                    <div id="detalhe-motivo-mais-metragem" class="detalhes-pedido-obs vazio">Nenhum motivo informado.</div>
                </div>
                
                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">history</i> Motivo Atraso</h6>
                    <div id="detalhe-motivo-atraso" class="detalhes-pedido-obs vazio">Nenhum atraso ou motivo informado.</div>
                </div>
                
                <div class="detalhes-pedido-secao">
                    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">cancel</i> Motivo Cancelamento</h6>
                    <div id="detalhe-motivo-cancelamento" class="detalhes-pedido-obs vazio">Não cancelado.</div>
                </div>

            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-close waves-effect waves-grey btn-flat">Fechar</button>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // ======================================================
        //   JAVASCRIPT DO FORMCONTROLE (Repaginado v10)
        // ======================================================
        
        var listaDePedidos = <?!= JSON.stringify(pedidos) ?>;
        let pedidosCarregados = [];
        let modalDetalhesInstance;
        
        document.addEventListener('DOMContentLoaded', function() {
            M.Modal.init(document.querySelectorAll('.modal'));
            
            const modalDetalhesElement = document.getElementById('detalhes-pedido-modal');
            modalDetalhesInstance = M.Modal.getInstance(modalDetalhesElement, { dismissible: true });

            construirTabela(listaDePedidos); 
            
            document.getElementById('btnSalvarObs').addEventListener('click', onSalvarObservacoesClick);
        });
        
        function formatarNumero(valor) {
            if (valor === null || valor === undefined || valor === "") return '0';
            let num = parseFloat(String(valor).replace(/\./g, '').replace(',', '.'));
            if (isNaN(num)) return valor;
            return num.toLocaleString('pt-BR', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
        }

        function carregarPedidos() {
            google.script.run
                .withSuccessHandler(construirTabela)
                .withFailureHandler(showErrorToast)
                .buscarPedidosParaPCP(); // Função do .gs que alteramos
        }

        function construirTabela(pedidos) {
            const loader = document.getElementById('loader');
            const tabelaContainer = document.getElementById('tabela-container');
            const tabelaCorpo = document.getElementById('tabela-corpo');
            const btnSalvar = document.getElementById('btnSalvarObs');
            const msgSemPedidos = document.getElementById('sem-pedidos');
            
            tabelaCorpo.innerHTML = ''; 
            pedidosCarregados = pedidos || []; 

            if (pedidosCarregados.length === 0) {
                loader.style.display = 'none';
                msgSemPedidos.style.display = 'block';
                tabelaContainer.style.display = 'none';
                btnSalvar.disabled = true;
                return;
            }
            
            // Ordena por Data de Entrega (mais antigo primeiro)
            pedidosCarregados.sort((a, b) => {
              try {
                // Converte "dd/MM/yyyy" para "yyyy-MM-dd" para ordenar corretamente
                const dateA = new Date(a.dataEntrega.split('/').reverse().join('-'));
                const dateB = new Date(b.dataEntrega.split('/').reverse().join('-'));
                return dateA - dateB;
              } catch(e) { return 0; }
            });

            pedidosCarregados.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.dataset.linhaPlanilha = pedido.linhaPlanilha;
                
                const statusClass = getStatusClass(pedido.status);
                const statusIcon = getStatusIcon(pedido.status);

                tr.innerHTML += `<td class="col-pedido link-pedido" onclick="handleNumeroPedidoClick('${pedido.linhaPlanilha}')" title="Ver Detalhes">${pedido.numPedido}</td>`;
                tr.innerHTML += `<td class="col-data">${pedido.dataEntrega}</td>`;
                tr.innerHTML += `<td class="col-cliente">${pedido.cliente}</td>`;
                tr.innerHTML += `<td class="col-descricao">${pedido.descricao}</td>`;
                tr.innerHTML += `<td class="col-faca">${pedido.faca || "---"}</td>`;
                tr.innerHTML += `<td class="col-cliche">${pedido.idCliche || "---"}</td>`;
                
                tr.innerHTML += `<td class="col-status-atual">
                                   <div class="status-badge ${statusClass}">
                                     <i class="material-icons icon">${statusIcon}</i>
                                     <span>${pedido.status}</span>
                                   </div>
                                 </td>`;
                
                const tdObs = document.createElement('td');
                tdObs.className = 'col-obs';
                const obsId = `obs_${pedido.linhaPlanilha}`;
                tdObs.innerHTML = `<div class="input-field"><input type="text" class="obs-input" id="${obsId}" value="${pedido.obs || ''}"></div>`;
                tr.appendChild(tdObs);

                const tdAcao = document.createElement('td');
                tdAcao.className = 'col-acao';
                
                // O botão só fica habilitado se o status for "Disponível"
                const isDisabled = (pedido.status !== 'Disponível');
                const disabledAttr = isDisabled ? 'disabled' : '';
                const title = isDisabled ? 'Aguardando insumos' : 'Liberar para Produção';
                
                tdAcao.innerHTML = `<button class="btn-small btn-liberar waves-effect ${disabledAttr}" title="${title}" onclick="liberarPedidoParaProducao(this, '${pedido.linhaPlanilha}', '${pedido.numPedido}')">
                                      <i class="material-icons">check</i>
                                      Liberar
                                    </button>`;
                tr.appendChild(tdAcao);

                tabelaCorpo.appendChild(tr);
            });
            
            setupObsListeners();
            
            loader.style.display = 'none';
            msgSemPedidos.style.display = 'none';
            tabelaContainer.style.display = 'block';
        }

        function setupObsListeners() {
            const inputs = document.querySelectorAll('.obs-input');
            const btnSalvar = document.getElementById('btnSalvarObs');
            
            inputs.forEach(input => {
                if(input.value) input.classList.add('dirty');
                
                input.addEventListener('input', () => {
                    input.classList.add('dirty'); 
                    btnSalvar.disabled = false; 
                });
            });
        }

        function onSalvarObservacoesClick() {
            const btn = this;
            btn.disabled = true;
            showSuccessToast("Salvando observações...");

            const pedidosAtualizados = [];
            const inputs = document.querySelectorAll('.obs-input.dirty');

            if (inputs.length === 0) {
                showErrorToast("Nenhuma observação foi alterada.");
                btn.disabled = false; // Reabilita o botão
                return;
            }

            inputs.forEach(input => {
                const linhaPlanilha = input.id.split('_')[1];
                const pedidoOriginal = pedidosCarregados.find(p => p.linhaPlanilha == linhaPlanilha);
                
                pedidosAtualizados.push({
                    linhaPlanilha: linhaPlanilha,
                    status: pedidoOriginal.status, // Mantém o status original
                    obs: input.value
                });
                input.classList.remove('dirty');
            });
            
            google.script.run
                .withSuccessHandler(onSalvarSucesso)
                .withFailureHandler(onSalvarErro)
                .salvarControlePCP(pedidosAtualizados);
        }

        function liberarPedidoParaProducao(botao, linhaPlanilha, numPedido) {
            botao.disabled = true;
            botao.innerHTML = '<i class="material-icons">autorenew</i> Liberando...';
            
            const obsInput = document.getElementById(`obs_${linhaPlanilha}`);
            const obsValor = (obsInput) ? obsInput.value : "";
            
            const pedidoParaSalvar = [{
                linhaPlanilha: linhaPlanilha,
                status: "Liberado para produção",
                obs: obsValor
            }];
            
            google.script.run
                .withSuccessHandler((msg) => {
                    showSuccessToast(`Pedido ${numPedido} liberado para produção!`);
                    // Remove a linha da tabela
                    const tr = botao.closest('tr');
                    tr.style.opacity = 0;
                    setTimeout(() => tr.remove(), 300); // Efeito de fade out
                })
                .withFailureHandler((err) => {
                    showErrorToast(err.message);
                    botao.disabled = false;
                    botao.innerHTML = '<i class="material-icons">check</i> Liberar';
                })
                .salvarControlePCP(pedidoParaSalvar);
        }

        function getStatusIcon(status) {
            if (status === 'Aguardando Faca') return 'style';
            if (status === 'Aguardando Clichê') return 'auto_awesome_mosaic';
            if (status === 'Aguardando Faca e Clichê') return 'build_circle';
            if (status === 'Disponível') return 'check_circle';
            return 'help_outline';
        }
        function getStatusClass(status) {
            if (status === 'Aguardando Faca') return 'status-faca';
            if (status === 'Aguardando Clichê') return 'status-cliche';
            if (status === 'Aguardando Faca e Clichê') return 'status-faca-cliche';
            if (status === 'Disponível') return 'status-disponivel'; 
            return 'status-outro'; 
        }
        
        function onSalvarSucesso(msg) {
            showSuccessToast(msg);
            // NÃO recarrega a tabela inteira, apenas desabilita o botão
            document.getElementById('btnSalvarObs').disabled = true;
        }
        
        function onSalvarErro(err) {
            showErrorToast(err.message || err);
            document.getElementById('btnSalvarObs').disabled = false;
        }

        function showSuccessToast(message) {
            M.toast({
                html: `<i class="material-icons left">check</i> ${message}`,
                classes: 'green',
                displayLength: 4000,
                container: '#toast-custom-container'
            });
        }
        function showErrorToast(error) {
            const msg = (typeof error === 'object' && error.message) ? error.message : error;
            M.toast({
                html: `<i class="material-icons left">error</i> ${msg}`,
                classes: 'red',
                displayLength: 5000,
                container: '#toast-custom-container'
            });
        }

        // --- Funções do Modal de Detalhes ---
        function handleNumeroPedidoClick(linhaPlanilha) {
            const loading = document.getElementById('detalhes-loading');
            const content = document.getElementById('detalhes-conteudo');
            loading.style.display = 'block';
            content.style.display = 'none';
            
            const campos = content.querySelectorAll('.detalhes-pedido-valor');
            campos.forEach(campo => campo.innerText = '---');
            const obs = content.querySelectorAll('.detalhes-pedido-obs');
            obs.forEach(campo => {
              campo.innerText = 'Buscando...';
              campo.className = 'detalhes-pedido-obs vazio';
            });
            
            modalDetalhesInstance.open();
            
            google.script.run
                .withSuccessHandler(onGetDetalhesSucesso)
                .withFailureHandler(onGetDetalhesErro)
                .getDetalhesCompletosDoPedido(linhaPlanilha);
        }

        function onGetDetalhesSucesso(detalhes) {
            const loading = document.getElementById('detalhes-loading');
            const content = document.getElementById('detalhes-conteudo');
            
            const preencher = (id, valor, sufixo = '') => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerText = (valor || '---') + (valor ? sufixo : '');
                }
            };
            
            const preencherObs = (id, valor, textoVazio = 'Nenhuma observação.') => {
                const el = document.getElementById(id);
                if (el) {
                    if (valor && valor.trim()) {
                        el.innerText = valor;
                        el.className = 'detalhes-pedido-obs';
                         if (id === 'detalhe-problemas-producao' || id === 'detalhe-motivo-cancelamento' || id === 'detalhe-motivo-atraso') {
                            el.style.borderColor = '#D32F2F'; el.style.backgroundColor = '#FFEBEE'; el.style.color = '#B71C1C';
                         } else {
                            el.style.borderColor = '#ffc107'; el.style.backgroundColor = '#fff3cd'; el.style.color = '#856404';
                         }
                    } else {
                        el.innerText = textoVazio;
                        el.className = 'detalhes-pedido-obs vazio';
                        el.style.borderColor = ''; el.style.backgroundColor = ''; el.style.color = '';
                    }
                }
            };

            // Preenchimento dos campos (mantido)
            preencher('detalhe-num-pedido', detalhes.numPedido);
            preencher('detalhe-data-pedido', detalhes.dataPedido);
            preencher('detalhe-tipo-pedido', detalhes.tipo);
            preencher('detalhe-quantidade', formatarNumero(detalhes.quantidade));
            preencher('detalhe-vendedora', detalhes.vendedora);
            preencher('detalhe-tipo-expedicao', detalhes.tipoExpedicao);
            preencher('detalhe-data-entrega', detalhes.dataEntrega);
            preencher('detalhe-data-conclusao', detalhes.dataConclusao);
            preencher('detalhe-status', detalhes.status);
            preencher('detalhe-cod-produto', detalhes.codProduto);
            preencher('detalhe-cliente', detalhes.cliente);
            preencher('detalhe-descricao', detalhes.descricao);
            preencher('detalhe-faca', detalhes.faca);
            preencher('detalhe-cliche', detalhes.idCliche);
            preencher('detalhe-substrato', detalhes.substrato);
            preencher('detalhe-tipo-cola', detalhes.tipoCola);
            preencher('detalhe-largura', detalhes.largura, ' mm');
            preencher('detalhe-altura', detalhes.altura, ' mm');
            preencher('detalhe-puxada', detalhes.puxada, ' mm');
            preencher('detalhe-qtd-cores', detalhes.qtdCores);
            preencher('detalhe-carreiras', detalhes.carreiras);
            preencher('detalhe-tipo-acabamento', detalhes.tipoAcabamento);
            preencher('detalhe-cold', detalhes.cold);
            preencher('detalhe-metragem', detalhes.metragem, ' m');
            preencher('detalhe-sem-excedente', (detalhes.semExcedente === 'true' || detalhes.semExcedente === 'VERDADEIRO') ? 'SIM' : 'NÃO');
            preencher('detalhe-maquina', detalhes.maquina);
            preencher('detalhe-fila', detalhes.fila);
            preencher('detalhe-impressor', detalhes.impressor);
            preencher('detalhe-data-inicio-prod', detalhes.dataInicioProd);
            preencher('detalhe-data-fim-prod', detalhes.dataFimProd);
            preencher('detalhe-fornecedor-substrato', detalhes.fornecedorSubstrato);
            preencher('detalhe-lote-substrato', detalhes.loteSubstrato);
            preencher('detalhe-metragem-real', detalhes.metragemReal, ' m');
            preencher('detalhe-refugo-metragem', detalhes.refugoMetragem, ' m');
            preencher('detalhe-unidade-cq', detalhes.unidadeCQ);
            preencher('detalhe-inspetor', detalhes.inspetor);
            preencher('detalhe-qtd-aprovada-cq', formatarNumero(detalhes.qtdAprovadaCQ));
            
            preencherObs('detalhe-obs-pcp', detalhes.obsPCP);
            preencherObs('detalhe-problemas-producao', detalhes.problemasProducao, 'Nenhum problema relatado.');
            preencherObs('detalhe-obs-cq', detalhes.obsCQ);
            preencherObs('detalhe-motivo-mais-metragem', detalhes.motivoMaisMetragem, 'Nenhum motivo informado.');
            preencherObs('detalhe-motivo-atraso', detalhes.motivoAtraso, 'Nenhum atraso ou motivo informado.');
            preencherObs('detalhe-motivo-cancelamento', detalhes.motivoCancelamento, 'Não cancelado.');

            loading.style.display = 'none';
            content.style.display = 'block';
        }

        function onGetDetalhesErro(err) {
            showErrorToast('Erro ao buscar detalhes: ' + err.message);
            modalDetalhesInstance.close();
        }
    </script>
</body>
</html>
