<html lang="pt-BR">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <style>
        body {
            padding-bottom: 80px;
            background-color: #f5f7fa; 
        }
        #divObjetos {
            max-width: 98%; margin: 20px auto; 
            padding: 0 10px; background-color: transparent;
            border: none; box-shadow: none;
        }
        
        /* --- Cabeçalho com Logo --- */
        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 15px 20px;
            background-color: #ffffff; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom: 3px solid #37417c; 
        }
        .header-container h4 {
            font-size: 1.8rem; font-weight: 600; color: #37417c;
            display: flex; align-items: center; margin: 0;
        }
        .header-container h4 > i {
            font-size: 2.2rem; margin-right: 10px; color: #37417c;
        }
        .header-logo { max-height: 50px; width: auto; }
        .subtitulo-descricao {
            font-style: italic; color: #666; margin-left: 10px;
            margin-top: 5px; margin-bottom: 20px;
        }
        .secao-titulo {
            font-size: 1.5rem; font-weight: 600; color: #37417c; 
            margin: 30px 0 25px 5px; display: flex; align-items: center;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .secao-titulo i {
            font-size: 2rem; margin-right: 10px; color: #37417c;
        }
        
        /* --- Containers de Tabela (O "Card" Branco) --- */
        .tabela-container, .maquina-quadro, .batida-quadro {
            background-color: #ffffff; border-radius: 8px;
            overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .mensagem-vazia {
            padding: 30px 20px; text-align: center; color: #666;
            font-style: italic; background-color: #f9f9f9;
            border-radius: 4px; margin: 20px;
        }

        /* --- Estilo das Tabelas --- */
        table.responsive-table { width: 100%; table-layout: fixed; }
        table thead { background: #37417c; }
        .batida-quadro table thead { background: #6A1B9A; } /* Roxo */
        
        table thead th {
            padding: 12px 8px !important; text-align: center !important;
            font-weight: 600 !important; color: #ffffff !important; 
            text-transform: uppercase; font-size: 0.75rem;
            letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.1);
        }
        table thead th:last-child { border-right: none; }
        table tbody td {
            padding: 8px 6px !important; vertical-align: middle !important;
            text-align: center; color: #333; font-size: 0.85rem;
            border-bottom: 1px solid #e0e0e0; word-wrap: break-word; 
        }
        table tbody tr:hover { background-color: #f5f7fa !important; }

        /* --- Inputs e Selects dentro das tabelas --- */
        table .input-field {
            margin: 0 !important; padding: 0 !important;
            height: 100% !important;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            height: 40px !important; 
        }
        table .select-wrapper {
            margin-bottom: 0 !important; height: auto !important;
            min-height: 100%; display: flex;
            align-items: center; justify-content: center;
            width: 100%; 
        }
        table input[type="text"],
        table input[type="number"],
        table .select-wrapper input.select-dropdown {
            text-align: center !important; font-weight: 500;
            color: #333 !important; border-bottom: none !important;
            box-shadow: none !important; margin: 0 !important;
            height: auto !important; line-height: normal !important;
            font-size: 0.85rem !important; padding: 0 !important;
            box-sizing: border-box;
            width: 100% !important; 
        }
        table .select-wrapper .caret { display: none !important; }
        .dropdown-content li > span {
            text-align: center !important; display: block !important;
            color: #333 !important;
        }

        /* --- Colunas Tabela Superior ("Para Programar") --- */
        .col-pedido { width: 8%; cursor: pointer !important; font-weight:700 !important; }
        .col-data { width: 10%; }
        .col-cliente { width: 18%; }
        .col-descricao { width: 20%; }
        .col-status-atual { width: 12%; }
        .col-maquina { width: 15%; }
        .col-obs { width: 17%; }

        /* --- Colunas Tabela Inferior ("Fila das Máquinas") --- */
        .col-fila-mq { width: 3%; } 
        .col-pedido-mq { width: 5%; }
        .col-data-mq { width: 9%; }
        .col-cliente-mq { width: 15%; }
        .col-descricao-mq { width: 20%; }
        .col-maquina-mq { width: 9%; } 
        .col-qtd-mq { width: 5%; }
        .col-metragem-mq { width: 6%; }
        .col-impressor-mq { width: 8%; }
        .col-status-mq { width: 13%; } 
        .col-acoes-mq { width: 7%; } 
        
        /* --- Colunas Tabela Batida (NOVO) --- */
        .col-pedido-batida { width: 10%; }
        .col-data-batida { width: 10%; }
        .col-cliente-batida { width: 25%; }
        .col-descricao-batida { width: 30%; }
        .col-faca-batida { width: 10%; }
        .col-status-batida { width: 15%; }

        /* --- Status de Data (Atrasado/Alerta) --- */
        .data-alerta { color: #FF9800 !important; font-weight: 600 !important; }
        .data-atrasada { color: #D32F2F !important; font-weight: 600 !important; }
        .data-status-icon {
            font-size: 1rem; vertical-align: middle; margin-left: 5px;
        }

        /* --- Status de Pedido (Cores) --- */
        .col-status-atual, .col-status-mq {
            text-align: center; font-weight: 600; 
            vertical-align: middle; padding: 8px 4px !important; 
        }
        .status-liberado-prod { background-color: #E8F5E9 !important; color: #2E7D32 !important; }
        .status-programado { background-color: #FFF9C4 !important; color: #F57F17 !important; }
        .status-setup { background-color: #E1F5FE !important; color: #0277BD !important; }
        .status-em-producao { background-color: #F3E5F5 !important; color: #6A1B9A !important; }
        .status-controlando { background-color: #E3F2FD !important; color: #1565C0 !important; }
        .status-aguardando-batida { background-color: #FFF9C4 !important; color: #F57F17 !important; }
        .status-na-expedicao { background-color: #E6F6E6 !important; color: #1B5E20 !important; }
        .status-concluido { background-color: #616161 !important; color: #FFFFFF !important; }
        
        /* <<< NOVOS STATUS (V4.5) >>> */
        .status-setup-digital { background-color: #E1F5FE !important; color: #0277BD !important; }
        .status-imprimindo-digital { background-color: #E0F7FA !important; color: #006064 !important; }
        .status-cortando-digital { background-color: #EDE7F6 !important; color: #311B92 !important; }
        .status-aguardando-corte-digital { background-color: #FFF9C4 !important; color: #F57F17 !important; }


        /* --- Estrutura dos Quadros de Máquina --- */
        #quadros-maquinas-container { display: flex; flex-direction: column; gap: 30px; }
        .maquina-titulo {
            font-size: 1.2rem; font-weight: 600; color: #37417c;
            padding: 15px 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8ebf0 100%);
            border-bottom: 3px solid #37417c; text-transform: uppercase;
            display: flex; align-items: center; letter-spacing: 0.5px;
        }
        .maquina-titulo i { margin-right: 10px; color: #37417c; font-size: 1.5rem; }
        .quadro-corpo { padding: 0; overflow-x: auto; }
        .maquina-tabela {
            width: 100%; border-collapse: collapse;
            margin: 0; table-layout: fixed;
        }

        /* --- Controles de Fila (▲ ▼) --- */
       .fila-controles { display: flex; justify-content: center; align-items: center; }
       .btn-fila {
            background: none; border: none; padding: 2px 6px;
            margin: 0; line-height: 1; cursor: pointer;
            color: #37417c; font-size: 0.8rem; transition: all 0.2s;
            border-radius: 4px;
       }
       .btn-fila:hover:not(:disabled) { color: #1976D2; background-color: #E3F2FD; }
       .btn-fila:disabled { opacity: 0.3; cursor: not-allowed; color: #999; }
       .fila-numero { font-weight: 700; font-size: 0.8rem; color: #37417c; }

        /* --- Botões de Ação (Play, Check, etc.) --- */
        .col-acoes-mq {
            text-align: center; padding: 0 5px !important; white-space: nowrap; 
        }
        .col-acoes-mq .btn-floating {
             margin: 0 3px; width: 32px; height: 32px; line-height: 32px;
        }
         .col-acoes-mq .btn-floating i {
             font-size: 1.2rem; line-height: 32px;
          }

        /* --- Rodapé Fixo --- */
        #footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #ffffff; border-top: 2px solid #37417c;
            padding: 15px 30px; display: flex;
            justify-content: flex-end; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 999;
        }
         #footer-bar .btn {
            height: 45px; line-height: 45px;
            padding-left: 5px !important; padding-right: 20px !important;
            font-weight: 600; width: 250px !important; 
            flex-grow: 0; margin-left: 8px !important; 
         }
         #footer-bar .btn i { margin-left: -20px !important; }
        
        .btn-salvar { background: linear-gradient(135deg, #43A047 0%, #66BB6A 100%) !important; }
        .btn-salvar:disabled { background: #cccccc !important; box-shadow: none; }
        .divider {
            height: 2px;
            background: linear-gradient(to right, #37417c 0%, #C8E154 100%);
            margin: 40px 0; border: none;
        }

        /* --- Estilos dos Modais --- */
        .modal { border-radius: 12px !important; }
        .modal h4 { color: #37417c; font-weight: 600; }
        .modal .modal-footer .btn-flat { color: #E53935 !important; }
        .modal .modal-footer .btn { background-color: #37417c !important; }
        .modal .modal-footer .btn.green { background-color: #4CAF50 !important; }

        /* Estilo Título do Modal (com linha gradiente) */
        #detalhes-pedido-modal h4, #modalConsumo h4, #modalMotivoConsumo h4,#modalAnilox h4 {
            border-bottom: 2px solid;
            border-image: linear-gradient(to right, #37417c, #C8E154) 1;
            padding-bottom: 15px; margin-bottom: 20px !important;
            font-size: 1.5rem !important; display: flex;
            align-items: center;
        }
        #modalConsumo h4 i, #modalAnilox h4 i {
            color: #37417c !important; margin-right: 10px;
        }
        
        /* Modal de Consumo Pequeno */
        #modalConsumo { max-width: 450px !important; }
        #consumo-grid-simples {
            display: flex; flex-direction: column;
            gap: 20px; margin-bottom: 20px;
        }
        .detalhes-pedido-label {
            font-size: 0.75rem; color: #666; text-transform: uppercase;
            font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .detalhes-pedido-valor {
            font-size: 0.95rem; color: #000; font-weight: 500;
            padding: 8px 12px; background-color: #f5f7fa;
            border-radius: 6px; border: 2px solid #37417c;
        }
        #consumo-input-wrapper {
            padding: 8px 12px !important; background-color: #f5f7fa;
            border-radius: 6px; border: 2px solid #37417c;
            margin-top: 5px !important;
        }
        #consumo-input-wrapper input[type=number] {
            border-bottom: none !important; box-shadow: none !important;
            background-color: transparent !important; margin: 0 !important;
            height: 1.5rem !important; padding: 0 !important;
        }
        #consumo-input-wrapper label {
            transform: translateY(-160%) !important; position: relative !important;
            font-size: 0.75rem !important; color: #37417c !important;
            text-transform: uppercase !important; font-weight: 600 !important;
        }

        /* --- Modal de Detalhes (Layout) --- */
        #detalhes-pedido-modal { max-width: 1200px !important; width: 95% !important; max-height: 90% !important; }
        .detalhes-pedido-grid-3-col {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 12px 24px; margin-bottom: 20px;
        }
        .detalhes-pedido-item { display: flex; flex-direction: column; }
        .detalhes-pedido-valor {
             min-height: 38px; word-wrap: break-word;
        }
        .detalhes-pedido-item.full-width { grid-column: 1 / -1; }
        .detalhes-pedido-item.span-2 { grid-column: span 2; }
        .detalhes-pedido-secao {
            margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;
        }
        .detalhes-pedido-secao-titulo {
            font-size: 0.85rem; color: #37417c; text-transform: uppercase;
            font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px;
            display: flex; align-items: center;
        }
        .detalhes-pedido-secao-titulo i { margin-right: 8px; font-size: 1.1rem; }
        .detalhes-pedido-obs {
            background-color: #fff3cd; border: 2px solid #37417c;
            padding: 12px 16px; border-radius: 6px; color: #856404;
            font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;
            word-wrap: break-word;
        }
        .detalhes-pedido-obs.vazio {
            background-color: #f5f7fa;
            color: #999; font-style: italic;
        }
        .link-pedido {
            color: #0d47a1; font-weight: bold;
            cursor: pointer;
        }
        .link-pedido:hover { color: #1565c0; }

        /* --- Modal Reportar Problema (NOVO - Baseado em ModalAnilox) --- */
#modalReportarProblema { 
    max-width: 800px !important; 
    border-radius: 12px !important; 
}

#modalReportarProblema h4 {
    border-bottom: 2px solid;
    border-image: linear-gradient(to right, #37417c, #C8E154) 1;
    padding-bottom: 15px; margin-bottom: 20px !important;
    font-size: 1.5rem !important; display: flex;
    align-items: center;
}

#modalReportarProblema .modal-content {
    padding-bottom: 30px !important;
}

/* 1. Estilo base para os inputs do MODAL - CRÍTICO: Borda azul no CONTAINER! */
#modalReportarProblema .input-field {
    margin: 0 !important;
    padding: 0 !important;
    background-color: #f5f7fa !important;
    border-radius: 6px !important;
    border: 2px solid #37417c !important; /* A borda azul está aqui no container */
    border-bottom: 2px solid #37417c !important;
    min-height: 44px !important; /* AUMENTADO PARA EVITAR CORTE */
    height: auto !important;
    display: flex !important;
    align-items: center !important;
    box-sizing: border-box !important;
}
#modalReportarProblema .input-field:focus-within {
    box-shadow: 0 0 0 1px #37417c;
}

/* 2. Ajusta o select-wrapper interno (sem bordas internas) */
#modalReportarProblema .input-field .select-wrapper {
    padding: 0 0 0 12px !important;
    margin: 0 !important;
    width: 100%;
    min-height: 40px; 
    height: 100%;
    display: flex;
    align-items: center;
}

/* 3. Remove BORDAS do input.select-dropdown e input[type=text]*/
#modalReportarProblema .input-field input.select-dropdown,
#modalReportarProblema .input-field input[type=text],
#modalReportarProblema .input-field textarea.materialize-textarea {
    border-bottom: none !important; 
    box-shadow: none !important;    
    margin: 0 !important;
    height: 40px !important;
    line-height: 40px !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    color: #000 !important;
    background-color: transparent !important; 
    padding: 0 10px !important; 
    width: 100% !important; 
}
#modalReportarProblema .input-field textarea.materialize-textarea {
    height: auto !important;
    min-height: 100px !important;
    line-height: 1.5 !important;
    padding-top: 10px !important;
    padding-bottom: 10px !important;
}

/* 4. Posiciona a seta e remove caret do texto */
#modalReportarProblema .input-field .caret {
    display: block !important;
    fill: #37417c !important;
    right: 8px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
}
#modalReportarProblema .input-field .select-wrapper input.select-dropdown {
    padding-right: 25px !important; /* Mais espaço para a seta */
}

    #modalAnilox .modal-footer {
    position: sticky !important;
    bottom: 0 !important;
    max-width: 800px !important; 
    width: 100% !important;
    background-color: #ffffff;
    border-top: 1px solid #eee;
    border-radius: 0 0 12px 12px !important;
    z-index: 2000; /* Garante que fique acima de tudo */
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    margin-bottom: 0 !important; /* Garante que não haja margem externa */
}

    #modalAnilox .secao-titulo {
      text-transform: none !important;
    }
  
    #modalAnilox .modal-content {
        max-height: calc(100% - 70px);
        height: auto;
        overflow-y: auto;
        padding-bottom: 30px !important;
    }

    /* 1. Estilo base para os inputs do MODAL - CRÍTICO: Borda azul no CONTAINER! */
    #modalAnilox .input-field {
        margin: 0 !important;
        padding: 0 !important;
        background-color: #f5f7fa !important;
        border-radius: 6px !important;
        border: 2px solid #37417c !important; /* A borda azul está aqui no container */
        border-bottom: none !important;
        min-height: 38px !important;
        height: auto !important;
        display: flex !important;
        align-items: center !important;
        box-sizing: border-box !important;
    }
    #modalAnilox .input-field:focus-within {
        box-shadow: 0 0 0 1px #37417c;
    }

    /* 2. Ajusta o select-wrapper interno (sem bordas internas) */
    #modalAnilox .input-field .select-wrapper {
        padding: 0 0 0 12px !important;
        margin: 0 !important;
        width: 100%;
        height: 38px;
        display: flex;
        align-items: center;
    }

    /* 3. Remove BORDAS do input.select-dropdown dentro do input-field */
    #modalAnilox .input-field input.select-dropdown {
        border-bottom: none !important; /* Remove borda do Materialize */
        box-shadow: none !important;    /* Remove sombra do Materialize */
        margin: 0 !important;
        height: 38px !important;
        line-height: 38px !important;
        font-size: 0.95rem !important;
        font-weight: 500 !important;
        color: #000 !important;
        background-color: transparent !important; /* Evita fundo duplicado */
        padding: 0 10px 0 0 !important; /* Ajusta padding para o caret */
    }

    /* 4. Posiciona a seta (mantido) */
    #modalAnilox .input-field .caret {
        display: block !important;
        fill: #37417c !important;
        right: 8px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
    }

    /* --- Seção 1: Faca --- */
    #anilox_faca_item_wrapper {
        border: 2px solid #37417c;
        border-radius: 8px;
        padding: 15px 15px 5px 15px; /* Ajustado padding-bottom */
        margin-top: 20px;
        margin-bottom: 25px;
    }
    #anilox_faca_item_wrapper h5 {
        color: #37417c;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 15px !important;
        margin-top: 0;
    }
    /* Alinhamento do Modelo da Faca e Item da Faca */
    #anilox_faca_item_wrapper .row {
        margin-bottom: 10px !important; /* Margem inferior dentro da box da faca */
        align-items: flex-end; /* Alinha os itens na parte inferior */
    }
    #anilox_faca_item_wrapper .detalhes-pedido-item {
        /* Estilo para o MODELO DA FACA */
        margin-bottom: 0 !important;
    }
    #anilox_faca_item_wrapper .detalhes-pedido-item .input-field {
        /* Remove a borda azul e fundo para o campo de FACA MODELO, que é apenas um SPAN */
        border-left: none !important;
        background-color: transparent !important;
        box-shadow: none !important;
    }

    /* Estilo para o campo de SELECT Item da Faca */
    #anilox_faca_item_wrapper .input-field.item-faca-select {
        position: absolute !important;
        top: 238px !important;
        border: 2px solid #37417c !important; /* Aplica a borda azul ao input-field do select */
        background-color: #f5f7fa !important;
        box-shadow: none !important;
    }
    #anilox_faca_item_wrapper .input-field.item-faca-select label {
        position: absolute !important;
        transform: none !important;
        left: 5px !important;
        top: -20px !important;
        font-size: 0.75rem !important;
        color: #555 !important;
        font-weight: 600 !important;
        display: block;
        margin-bottom: 5px;
    }
    #anilox_faca_item_wrapper .input-field.item-faca-select .select-wrapper {
        padding: 0 0 0 12px !important;
    }
    #anilox_faca_item_wrapper .input-field.item-faca-select input.select-dropdown {
        background-color: transparent !important; /* Garante que o input interno seja transparente */
    }

    #anilox-estacoes-wrapper .input-field {
    margin: 0 !important;
    padding: 0 !important;
    background-color: #f5f7fa !important;
    border-radius: 6px !important;
    border: 2px solid #37417c !important; 
    border-bottom: 2px solid #37417c !important;
    min-height: 44px !important; /* AUMENTADO PARA EVITAR CORTE */
    height: auto !important;
    display: flex !important;
    align-items: center !important;
    box-sizing: border-box !important;
}
#anilox-estacoes-wrapper .input-field:focus-within {
    box-shadow: 0 0 0 1px #37417c;
}

/* Ajuste o select-wrapper interno para a nova altura */
#anilox-estacoes-wrapper .input-field .select-wrapper {
    padding: 0 0 0 12px !important;
    margin: 0 !important;
    width: 100%;
    min-height: 40px; 
    height: 100%;
    display: flex;
    align-items: center;
}
/* Ajuste a altura do input/select-dropdown interno */
#anilox-estacoes-wrapper .input-field input.select-dropdown,
#anilox-estacoes-wrapper input[type=text] {
    height: 40px !important;
    line-height: 40px !important;
}


    /* 6. Estilo para o campo de Pantone (Input de Texto) - SEM BORDAS DUPLICADAS */
    #anilox-estacoes-wrapper input[type=text] {
        border: none !important; /* Remove bordas do input real */
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 10px !important;
        height: 40px !important;
        box-sizing: border-box;
        font-size: 0.95rem !important;
        font-weight: 500 !important;
        color: #000 !important;
        background-color: transparent !important; /* O fundo é do input-field container */
        border-radius: 6px !important; /* Arredondamento é do container */
        border-left: none !important; /* ESSENCIAL: remove a borda azul do input real */
        width: 100% !important;
    }
    #anilox-estacoes-wrapper input[type=text]:focus {
        box-shadow: none !important; /* A sombra de foco vem do parent .input-field:focus-within */
    }

    /* 7. Alinhamento das linhas de cor/anilox */
    .anilox-cor-row {
        min-height: 45px !important;
        height: auto !important;
        margin-bottom: 15px !important;
        margin-top: 15px !important;
        margin-left: 0;
        margin-right: 0;
        display: flex; /* Usar flex para alinhar o label com os inputs */
        align-items: center;
        z-index: 0 !important;
    }
    
    .anilox-label {
        font-weight: 600;
        color: #37417c;
        font-size: 0.95rem;
        padding-right: 5px;
        text-align: right;
        box-sizing: border-box;
        line-height: 38px;
        flex-shrink: 0; /* Não encolher */
        width: 100%; /* Ocupa a largura total da sua col */
    }
    /* 9. Corrige o "estouro" da lista de opções (Manter) */
    body > .dropdown-content {
        max-height: 300px !important; 
        overflow-y: auto !important; 
    }
    </style>
</head>

<body>

    <div id="toast-custom-container" 
         style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000;">
    </div>

    <div id="divObjetos">
        
        <div class="header-container">
            <h4><i class="material-icons">analytics</i> Controle de Produção</h4>
            <img src="[meucodebase64]" alt="Logo Feira" class="header-logo">
        </div>

        <h4 class="secao-titulo">
            <i class="material-icons">inbox</i> Para Programar
        </h4>
        <p class="subtitulo-descricao">
            Pedidos de impressão que ainda não foram designados para uma máquina.
        </p>
        
        <div id="tabela-programar-container" class="tabela-container">
            <table id="tabela-programar" class="striped highlight responsive-table">
                <thead>
                    <tr>
                        <th class="col-pedido">Nº PEDIDO</th>
                        <th class="col-data">DATA ENTREGA</th>
                        <th class="col-cliente">CLIENTE</th>
                        <th class="col-descricao">DESCRIÇÃO</th>
                        <th class="col-status-atual">STATUS</th>
                        <th class="col-maquina">MÁQUINA</th>
                        <th class="col-obs">OBSERVAÇÃO - PCP</th>
                    </tr>
                </thead>
                <tbody id="tabela-programar-corpo"></tbody>
            </table>
            <p id="msg-sem-pedidos" class="mensagem-vazia" style="display: none;">
                Não há novos pedidos liberados para produção.
            </p>
        </div>

        <div class="divider"></div>

        <h4 class="secao-titulo">
            <i class="material-icons">view_column</i> Fila de Impressão (Flexo e Digital)
        </h4>
        
        <div id="quadros-maquinas-container">
            </div>
        <p id="msg-sem-maquinas" class="mensagem-vazia" style="display: none;">
            Nenhum pedido programado nas máquinas de impressão.
        </p>

        <div class="divider"></div>

        <h4 class="secao-titulo">
            <i class="material-icons">content_cut</i> Fila de Acabamento (Batida)
        </h4>
        <div id="quadro-batida-container" class="batida-quadro">
            <table id="tabela-batida" class="maquina-tabela highlight">
                <thead>
                    <tr>
                        <th class="col-pedido-batida">Nº PEDIDO</th>
                        <th class="col-data-batida">DATA ENTREGA</th>
                        <th class="col-cliente-batida">CLIENTE</th>
                        <th class="col-descricao-batida">DESCRIÇÃO</th>
                        <th class="col-faca-batida">FACA</th>
                        <th class="col-status-batida">STATUS</th>
                        <th class="col-acoes-mq">AÇÃO</th>
                    </tr>
                </thead>
                <tbody id="tabela-batida-corpo"></tbody>
            </table>
            <p id="msg-sem-batida" class="mensagem-vazia" style="display: none;">
                Nenhum pedido aguardando acabamento na Batida.
            </p>
        </div>
        
    </div> 
    
    <div id="footer-bar">
         <button class="btn waves-effect waves-light red darken-2" onclick="abrirModalReportarProblema()">Reportar Problema<i class="material-icons right">report_problem</i></button>
         <button id="btnSalvar" class="btn waves-effect btn-salvar" disabled>Salvar Alterações<i class="material-icons right">save</i></button>
    </div>

    <div id="motivo-atraso-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left red-text">error_outline</i>Pedido Atrasado!</h4>
            <p>Você está concluindo um pedido com a <strong>Data de Entrega Vencida</strong>. Por favor, informe o <strong>motivo do atraso</strong> para prosseguir.</p>
            <div class="input-field">
                <textarea id="motivoAtrasoInput" class="materialize-textarea"></textarea>
                <label for="motivoAtrasoInput">Motivo do Atraso (Obrigatório)</label>
            </div>
        </div>
        <div class="modal-footer">
            <button id="motivoAtrasoCancelar" class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
            <button id="motivoAtrasoConfirmar" class="waves-effect waves-green btn green" disabled>Confirmar Conclusão</button>
        </div>
    </div>

    <div id="modalConsumo" class="modal"> 
        <div class="modal-content">
            <h4><i class="material-icons left">straighten</i>Registrar Metragem Produzida</h4>
            <div id="consumo-grid-simples"> 
                <div class="detalhes-pedido-item">
                    <span class="detalhes-pedido-label">N° Pedido</span>
                    <span id="consumo_numPedido" class="detalhes-pedido-valor">---</span>
                </div>
                <div class="detalhes-pedido-item">
                    <span class="detalhes-pedido-label">Impressor</span>
                    <span id="consumo_impressor" class="detalhes-pedido-valor">---</span>
                </div>
                <div class="detalhes-pedido-item full-width"> 
                    <div class="input-field" id="consumo-input-wrapper">
                        <input id="consumo_metragem_total" type="number" step="0.01">
                        <label for="consumo_metragem_total" class="detalhes-pedido-label">Metragem Total Consumida (m)</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
            <button class="btn waves-effect green" id="btnConfirmarConsumo" onclick="registrarConsumo()">
            Confirmar Consumo
            <i class="material-icons right">check</i>
            </button>
        </div>
    </div>

    <div id="modalMotivoConsumo" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left red-text">trending_up</i> Justificar Metragem Excessiva</h4>
            <p>A metragem consumida (**<span id="motivo_metragem_consumida">---</span> m**) excede em mais de 10% a metragem programada para o Pedido **<span id="motivo_numPedido">---</span>**.</p>
            <p><strong>Por favor, descreva o motivo do consumo excessivo:</strong></p>
            <div class="input-field">
                <textarea id="motivoConsumoInput" class="materialize-textarea" placeholder="Ex: Problema no substrato, perda de registro..."></textarea>
                <label for="motivoConsumoInput">Motivo do Consumo Excessivo (Obrigatório)</labe>
            </div>
        </div>
        <div class="modal-footer">
            <button id="motivoConsumoCancelar" class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
            <button id="motivoConsumoConfirmar" class="waves-effect waves-green btn red" disabled>Confirmar Consumo Alto</button>
        </div>
    </div>

    <div id="modalReportarProblema" class="modal" style="max-width: 800px !important;"> <div class="modal-content"> <h4 id="problema-titulo"><i class="material-icons">report_problem</i> Reportar Problema de Produção</h4> <div class="gradient-line"></div>

    <div class="row" style="margin-top: 20px;">
        <div class="input-field col s6">
            <input id="problema_numPedido" type="text" class="validate">
            <label for="problema_numPedido">1. Informe o Nº do Pedido</label>
        </div>
        <div class="input-field col s6">
            <select id="problema_ferramenta">
                <option value="" disabled selected>Selecione o Insumo</option>
                <option value="Clichê">Clichê</option>
                <option value="Faca">Faca</option>
                <option value="Ambos">Ambos</option>
            </select>
            <label for="problema_ferramenta">2. Insumo com Problema</label>
        </div>
    </div>
    
    <div id="bloco_cliche" style="display: none; border-top: 1px solid #eee; padding-top: 15px;">
        <h5 style="color: #37417c; font-weight: 600; font-size: 1.2rem; margin-bottom: 20px; margin-top: 10px;">Problema no Clichê</h5>
        <div class="input-field col s12">
            <select multiple id="problema_id_lamina">
                <option value="" disabled>Buscando lâminas...</option>
            </select>
            <label>3a. Selecione as Lâminas Afetadas (ou deixe em branco para Jogo Inteiro)</label>
        </div>
        <div class="input-field col s12">
            <select id="problema_tipo_cliche">
                <option value="" disabled selected>Escolha o Tipo de Problema</option>
            </select>
            <label for="problema_tipo_cliche">3b. Tipo de Problema no Clichê</label>
        </div>
        <div class="input-field col s12">
            <textarea id="problema_descricao_cliche" class="materialize-textarea" data-length="200"></textarea>
            <label for="problema_descricao_cliche">3c. Descreva o Problema (Obrigatório)</label>
        </div>
    </div>

    <div id="bloco_faca" style="display: none; border-top: 1px solid #eee; padding-top: 15px;">
         <h5 style="color: #37417c; font-weight: 600; font-size: 1.2rem; margin-bottom: 20px; margin-top: 10px;">Problema na Faca</h5>
        <div id="faca_info_display" style="margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 0.9rem;">
            <strong>Modelo Faca:</strong> <span id="faca_modelo_display">---</span> | 
            <strong>Item:</strong> <span id="faca_id_unico_display">---</span>
        </div>
        <div class="input-field col s12">
            <select id="problema_tipo_faca">
                <option value="" disabled selected>Escolha o Tipo de Problema</option>
            </select>
            <label for="problema_tipo_faca">4a. Tipo de Problema na Faca</label>
        </div>
        <div class="input-field col s12">
            <textarea id="problema_descricao_faca" class="materialize-textarea" data-length="200"></textarea>
            <label for="problema_descricao_faca">4b. Descreva o Problema (Obrigatório)</label>
        </div>
    </div>

    <div id="problema_loading" style="text-align: center; padding: 20px; display: none;">
        <div class="preloader-wrapper active">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left"><div class="circle"></div></div>
            <div class="gap-patch"><div class="circle"></div></div>
            <div class="circle-clipper right"><div class="circle"></div></div>
          </div>
        </div>
        <p>Buscando dados do pedido...</p>
    </div>
    
</div>
<div class="modal-footer">
    <button class="modal-close waves-effect waves-red red-text btn-flat" id="btnCancelarReporte">Cancelar</button>
    <button class="btn waves-effect red darken-2" id="btnConfirmarReporteProblema" onclick="confirmarReporteProblema()" disabled>
        Confirmar Problema
        <i class="material-icons right">check</i>
    </button>
</div>
</div>

    <div id="detalhes-pedido-modal" class="modal">
        <div class="modal-content">
            <h4 id="detalhes-titulo">Detalhes do Pedido</h4>
            <div id="detalhes-loading" style="text-align: center; padding: 40px;">
                <div class="preloader-wrapper active">
                  <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                  </div>
                </div>
                <p>Buscando dados...</p>
            </div>
            <div id="detalhes-conteudo" style="display: none;">
                <div class="detalhes-pedido-grid-3-col">
                    </div>
                </div>
        </div>
        <div class="modal-footer">
            <button class="modal-close waves-effect waves-grey btn-flat">Fechar</button>
        </div>
    </div>

<div id="modalAnilox" class="modal" style="max-width: 800px !important;">
    <div class="modal-content">
        <h4><i class="material-icons left">settings</i>Iniciar Setup e Definir Anilox</h4>

        <div class="detalhes-pedido-grid-3-col">
            <div class="detalhes-pedido-item">
                <span class="detalhes-pedido-label">N° Pedido</span>
                <span id="anilox_numPedido" class="detalhes-pedido-valor">---</span>
            </div>
            <div class="detalhes-pedido-item">
                <span class="detalhes-pedido-label">Cód. Produto</span>
                <span id="anilox_codProduto" class="detalhes-pedido-valor">---</span>
            </div>
            <div class="detalhes-pedido-item">
                <span class="detalhes-pedido-label">Impressor</span>
                <span id="anilox_impressor" class="detalhes-pedido-valor">---</span>
            </div>
        </div>

        <div id="anilox_faca_item_wrapper">
            <h5>1. Seleção da Faca</h5>
            <div class="row"> <div class="col s12 m4 detalhes-pedido-item">
                    <span class="detalhes-pedido-label">Modelo da Faca</span>
                    <span id="anilox_faca_modelo" class="detalhes-pedido-valor" style="background-color: #f0f0f0;">---</span>
                </div>
                
                <div class="col s12 m8" style="display: flex; flex-direction: column; justify-content: flex-end;">
                    <div class="input-field item-faca-select"> <label for="anilox_faca_item">SELECIONE A FACA</label>
                        <select id="anilox_faca_item">
                            <option value="" disabled selected>Buscando facas...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="secao-titulo" style="font-size: 1.1rem !important; border-top: 1px solid #eee; padding-top: 20px; margin-bottom: 35px !important; margin-top: 25px !important; display: flex; justify-content: space-between; align-items: center;">
            2. Definição de Anilox/Lâminas
            <a id="anilox-unlock-btn" href="#!" class="btn-flat waves-effect" style="display:none; color: #D32F2F; font-size: 0.8rem; padding: 0 10px;">
                <i class="material-icons left" style="font-size: 1rem; margin-right: 4px;">lock_open</i>Alterar
            </a>
        </h5>

        <div id="anilox-estacoes-wrapper">
            <div id="anilox-loading" style="text-align: center; padding: 15px; margin-top: 10px;">
                <div class="preloader-wrapper active"></div> <p>Buscando Ficha Técnica...</p>
            </div>
        </div>
    </div>

    <div class="modal-footer" style="background-color: #ffffff; border-top: 1px solid #eee;">
        <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
        <button class="btn waves-effect green" id="btnConfirmarSetup" onclick="onSalvarAnilox()">
            Salvar e Iniciar Setup
            <i class="material-icons right">check</i>
        </button>
    </div>
</div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Carrega os dados iniciais injetados pelo backend
        var dadosServidor = <?!= JSON.stringify(dados) ?>;
    </script>
    
    <script>
    // ===============================================
    // CONTROLE DE PRODUÇÃO - JAVASCRIPT v4.6 (Roteiro Digital)
    // ===============================================

    // --- Variáveis Globais ---
    let todosPedidos = [];
    let listaMaquinas = [];
    let listaFornecedores = [];
    let listaImpressores = [];
    let listaAnilox = []; 
    let mudancas = {}; 
    let modalDetalhesInstance, consumoModalInstance, modalMotivoConsumoInstance, 
    modalAtrasoInstance, modalAniloxInstance; // <<<< REMOVIDO: modalReporteProblemaInstance da linha original
    let problemaModalInstance; // <<<< NOVO: Instância do modal de problema
    let dadosInsumosReporte = null; // <<<< NOVO: Variável para dados do reporte
    let problemaNumPedidoInput, problemaFerramentaSelect, problemaBtnConfirm;
    let quadrosContainer = null; // <-- ADICIONE ESTA LINHA OU VERIFIQUE SUA EXISTÊNCIA
    let batidaContainer = null; // <-- ADICIONE ESTA LINHA OU VERIFIQUE SUA EXISTÊNCIA
    let tabelaCorpo = null;
    let setupLinhaPlanilha = null;
    let setupCodProduto = null;
    let setupQtdCores = 0;
    const ORDEM_MAQUINAS = ["Superprint 250", "Etirama Fit", "Kromia I", "Kromia II", "Flexo Digital"]; // Adicionada Digital

    // Lista de Cores/Lâminas (Edite esta lista se precisar de mais opções)
    var listaCoresLaminas = [
    "CMYK - Ciano", "CMYK - Magenta", "CMYK - Amarelo", "CMYK - Preto",
    "Branco", "Pantone", "Ouro", "Prata","Reflex Blue", "Orange 021",
    "Verniz Brilho", "Verniz Fosco", "Reserva de Verniz",
    "Laminação Brilho", "Laminação Fosca",
    "Cold Ouro", "Cold Prata",
    "Neutra"
];

    // <<< CORREÇÃO V4.6 >>>
    // Opção padrão para todos os dropdowns do Materialize
    const materializeSelectOptions = {
      dropdownOptions: { container: document.body }
    };

    // ===============================================
    // INICIALIZAÇÃO
    // ===============================================
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa Modais
        modalAtrasoInstance = M.Modal.init(document.getElementById('motivo-atraso-modal'), { dismissible: false });
        consumoModalInstance = M.Modal.init(document.getElementById('modalConsumo'), { dismissible: true });
        modalDetalhesInstance = M.Modal.init(document.getElementById('detalhes-pedido-modal'), { dismissible: true });
        modalMotivoConsumoInstance = M.Modal.init(document.getElementById('modalMotivoConsumo'), { dismissible: false });
        modalAniloxInstance = M.Modal.init(document.getElementById('modalAnilox'), { dismissible: false }); 
        
        // <<< NOVO: Inicialização do modal de problema integrado >>>
        problemaModalInstance = M.Modal.init(document.getElementById('modalReportarProblema'), { dismissible: false });
        problemaNumPedidoInput = document.getElementById('problema_numPedido');
        problemaFerramentaSelect = document.getElementById('problema_ferramenta');
        problemaBtnConfirm = document.getElementById('btnConfirmarReporteProblema');

        // Listeners dos Modais
        document.getElementById('motivoAtrasoConfirmar').addEventListener('click', onConfirmarAtrasoClick);
        document.getElementById('motivoAtrasoInput').addEventListener('input', checkMotivoAtrasoInput);
        document.getElementById('motivoConsumoConfirmar').addEventListener('click', onConfirmarMetragemExcessiva);
        document.getElementById('motivoConsumoInput').addEventListener('input', checkMotivoConsumoInput);

        // <<< NOVOS LISTENERS PARA O MODAL DE PROBLEMA INTEGRADO >>>
        problemaNumPedidoInput.addEventListener('change', handlePedidoReporteChange);
        problemaFerramentaSelect.addEventListener('change', handleFerramentaReporteChange);
        document.getElementById('problema_descricao_cliche').addEventListener('input', checkReporteInputs);
        document.getElementById('problema_descricao_faca').addEventListener('input', checkReporteInputs);
        document.getElementById('problema_tipo_cliche').addEventListener('change', checkReporteInputs);
        document.getElementById('problema_tipo_faca').addEventListener('change', checkReporteInputs);
        // <<< FIM DOS NOVOS LISTENERS >>>
        
        // Carrega dados do servidor
        todosPedidos = dadosServidor.pedidos || [];
        listaMaquinas = dadosServidor.maquinas || [];
        listaFornecedores = dadosServidor.fornecedores || [];
        listaImpressores = dadosServidor.impressores || [];
        listaAnilox = dadosServidor.anilox || [];
        
        renderizarTelaCompleta();
        setupListeners();
    });

    // ===============================================
// FUNÇÃO HELPER: Executar com retry automático
// ===============================================
function executarComRetry(funcaoBackend, parametros, onSuccess, onError, tentativas = 3) {
    const executar = (tentativasRestantes) => {
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler((erro) => {
                console.warn(`Tentativa falhou. Restantes: ${tentativasRestantes - 1}`, erro);
                
                if (tentativasRestantes > 1) {
                    // Aguarda 1 segundo e tenta novamente
                    setTimeout(() => executar(tentativasRestantes - 1), 1000);
                } else {
                    onError(erro);
                }
            })
            [funcaoBackend](...parametros);
    };
    
    executar(tentativas);
}
    
    function setupListeners() {
        const tabelaCorpo = document.getElementById('tabela-programar-corpo');
        const quadrosContainer = document.getElementById('quadros-maquinas-container');
        const batidaContainer = document.getElementById('quadro-batida-container'); 
        
        tabelaCorpo.addEventListener('change', handleEvento);
        quadrosContainer.addEventListener('change', handleEvento);
        tabelaCorpo.addEventListener('input', handleEvento); 
        quadrosContainer.addEventListener('input', handleEvento);

        // Listener para botões de AÇÃO (Flexo e Digital)
        quadrosContainer.addEventListener('click', function(event) {
            const btn = event.target.closest('button');
            if (!btn) return;
            
            const acao = btn.dataset.action;
            const linha = btn.dataset.linha;
            const codProduto = btn.dataset.codProduto;
            const qtdCores = btn.dataset.qtdCores;
            const facaModelo = btn.dataset.facaModelo;

            if (acao === 'UP' || acao === 'DOWN') {
                reordenarPedidos(linha, acao);
            }
            // Roteiro Flexo
            else if (acao === 'INICIAR_SETUP_FLEXO') {
                abrirModalAnilox(linha, codProduto, qtdCores, facaModelo);
            }
            else if (acao === 'INICIAR_PRODUCAO_FLEXO') {
                iniciarProducao(btn, linha);
            }
            else if (acao === 'FINALIZAR_PRODUCAO_FLEXO') {
                finalizarProducao(btn, linha);
            }
            // Roteiro Digital
            else if (acao === 'INICIAR_SETUP_DIGITAL') {
                iniciarSetupDigital(btn, linha);
            }
            else if (acao === 'INICIAR_IMPRESSAO_DIGITAL') {
                iniciarImpressaoDigital(btn, linha);
            }
            else if (acao === 'INICIAR_CORTE_DIGITAL') {
                iniciarCorteDigital(btn, linha);
            }
            else if (acao === 'FINALIZAR_PRODUCAO_DIGITAL') {
                finalizarProducaoDigital(btn, linha);
            }
        });
        
        // Listener para botões de AÇÃO (Batida)
        batidaContainer.addEventListener('click', function(event) {
            const btn = event.target.closest('button');
            if (!btn) return;
            const acao = btn.dataset.action;
            const linha = btn.dataset.linha;
            if (acao === 'FINALIZAR_BATIDA') {
                finalizarBatida(btn, linha);
            }
        });
        
        document.getElementById('btnSalvar').addEventListener('click', onSalvarClick);
    }
    
    // ===============================================
    // FUNÇÕES DE TOAST (ADICIONADAS V4.4)
    // ===============================================
    function showSuccessToast(message) {
      M.toast({
        html: `<i class="material-icons left">check_circle</i> ${message}`,
        classes: 'green darken-1',
        displayLength: 3000,
        container: '#toast-custom-container'
      });
    }

    function showErrorToast(error) {
      const msg = (typeof error === 'object' && error.message) ? error.message : error;
      M.toast({
        html: `<i class="material-icons left">error</i> ${msg}`,
        classes: 'red darken-2',
        displayLength: 5000,
        container: '#toast-custom-container'
      });
    }

    
    // ===============================================
    // FUNÇÕES DE RENDERIZAÇÃO (Criação do HTML)
    // ===============================================
    function renderizarTelaCompleta() {
        const tabelaCorpo = document.getElementById('tabela-programar-corpo');
        const quadrosContainer = document.getElementById('quadros-maquinas-container');
        const batidaCorpo = document.getElementById('tabela-batida-corpo'); 
        
        const msgSemPedidos = document.getElementById('msg-sem-pedidos');
        const msgSemMaquinas = document.getElementById('msg-sem-maquinas');
        const msgSemBatida = document.getElementById('msg-sem-batida'); 

        tabelaCorpo.innerHTML = '';
        quadrosContainer.innerHTML = '';
        batidaCorpo.innerHTML = ''; 

        let pedidosNaTabela = [];
        let pedidosEmQuadros = {}; 
        let pedidosNaBatida = []; 

        todosPedidos.forEach(pedido => {
            if (pedido.status === 'Liberado para produção' && !pedido.maquina) { 
                pedidosNaTabela.push(pedido);
            } 
            else if (pedido.status === 'Aguardando Batida') { 
                pedidosNaBatida.push(pedido);
            }
            // <<< MUDANÇA (V4.5) >>>
            // Pedidos da Digital também vão para as filas de máquinas
            else if (pedido.maquina) { 
                if (!pedidosEmQuadros[pedido.maquina]) {
                    pedidosEmQuadros[pedido.maquina] = [];
                }
                pedidosEmQuadros[pedido.maquina].push(pedido);
            }
        });

        // 1. Renderiza Tabela Superior (Para Programar)
        if (pedidosNaTabela.length === 0) {
            msgSemPedidos.style.display = 'block';
        } else {
            msgSemPedidos.style.display = 'none';
            pedidosNaTabela.sort((a, b) => parseDate(a.dataEntrega) - parseDate(b.dataEntrega));
            pedidosNaTabela.forEach(pedido => {
                tabelaCorpo.appendChild(criarLinhaTabela(pedido));
            });
        }

        // 2. Renderiza Quadros de Máquina (Flexo e Digital)
        const maquinasComPedidos = Object.keys(pedidosEmQuadros);
        maquinasComPedidos.sort((a, b) => {
            const indexA = ORDEM_MAQUINAS.indexOf(a);
            const indexB = ORDEM_MAQUINAS.indexOf(b);
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA !== -1) return -1;
            if (indexB !== -1) return 1;
            return a.localeCompare(b);
        });
        if (maquinasComPedidos.length === 0) {
            msgSemMaquinas.style.display = 'block';
        } else {
            msgSemMaquinas.style.display = 'none';
            maquinasComPedidos.forEach(nomeMaquina => {
                const pedidosOrdenados = pedidosEmQuadros[nomeMaquina].sort((a, b) => (parseInt(a.fila) || 999) - (parseInt(b.fila) || 999));
                quadrosContainer.appendChild(criarQuadroMaquinaComTabela(nomeMaquina, pedidosOrdenados));
            });
        }
        
        // 3. Renderiza Tabela Inferior (Fila da Batida)
        if (pedidosNaBatida.length === 0) {
            msgSemBatida.style.display = 'block';
        } else {
            msgSemBatida.style.display = 'none';
            pedidosNaBatida.sort((a, b) => parseDate(a.dataEntrega) - parseDate(b.dataEntrega));
            pedidosNaBatida.forEach(pedido => {
                batidaCorpo.appendChild(renderizarLinhaBatida(pedido));
            });
        }

        // <<< CORREÇÃO V4.6 >>>
        M.FormSelect.init(document.querySelectorAll('select'), materializeSelectOptions);
        M.Tooltip.init(document.querySelectorAll('.tooltipped'));
    }

    function criarLinhaTabela(pedido) {
        const tr = document.createElement('tr');
        tr.dataset.linhaPlanilha = pedido.linhaPlanilha;
        
        const dataStatus = checkDataStatus(pedido.dataEntrega);
        let opcoesMaquina = `<option value="" selected>Selecionar...</option>`;
        listaMaquinas.forEach(maq => {
            opcoesMaquina += `<option value="${maq}">${maq}</option>`;
        });
        
        const obsPCP = pedido.obsPCP || ''; 

        tr.innerHTML = `
            <td class="col-pedido link-pedido" onclick="handleNumeroPedidoClick('${pedido.linhaPlanilha}')" title="Ver Detalhes">${pedido.numPedido}</td>
            <td class="col-data ${dataStatus.classe}">
                ${pedido.dataEntrega} ${dataStatus.icone}
            </td>
            <td class="col-cliente">${pedido.cliente}</td>
            <td class="col-descricao">${pedido.descricao}</td>
            <td class="col-status-atual ${getStatusColorClass(pedido.status)}">
                ${pedido.status}
            </td>
            <td class="col-maquina">
                <div class="input-field" data-tipo-change="maquina">
                    <select class="maquina-select">
                        ${opcoesMaquina}
                    </select>
                </div>
            </td>
            <td class="col-obs">
                <div class="input-field" data-tipo-change="obsPCP">
                    <input type="text" value="${obsPCP}">
                </div>
            </td>
        `;
        return tr;
    }

    function criarQuadroMaquinaComTabela(nomeMaquina, pedidos) {
        const divQuadro = document.createElement('div');
        divQuadro.className = 'maquina-quadro';
        divQuadro.innerHTML = `
            <h5 class="maquina-titulo">
                <i class="material-icons">precision_manufacturing</i>
                ${nomeMaquina}
            </h5>
            <div class="quadro-corpo"></div>
        `;
        
        const corpoQuadro = divQuadro.querySelector('.quadro-corpo');
        const tabela = document.createElement('table');
        tabela.className = 'maquina-tabela highlight';
        
        tabela.innerHTML = `
            <thead>
                <tr>
                    <th class="col-fila-mq">FILA</th>
                    <th class="col-pedido-mq">Nº PEDIDO</th>
                    <th class="col-data-mq">DATA DE ENTREGA</th>
                    <th class="col-cliente-mq">CLIENTE</th>
                    <th class="col-descricao-mq">DESCRIÇÃO</th>
                    <th class="col-maquina-mq">MÁQUINA</th>
                    <th class="col-qtd-mq">QTD.</th>
                    <th class="col-metragem-mq">METRAGEM</th>
                    <th class="col-impressor-mq">IMPRESSOR</th>
                    <th class="col-status-mq">STATUS</th>
                    <th class="col-acoes-mq">AÇÕES</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = tabela.querySelector('tbody');
        const totalPedidosNaMaquina = pedidos.length;

        pedidos.forEach((pedido, index) => {
            const tr = document.createElement('tr');
            tr.dataset.linhaPlanilha = pedido.linhaPlanilha;
            
            const isPrimeiro = index === 0;
            const isUltimo = index === totalPedidosNaMaquina - 1;
            const tdFilaContent = `
                <div class="fila-controles">
                    <button class="btn-fila" data-action="UP" data-linha="${pedido.linhaPlanilha}" ${isPrimeiro ? 'disabled' : ''}>▲</button>
                    <span class="fila-numero">${index + 1}</span>
                    <button class="btn-fila" data-action="DOWN" data-linha="${pedido.linhaPlanilha}" ${isUltimo ? 'disabled' : ''}>▼</button>
                </div>
            `;
            
            const dataStatus = checkDataStatus(pedido.dataEntrega);
            const qtdFormatada = formatarNumero(pedido.quantidade);
            const metragemFormatada = formatarNumero(pedido.metragem);
            
            tr.innerHTML = `
                <td class="col-fila-mq">${tdFilaContent}</td>
                <td class="col-pedido-mq link-pedido" onclick="handleNumeroPedidoClick('${pedido.linhaPlanilha}')" title="Ver Detalhes">${pedido.numPedido}</td>
                <td class="col-data-mq ${dataStatus.classe}">
                    ${pedido.dataEntrega} ${dataStatus.icone}
                </td>
                <td class="col-cliente-mq">${pedido.cliente}</td>
                <td class="col-descricao-mq">${pedido.descricao}</td>
                <td class="col-maquina-mq">
                    <div class="input-field" data-tipo-change="maquina">
                        <select>
                            <option value="" ${!pedido.maquina ? 'selected' : ''}>Desprogramar</option>
                            ${gerarOptions(listaMaquinas, pedido.maquina)}
                        </select>
                    </div>
                </td>
                <td class="col-qtd-mq">
                    <input type="text" value="${qtdFormatada}" readonly>
                </td>
                <td class="col-metragem-mq">
                    <input type="text" value="${metragemFormatada}" readonly>
                </td>
                <td class="col-impressor-mq">
                    <div class="input-field" data-tipo-change="impressor">
                        <select>
                            ${gerarOptions(listaImpressores, pedido.impressor, true)}
                        </select>
                    </div>
                </td>
                <td class="col-status-atual ${getStatusColorClass(pedido.status)}">
                    ${pedido.status}
                </td>
                <td class="col-acoes-mq">
                    ${gerarBotoesAcao(pedido)}
                </td>
            `;
            
            tbody.appendChild(tr);
        });

        corpoQuadro.appendChild(tabela);
        return divQuadro;
    }
    
    function renderizarLinhaBatida(pedido) {
        const tr = document.createElement('tr');
        tr.dataset.linhaPlanilha = pedido.linhaPlanilha;

        const dataStatus = checkDataStatus(pedido.dataEntrega);

        tr.innerHTML = `
            <td class="col-pedido-batida link-pedido" onclick="handleNumeroPedidoClick('${pedido.linhaPlanilha}')" title="Ver Detalhes">${pedido.numPedido}</td>
            <td class="col-data-batida ${dataStatus.classe}">
                ${pedido.dataEntrega} ${dataStatus.icone}
            </td>
            <td class="col-cliente-batida">${pedido.cliente}</td>
            <td class="col-descricao-batida">${pedido.descricao}</td>
            <td class="col-faca-batida">${pedido.faca}</td>
            <td class="col-status-atual ${getStatusColorClass(pedido.status)}">
                ${pedido.status}
            </td>
            <td class="col-acoes-mq">
                <button class="btn-floating waves-effect waves-light purple tooltipped" 
                        data-tooltip="Finalizar Acabamento (Enviar p/ CQ)" 
                        data-action="FINALIZAR_BATIDA" data-linha="${pedido.linhaPlanilha}">
                    <i class="material-icons">check</i>
                </button>
            </td>
        `;
        return tr;
    }

    function debugPedido(pedido) {
    console.log("=== ESTRUTURA DO PEDIDO ===");
    console.log("Propriedades disponíveis:", Object.keys(pedido));
    console.log("Pedido completo:", pedido);
    console.log("===========================");
}
    
// (SUBSTITUIR no FormProducao.html)
function gerarBotoesAcao(pedido) {
    debugPedido(pedido);
    const linha = pedido.linhaPlanilha;
    const codProd = pedido.codProduto;
    const qtdCores = pedido.qtdCores || 0; 
    const status = pedido.status;
    const maquina = pedido.maquina;
    const facaModelo = pedido.faca || ""; // <-- MUDANÇA: LÊ O NOME DA FACA (ex: "FX 278")
    let htmlBotoes = '';

    // ===================================
    // ROTEIRO C: FLEXO DIGITAL
    // ===================================
    if (maquina === "Flexo Digital") {
        // ... (O código do Roteiro Digital permanece o mesmo) ...
        
        switch (status) {
            case "Programado":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light blue tooltipped" 
                            data-tooltip="Iniciar Setup (Digital)" 
                            data-action="INICIAR_SETUP_DIGITAL" data-linha="${linha}">
                        <i class="material-icons">settings</i>
                    </button>`;
                break;
            case "Setup (Digital)":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light green tooltipped" 
                            data-tooltip="Iniciar Impressão" 
                            data-action="INICIAR_IMPRESSAO_DIGITAL" data-linha="${linha}">
                        <i class="material-icons">print</i>
                    </button>`;
                break;
            case "Imprimindo (Digital)":
                 htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light cyan tooltipped" 
                            data-tooltip="Iniciar Corte" 
                            data-action="INICIAR_CORTE_DIGITAL" data-linha="${linha}">
                        <i class="material-icons">content_cut</i>
                    </button>`;
                break;
            case "Cortando (Digital)":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light blue tooltipped" 
                            data-tooltip="Registrar Consumo" 
                            onclick="abrirModalConsumo('${pedido.numPedido}', '${pedido.impressor || ''}')">
                        <i class="material-icons">straighten</i>
                    </button>`;
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light purple tooltipped" 
                            data-tooltip="Finalizar Produção (Enviar p/ CQ)" 
                            data-action="FINALIZAR_PRODUCAO_DIGITAL" data-linha="${linha}">
                        <i class="material-icons">check</i>
                    </button>`;
                break;
            case "Aguardando Corte (Digital)":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light cyan tooltipped" 
                            data-tooltip="Iniciar Corte" 
                            data-action="INICIAR_CORTE_DIGITAL" data-linha="${linha}">
                        <i class="material-icons">content_cut</i>
                    </button>`;
                break;
        }
    } 
    // ===================================
    // ROTEIRO A/B: FLEXO CONVENCIONAL
    // ===================================
    else {
        switch (status) {
            case "Programado":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light blue tooltipped" 
                            data-tooltip="Iniciar Setup e Definir Anilox/Faca" 
                            data-action="INICIAR_SETUP_FLEXO" 
                            data-linha="${linha}" 
                            data-cod-produto="${codProd}" 
                            data-qtd-cores="${qtdCores}"
                            data-faca-modelo="${facaModelo}"> <i class="material-icons">settings</i>
                    </button>
                `;
                break;
            case "Setup":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light green tooltipped" 
                            data-tooltip="Iniciar Produção" 
                            data-action="INICIAR_PRODUCAO_FLEXO" data-linha="${linha}">
                        <i class="material-icons">play_arrow</i>
                    </button>
                `;
                break;
            case "Em produção":
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light blue tooltipped" 
                            data-tooltip="Registrar Consumo/Refugo" 
                            onclick="abrirModalConsumo('${pedido.numPedido}', '${pedido.impressor || ''}')">
                        <i class="material-icons">straighten</i>
                    </button>
                `;
                htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light purple tooltipped" 
                            data-tooltip="Finalizar Impressão (Enviar p/ CQ ou Batida)" 
                            data-action="FINALIZAR_PRODUCAO_FLEXO" data-linha="${linha}">
                        <i class="material-icons">check</i>
                    </button>
                `;
                break;
            case "Controlando":
                 htmlBotoes += `
                    <button class="btn-floating waves-effect waves-light blue tooltipped" 
                            data-tooltip="Registrar Consumo Adicional" 
                            onclick="abrirModalConsumo('${pedido.numPedido}', '${pedido.impressor || ''}')">
                        <i class="material-icons">straighten</i>
                    </button>
                    <button class="btn-floating waves-effect waves-light purple tooltipped" 
                            data-tooltip="Finalizar Produção" 
                            data-action="FINALIZAR_PRODUCAO_FLEXO" data-linha="${linha}">
                        <i class="material-icons">check</i>
                    </button>
                `;
                break;
            case "Produção Finalizada":
            case "Aguardando Batida":
                htmlBotoes += `<span class="grey-text tooltipped" data-tooltip="Aguardando Próximo Setor"><i class="material-icons">hourglass_bottom</i></span>`;
                break;
        }
    }
    
    return htmlBotoes;
}

// Listener para botões de AÇÃO (Flexo e Digital)
quadrosContainer.addEventListener('click', function(event) {
    const btn = event.target.closest('button');
    if (!btn) return;
    
    const acao = btn.dataset.action;
    const linha = btn.dataset.linha;
    
    // ===== DEBUG COMPLETO =====
    console.log("🔵 =========================");
    console.log("🔵 CLICK DETECTADO");
    console.log("🔵 Ação:", acao);
    console.log("🔵 Linha do botão:", linha);
    console.log("🔵 Total de pedidos no array:", todosPedidos.length);
    console.log("🔵 Primeiro pedido do array:", todosPedidos[0]);
    console.log("🔵 =========================");
    
    // Busca o pedido
    const pedido = todosPedidos.find(p => {
        console.log(`   Comparando: ${p.linhaPlanilha} == ${linha} ?`, p.linhaPlanilha == linha);
        return p.linhaPlanilha == linha;
    });
    
    if (!pedido) {
        console.error("❌ PEDIDO NÃO ENCONTRADO!");
        console.error("❌ Linha procurada:", linha);
        console.error("❌ Linhas disponíveis:", todosPedidos.map(p => p.linhaPlanilha));
        showErrorToast("Erro: Pedido não encontrado no cache!");
        return;
    }
    
    console.log("✅ PEDIDO ENCONTRADO:", pedido);
    console.log("✅ codProduto:", pedido.codProduto);
    console.log("✅ tipoPedido:", pedido.tipoPedido);
    console.log("✅ qtdCores:", pedido.qtdCores);
    console.log("✅ faca:", pedido.faca);
    
    const codProduto = pedido.codProduto;
    const qtdCores = pedido.qtdCores;
    const facaModelo = pedido.faca;

    if (acao === 'UP' || acao === 'DOWN') {
        reordenarPedidos(linha, acao);
    }
    else if (acao === 'INICIAR_SETUP_FLEXO') {
        console.log("🚀 Chamando abrirModalAnilox com:");
        console.log("   linha:", linha);
        console.log("   codProduto:", codProduto);
        console.log("   qtdCores:", qtdCores);
        console.log("   facaModelo:", facaModelo);
        abrirModalAnilox(linha, codProduto, qtdCores, facaModelo);
    }
    else if (acao === 'INICIAR_PRODUCAO_FLEXO') {
        iniciarProducao(btn, linha);
    }
    else if (acao === 'FINALIZAR_PRODUCAO_FLEXO') {
        finalizarProducao(btn, linha);
    }
    else if (acao === 'INICIAR_SETUP_DIGITAL') {
        iniciarSetupDigital(btn, linha);
    }
    else if (acao === 'INICIAR_IMPRESSAO_DIGITAL') {
        iniciarImpressaoDigital(btn, linha);
    }
    else if (acao === 'INICIAR_CORTE_DIGITAL') {
        iniciarCorteDigital(btn, linha);
    }
    else if (acao === 'FINALIZAR_PRODUCAO_DIGITAL') {
        finalizarProducaoDigital(btn, linha);
    }
});

function preencherDropdownFacas(itens) {
  const select = document.getElementById('anilox_faca_item');
  const btnConfirm = document.getElementById('btnConfirmarSetup');
  
  if (!itens || itens.length === 0) {
    select.innerHTML = '<option value="" disabled selected>NENHUM ITEM "Disponível" encontrado!</option>';
    showErrorToast("Atenção: Não há nenhuma faca deste modelo disponível no inventário.");
    btnConfirm.disabled = true; // Bloqueia o início do setup
  } else {
    let options = '<option value="" disabled selected>Selecione o item...</option>';
    itens.forEach(item => {
      options += `<option value="${item}">${item}</option>`;
    });
    select.innerHTML = options;
    btnConfirm.disabled = false; // Libera o botão
  }
  
  // Re-inicializa o select do Materialize
  M.FormSelect.init(select, materializeSelectOptions);
}
    
    // ===============================================
    // FUNÇÕES DE EVENTOS (HANDLERS)
    // ===============================================
    
    function handleEvento(event) {
        const elemento = event.target; 
        const container = elemento.closest('.input-field[data-tipo-change]');
        if (!container) return; 
        const tipoChange = container.dataset.tipoChange;
        const tr = container.closest('tr[data-linha-planilha]');
        if (!tr) { return; }
        const linhaPlanilha = tr.dataset.linhaPlanilha;
        
        let valor;
        const selectReal = container.querySelector('select');
        if (selectReal) { valor = selectReal.value; } 
        else { valor = elemento.value; }

        const pedido = todosPedidos.find(p => p.linhaPlanilha == linhaPlanilha);
        if (!pedido) return;

        // LÓGICA DE SALVAMENTO INSTANTÂNEO DA MÁQUINA
        if (tipoChange === 'maquina') {
            pedido.maquina = valor;
            const novoStatus = (valor) ? 'Programado' : 'Liberado para produção';
            pedido.status = novoStatus;
            
            showSuccessToast("Programando máquina...");
            renderizarTelaCompleta(); 
            
            google.script.run
                .withSuccessHandler(function(resposta) {
                    showSuccessToast("Máquina salva!");
                    pedido.status = resposta.novoStatus; 
                    pedido.fila = resposta.novaFila;
                    renderizarTelaCompleta(); 
                })
                .withFailureHandler(function(err) {
                    showErrorToast(err.message);
                    pedido.maquina = ""; 
                    pedido.status = "Liberado para produção"; 
                    renderizarTelaCompleta(); 
                })
                .salvarProgramacaoMaquina(linhaPlanilha, valor);
            return; 
        }
        
        // LÓGICA DE MUDANÇAS MANUAIS (IMPRESSOR, OBS)
        pedido[tipoChange] = valor;
        if (!mudancas[linhaPlanilha]) mudancas[linhaPlanilha] = {};
        mudancas[linhaPlanilha][tipoChange] = valor;
        document.getElementById('btnSalvar').disabled = false;
    }
    
    function reordenarPedidos(linhaPlanilha, direcao) {
        const pedidoAtual = todosPedidos.find(p => p.linhaPlanilha == linhaPlanilha);
        if (!pedidoAtual) return;
        const nomeMaquina = pedidoAtual.maquina;

        const pedidosNaMaquina = todosPedidos
            .filter(p => p.maquina === nomeMaquina)
            .sort((a, b) => (parseInt(a.fila) || 999) - (parseInt(b.fila) || 999));
        
        const indiceAtual = pedidosNaMaquina.findIndex(p => p.linhaPlanilha == linhaPlanilha);
        if (indiceAtual === -1) return;

        const indiceDestino = (direcao === 'UP') ? indiceAtual - 1 : indiceAtual + 1;
        if (indiceDestino < 0 || indiceDestino >= pedidosNaMaquina.length) return;

        const pedidoDestino = pedidosNaMaquina[indiceDestino];

        pedidosNaMaquina.forEach((p, index) => {
            let novaFila = index + 1;
            if(p.linhaPlanilha === pedidoAtual.linhaPlanilha) {
              novaFila = indiceDestino + 1;
            } else if (p.linhaPlanilha === pedidoDestino.linhaPlanilha) {
              novaFila = indiceAtual + 1;
            }

            if (String(p.fila) !== String(novaFila)) {
              p.fila = novaFila.toString();
              if (!mudancas[p.linhaPlanilha]) mudancas[p.linhaPlanilha] = {};
              mudancas[p.linhaPlanilha].fila = p.fila;
            }
        });

        document.getElementById('btnSalvar').disabled = false;
        renderizarTelaCompleta(); 
    }

// [FormProducao.html - Função abrirModalAnilox (~ Linha 1148)]

function abrirModalAnilox(linha, codProduto, qtdCores, facaModelo) { 
  // O tipoPedido precisa ser extraído do cache local
  const pedido = todosPedidos.find(p => p.linhaPlanilha == linha);

  if (!pedido) {
    showErrorToast("Erro: Pedido não encontrado no cache local!");
    return;
  }
  
  // Variáveis de Setup (Globals)
  setupLinhaPlanilha = linha;
  setupCodProduto = codProduto;
  setupQtdCores = parseInt(qtdCores, 10) || 0;

  const tipoPedido = pedido.tipoPedido || "Primeira Fabricação"; // <-- Usa o tipoPedido do cache
  const impressor = pedido.impressor || "";

  if (!impressor) {
      showErrorToast("Erro: Selecione um Impressor na tabela antes de Iniciar o Setup.");
      return;
  }

  // Preenche dados estáticos no modal
  document.getElementById('anilox_numPedido').textContent = pedido.numPedido;
  document.getElementById('anilox_codProduto').textContent = codProduto;
  document.getElementById('anilox_impressor').textContent = impressor;
  document.getElementById('anilox_faca_modelo').textContent = facaModelo || "N/A";
  
  // Reseta estado do modal
  document.getElementById('anilox-unlock-btn').style.display = 'none';

  // --- FACA: Busca Itens de Faca disponíveis ---
  const selectFaca = document.getElementById('anilox_faca_item');
  selectFaca.innerHTML = '<option value="" disabled selected>Buscando facas...</option>';
  M.FormSelect.init(selectFaca, materializeSelectOptions); 

  executarComRetry(
      'getItensDeFacaDisponiveis',
      [facaModelo], // <-- Parâmetro facaModelo passado
      preencherDropdownFacas,
      (erro) => {
          showErrorToast("Erro ao buscar facas: " + erro.message);
          selectFaca.innerHTML = '<option value="" disabled selected>Erro ao carregar facas</option>';
          M.FormSelect.init(selectFaca, materializeSelectOptions);
      }
  );

  // --- FICHA TÉCNICA: Loading ---
  document.getElementById('anilox-estacoes-wrapper').innerHTML = `
      <div id="anilox-loading" style="text-align: center; padding: 20px;">
          <div class="preloader-wrapper active">...</div> <p>Buscando Ficha Técnica do Produto...</p>
      </div>`;

  modalAniloxInstance.open();

  // --- FICHA TÉCNICA: Backend Call ---
  executarComRetry(
      'getFichaTecnicaParaSetup',
      [codProduto, tipoPedido],
      preencherModalAniloxCallback, // Novo callback simples
      onPreencherAniloxErro,
      3
  );
}

// NOVO CALLBACK (Para evitar o erro que vimos na primeira tentativa)
function preencherModalAniloxCallback(data) {
    // Chama a função principal de preenchimento, que você já tem no arquivo.
    preencherModalAnilox(data);
}


// NOVO HELPER: Mude o nome da função que você usava para gerar as opções de cor
// ELA DEVE RECEBER listaCoresLaminas para ser globalmente segura.
function gerarOptionsCores(valorSelecionado) {
    let html = '<option value="" selected>Selecione a Cor/Lâmina</option>';
    // Usando a variável global que definimos no passo A
    listaCoresLaminas.forEach(item => { 
        const selected = (item === valorSelecionado) ? 'selected' : '';
        html += `<option value="${item}" ${selected}>${item}</option>`;
    });
    return html;
}

function preencherModalAnilox(data) {
    const wrapper = document.getElementById('anilox-estacoes-wrapper');
    const btnConfirm = document.getElementById('btnConfirmarSetup');
    const btnUnlock = document.getElementById('anilox-unlock-btn');

    // Pré-requisito: Verifica se a mudança no Código.gs foi feita
    if (data.tipoPedido === undefined) {
          wrapper.innerHTML = `<p class="mensagem-vazia" style="color: red; font-weight: bold;">
             ERRO: Parece que as alterações no Código.gs (backend) não foram aplicadas.<br>
             A função 'getFichaTecnicaParaSetup' não está retornando 'tipoPedido'.
           </p>`;
          console.error("Backend 'getFichaTecnicaParaSetup' está desatualizado.", data);
          return;
    }
    
    let dadosSalvos = [];
    try {
        dadosSalvos = JSON.parse(data.fichaTecnicaCores || "[]");
    } catch(e) { console.error("Erro ao parsear ficha tecnica: ", e); }

    const tipoPedido = data.tipoPedido || "Primeira Fabricação";
    const isRepeticao = (tipoPedido === 'Repetição');

    // Mostra o botão de destravar se for Repetição
    if (isRepeticao) {
        btnUnlock.style.display = 'block';
        btnConfirm.disabled = false; // Pode salvar mesmo se for repetição (para o caso de só mudar o item da faca)
    } else {
        btnUnlock.style.display = 'none';
        btnConfirm.disabled = false;
    }
    
    // <<< MODIFICAÇÃO 1: Limite de estações (8) e Lógica de Mensagem >>>
    const MAX_ESTACOES_A_MOSTRAR = 8;
    const numEstacoesComDados = setupQtdCores - 1; 

    if (isNaN(setupQtdCores) || setupQtdCores <= 1) {
        wrapper.innerHTML = `<p class="mensagem-vazia">Este produto tem ${setupQtdCores} cor(es). Nenhum Anilox/Lâmina é necessário.</p>`;
        return;
    }

    // Certifique-se de que a função gerarOptions está definida globalmente
    const optionsAnilox = gerarOptions(listaAnilox, null, "Selecione (Opcional)");
    let html = '';

    for (let i = 0; i < MAX_ESTACOES_A_MOSTRAR; i++) { // Loop fixo até 8
        const estacaoNum = i + 1;
        
        // Pega dados existentes se a estação for uma das que tem cor definida no produto
        const dados = (estacaoNum <= numEstacoesComDados) ? (dadosSalvos[i] || {}) : {};
        
        const corSalva = dados.cor || "";
        const pantoneSalvo = dados.pantone || "";
        const aniloxSalvo = dados.anilox || "";
        const isPantone = (corSalva.toLowerCase() === 'pantone');
        
        // Desabilita se for Repetição E for uma estação que já tem dados salvos
        const disabledState = (isRepeticao && estacaoNum <= numEstacoesComDados) ? 'disabled' : '';
        
        // Gera opções de Cor/Lâmina
        const optionsCores = gerarOptionsCores(corSalva);
        
        // *** MODIFICAÇÃO 2: Rótulo "Estação X" ***
        html += `
          <div class="row anilox-cor-row" data-estacao="${estacaoNum}">
            
            <div class="col s2"> <span class="anilox-label">Estação ${estacaoNum}:</span>
            </div>
            
            <div class="col s3"> <div class="input-field"> 
                <select id="anilox_cor_${estacaoNum}" class="anilox-cor-select" ${disabledState}>
                  ${optionsCores}
                </select>
              </div>
            </div>
            
            <div class="col s3"> 
              <div class="input-field"> 
                <input type="text" id="anilox_pantone_${estacaoNum}"
                       value="${pantoneSalvo}"
                       placeholder="Pantone"
                       style="display: ${isPantone ? 'block' : 'none'};"
                       ${disabledState}>
              </div>
            </div>
            
            <div class="col s4"> 
              <div class="input-field"> 
                <select id="anilox_setup_${estacaoNum}" ${disabledState}>
                  ${optionsAnilox}
                </select>
              </div>
            </div>
          </div>
        `;
    }
    
    wrapper.innerHTML = html;

    // Preenche os valores dos Anilox (Selects)
    for (let i = 0; i < MAX_ESTACOES_A_MOSTRAR; i++) { // Loop fixo até 8
        const estacaoNum = i + 1;
        // Usa a mesma lógica para ler o valor de anilox (se existir)
        const dados = (estacaoNum <= numEstacoesComDados) ? (dadosSalvos[i] || {}) : {}; 
        if (dados.anilox) {
            document.getElementById(`anilox_setup_${estacaoNum}`).value = dados.anilox;
        }
    }
    // <<< FIM DAS MODIFICAÇÕES 1 e 2 >>>
    
    // Inicializa todos os selects
    // Note que 'materializeSelectOptions' deve ser definida globalmente no seu script.
    M.FormSelect.init(wrapper.querySelectorAll('select'), materializeSelectOptions);

    // --- Adiciona Listeners ---

    // 1. Listener para mostrar/esconder Pantone
    wrapper.querySelectorAll('.anilox-cor-row').forEach(row => {
        const select = row.querySelector('.anilox-cor-select');
        select.addEventListener('change', function(e) {
            const estacao = row.dataset.estacao;
            const pantoneInput = document.getElementById(`anilox_pantone_${estacao}`);
            if (e.target.value.toLowerCase() === 'pantone') {
                pantoneInput.style.display = 'block';
            } else {
                pantoneInput.style.display = 'none';
                pantoneInput.value = ''; // Limpa se não for pantone
            }
        });
        
        // Inicializa estado do pantone para itens pré-preenchidos
        const estacao = row.dataset.estacao;
        const pantoneInput = document.getElementById(`anilox_pantone_${estacao}`);
        if (select.value.toLowerCase() === 'pantone') {
            pantoneInput.style.display = 'block';
        } else {
            pantoneInput.style.display = 'none';
        }
    });

    // 2. Listener para o botão de destravar
    btnUnlock.onclick = function() {      
        // Habilita todos os campos
        wrapper.querySelectorAll('select, input').forEach(el => {
            el.disabled = false;
        });
        
        // Re-inicializa os selects para refletir a mudança de 'disabled'
        M.FormSelect.init(wrapper.querySelectorAll('select'), materializeSelectOptions);
        
        // Esconde o próprio botão
        btnUnlock.style.display = 'none';
    };
}

// [FORMPRODUCAO.HTML - JAVASCRIPT]
function onSalvarAnilox() {
  const btn = document.getElementById('btnConfirmarSetup');
  btn.disabled = true;
  showSuccessToast("Salvando Anilox e iniciando setup...");

  const impressor = document.getElementById('anilox_impressor').textContent;
  // const quantidade = setupQtdCores - 1; // LINHA REMOVIDA

  // 1. Pega o ID da Faca (Validação obrigatória)
  const idUnicoFaca = document.getElementById('anilox_faca_item').value;
  if (!idUnicoFaca || idUnicoFaca.trim() === "") {
      showErrorToast("Erro: Você precisa selecionar o Item da Faca que será utilizado.");
      btn.disabled = false;
      return;
  }

  // 3. Monta o JSON da Ficha Técnica
  let fichaTecnicaAtualizada = [];
  // const wrapper = document.getElementById('anilox-estacoes-wrapper'); // LINHA REMOVIDA

  // <<< MODIFICAÇÃO 3: Loop fixo até 8 e limpeza de dados vazios >>>
  const MAX_ESTACOES_A_SALVAR = 8; 

  for (let i = 0; i < MAX_ESTACOES_A_SALVAR; i++) { // Loop fixo até 8 estações
      const estacaoNum = i + 1;

      const corSelect = document.getElementById(`anilox_cor_${estacaoNum}`);
      const pantoneInput = document.getElementById(`anilox_pantone_${estacaoNum}`);
      const aniloxSelect = document.getElementById(`anilox_setup_${estacaoNum}`);

      const cor = corSelect ? corSelect.value : "";
      // Salva Pantone somente se a cor for "Pantone"
      const pantone = (pantoneInput && cor.toLowerCase() === 'pantone') ? pantoneInput.value : "";
      const anilox = aniloxSelect ? aniloxSelect.value : "";

      // Adiciona a estação (preenchida ou vazia)
      fichaTecnicaAtualizada.push({
          estacao: estacaoNum,
          cor: cor || "",
          pantone: pantone || "",
          anilox: anilox || ""
      });
  }

  // Limpa: remove estações vazias (cor, pantone e anilox vazios) do final do array
  while (fichaTecnicaAtualizada.length > 0) {
      const last = fichaTecnicaAtualizada[fichaTecnicaAtualizada.length - 1];
      if (!last.cor && !last.pantone && !last.anilox) {
          fichaTecnicaAtualizada.pop();
      } else {
          break; // Para no primeiro item preenchido
      }
  }
  // <<< FIM DA MODIFICAÇÃO 3 >>>

  const jsonParaSalvar = JSON.stringify(fichaTecnicaAtualizada);

  // 4. Envia para o Backend
  google.script.run
      .withSuccessHandler(onAcaoWorkflowSucesso) 
      .withFailureHandler((err) => {
          onSalvarErro(err); 
          btn.disabled = false;
      })
      .iniciarSetupFlexo(
          setupLinhaPlanilha, 
          jsonParaSalvar, 
          setupCodProduto, 
          impressor,
          idUnicoFaca,
      );
}

    function iniciarProducao(botao, linhaPlanilha) {
        botao.disabled = true;
        const icone = botao.querySelector('i');
        icone.innerText = 'hourglass_top';
        showSuccessToast("Iniciando produção..."); 
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .iniciarProducaoPedido(linhaPlanilha); // Função Flexo existente
    }

    function finalizarProducao(botao, linhaPlanilha) {
        const pedido = todosPedidos.find(p => p.linhaPlanilha == linhaPlanilha);
        if (!pedido) {
            showErrorToast("Erro: Pedido não encontrado no cache.");
            return;
        }
        const dataStatus = checkDataStatus(pedido.dataEntrega);
        if (dataStatus.classe === 'data-atrasada') {
            abrirModalAtraso(linhaPlanilha, "FLEXO"); // Passa o tipo
            return;
        }
        executarFinalizacao(linhaPlanilha, ''); 
    }

    function executarFinalizacao(linhaPlanilha, motivoAtraso) {
        const botao = document.querySelector(`tr[data-linha-planilha="${linhaPlanilha}"] button[data-action="FINALIZAR_PRODUCAO_FLEXO"]`);
        if (botao) {
            botao.disabled = true;
            botao.querySelector('i').innerText = 'hourglass_top';
            showSuccessToast("Finalizando produção flexo...");
        }
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .finalizarProducaoPedido(linhaPlanilha, motivoAtraso); // Função Flexo existente
    }
    
    // --- ROTEIRO DA BATIDA ---
    function finalizarBatida(botao, linhaPlanilha) {
        botao.disabled = true;
        const icone = botao.querySelector('i');
        icone.innerText = 'hourglass_top';
        showSuccessToast("Finalizando acabamento..."); 
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .finalizarCorteBatida(linhaPlanilha);
    }

    // --- ROTEIRO FLEXO DIGITAL (NOVO V4.5) ---
    function iniciarSetupDigital(botao, linhaPlanilha) {
        const tr = botao.closest('tr');
        const selectImpressor = tr.querySelector('.input-field[data-tipo-change="impressor"] select');
        const impressor = (selectImpressor && selectImpressor.value) ? selectImpressor.value : "";
        
        if (!impressor) {
            showErrorToast("Erro: Selecione um Impressor na tabela antes de Iniciar o Setup.");
            return;
        }
        
        botao.disabled = true;
        botao.querySelector('i').innerText = 'hourglass_top';
        showSuccessToast("Iniciando Setup Digital...");
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .iniciarSetupDigital(linhaPlanilha, impressor);
    }
    
    function iniciarImpressaoDigital(botao, linhaPlanilha) {
        botao.disabled = true;
        botao.querySelector('i').innerText = 'hourglass_top';
        showSuccessToast("Iniciando Impressão Digital...");
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .iniciarImpressaoDigital(linhaPlanilha);
    }
    
    function iniciarCorteDigital(botao, linhaPlanilha) {
        botao.disabled = true;
        botao.querySelector('i').innerText = 'hourglass_top';
        showSuccessToast("Iniciando Corte Digital...");
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .iniciarCorteDigital(linhaPlanilha);
    }

    function finalizarProducaoDigital(botao, linhaPlanilha) {
         const pedido = todosPedidos.find(p => p.linhaPlanilha == linhaPlanilha);
        if (!pedido) {
            showErrorToast("Erro: Pedido não encontrado no cache.");
            return;
        }
        const dataStatus = checkDataStatus(pedido.dataEntrega);
        if (dataStatus.classe === 'data-atrasada') {
            abrirModalAtraso(linhaPlanilha, "DIGITAL"); // Passa o tipo
            return;
        }
        executarFinalizacaoDigital(linhaPlanilha, '');
    }
    
    function executarFinalizacaoDigital(linhaPlanilha, motivoAtraso) {
        const botao = document.querySelector(`tr[data-linha-planilha="${linhaPlanilha}"] button[data-action="FINALIZAR_PRODUCAO_DIGITAL"]`);
        if (botao) {
            botao.disabled = true;
            botao.querySelector('i').innerText = 'hourglass_top';
            showSuccessToast("Finalizando produção digital...");
        }
        
        google.script.run
            .withSuccessHandler(onAcaoWorkflowSucesso)
            .withFailureHandler(onSalvarErro)
            .finalizarProducaoDigital(linhaPlanilha, motivoAtraso);
    }

    // Sucesso genérico para Setup, Iniciar, Finalizar
    function onAcaoWorkflowSucesso(msg) {
        showSuccessToast(msg);
        mudancas = {};
        document.getElementById('btnSalvar').disabled = true;
        if (modalAniloxInstance) modalAniloxInstance.close();
        refreshPedidos();
    }
    
    // ===============================================
    // FUNÇÕES DE SALVAR / REFRESH
    // ===============================================
    function onSalvarClick() {
        const btn = document.getElementById('btnSalvar');
        btn.disabled = true;
        showSuccessToast("Verificando alterações...");

        const pedidosComMudancas = [];
        Object.keys(mudancas).forEach(linhaPlanilha => {
            const pedido = todosPedidos.find(p => p.linhaPlanilha == linhaPlanilha);
            if (pedido) {
                pedidosComMudancas.push(pedido); 
            }
        });

        if (pedidosComMudancas.length === 0) {
            showErrorToast("Nenhuma mudança detectada.");
            btn.disabled = true;
            return;
        }
        salvarPedidos(pedidosComMudancas);
    }
    
    function salvarPedidos(pedidos) {
        showSuccessToast("Salvando dados..."); 
        google.script.run
            .withSuccessHandler(onSalvarSucesso)
            .withFailureHandler(onSalvarErro)
            .salvarMudancasProducao(pedidos);
    }
    
    function onSalvarSucesso(msg) {
        showSuccessToast(msg);
        mudancas = {};
        document.getElementById('btnSalvar').disabled = true;
        refreshPedidos();
    }


function onSalvarErro(err) {
    showErrorToast(err.message || err);
    
    // Re-renderiza a tela para destravar quaisquer botões
    // que ficaram em modo "loading" (hourglass_top)
    renderizarTelaCompleta(); 
    
    // Re-habilita botões de salvar/confirmar
    document.getElementById('btnSalvar').disabled = false;
    document.getElementById('btnConfirmarSetup').disabled = false; 
    document.getElementById('btnConfirmarConsumo').disabled = false;
    restaurarBotaoReporte(); // Função que você já possui
}

function onPreencherAniloxErro(err) {
    const wrapper = document.getElementById('anilox-estacoes-wrapper');
    const mensagemErro = err.message || err.toString();
    
    wrapper.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <i class="material-icons" style="font-size: 48px; color: #f44336;">error</i>
            <h5 style="color: #f44336;">Erro ao Buscar Ficha Técnica</h5>
            <div style="background: #ffebee; padding: 15px; border-radius: 4px; margin: 20px 0; text-align: left;">
                <strong>Detalhes:</strong><br>
                <code style="font-size: 0.9em; color: #c62828;">${mensagemErro}</code>
            </div>
            <p><strong>Possíveis causas:</strong></p>
            <ul style="text-align: left; max-width: 400px; margin: 15px auto;">
                <li>Produto <strong>${setupCodProduto}</strong> não existe na aba "Produtos"</li>
                <li>Coluna "FichaTecnicaCores" não encontrada</li>
                <li>Problemas de conexão ou timeout</li>
                <li>Sessão expirada (recarregue a página)</li>
            </ul>
            <div style="margin-top: 20px;">
                <button class="btn red" onclick="modalAniloxInstance.close()">
                    <i class="material-icons left">close</i>Fechar
                </button>
                <button class="btn orange" onclick="location.reload()">
                    <i class="material-icons left">refresh</i>Recarregar Página
                </button>
            </div>
        </div>`;
    
    document.getElementById('btnConfirmarSetup').disabled = true;
    showErrorToast("Erro: " + mensagemErro);
}

    function refreshPedidos() {
        showSuccessToast("Atualizando painel...");
        google.script.run
            .withSuccessHandler(function(novosPedidos) {
                todosPedidos = novosPedidos;
                renderizarTelaCompleta();
            })
            .withFailureHandler(onSalvarErro)
            .buscarPedidosParaProducao();
    }
    
    // ===============================================
    // FLUXO DE REGISTRO DE CONSUMO E REFUGO
    // ===============================================
    function abrirModalConsumo(numPedido, impressor) {
        document.getElementById('consumo_metragem_total').value = "";
        dadosConsumoPendentes = null; 
        const impressorDisplay = impressor || 'N/A';
        document.getElementById('consumo_numPedido').textContent = numPedido;
        document.getElementById('consumo_impressor').textContent = impressorDisplay;
        
        if (impressorDisplay === 'N/A' || impressorDisplay.trim() === '') {
            document.getElementById('btnConfirmarConsumo').disabled = true;
            showErrorToast('Por favor, selecione o Impressor na tabela da Fila antes de registrar o consumo.');
        } else {
            document.getElementById('btnConfirmarConsumo').disabled = false;
        }
        
        M.updateTextFields(); 
        const labelMetragem = document.querySelector('label[for="consumo_metragem_total"]');
        if (labelMetragem) { labelMetragem.classList.add('active'); }
        
        if (consumoModalInstance) consumoModalInstance.open();
        document.getElementById('consumo_metragem_total').focus(); 
    }

    function registrarConsumo() {
        const dados = {
            pedidoConsumido: document.getElementById('consumo_numPedido').textContent,
            metragemConsumida: document.getElementById('consumo_metragem_total').value,
            impressor: document.getElementById('consumo_impressor').textContent
        };
        const metragemLimpa = dados.metragemConsumida.replace(",", ".");
        const metragemNum = parseFloat(metragemLimpa) || 0;

        if (dados.impressor === 'N/A' || dados.impressor.trim() === '') {
            showErrorToast('O nome do Impressor é obrigatório.'); return;
        }
        if (metragemNum <= 0) {
            showErrorToast('A metragem consumida deve ser um número positivo.'); return;
        }
        
        document.getElementById('btnConfirmarConsumo').disabled = true;
        showSuccessToast("Verificando limites de metragem...");
        
        google.script.run
            .withSuccessHandler(onValidacaoConsumoSuccess)
            .withFailureHandler(onSalvarErro)
            .validarConsumoMetragem(dados); 
    }

    function onValidacaoConsumoSuccess(resposta) {
        document.getElementById('btnConfirmarConsumo').disabled = false;
        
        if (resposta.necessitaJustificativa) {
            dadosConsumoPendentes = resposta.dadosConsumo; 
            document.getElementById('motivo_numPedido').textContent = resposta.dadosConsumo.pedidoConsumido;
            document.getElementById('motivo_metragem_consumida').textContent = formatarNumero(resposta.dadosConsumo.metragemConsumida);
            document.getElementById('motivoConsumoInput').value = "";
            checkMotivoConsumoInput();
            
            consumoModalInstance.close();
            modalMotivoConsumoInstance.open();
            
            showErrorToast("Motivo de consumo excessivo é obrigatório.");
            return;
        }
        
        if (resposta.sucesso) {
            showSuccessToast("Consumo validado. Registrando estoque...");
            registrarConsumoFinal(resposta.dadosConsumo);
        } else {
            onSalvarErro({ message: resposta.mensagem });
        }
    }

    function checkMotivoConsumoInput() {
        const input = document.getElementById('motivoConsumoInput');
        const btn = document.getElementById('motivoConsumoConfirmar');
        btn.disabled = input.value.trim().length < 10;
    }

    function onConfirmarMetragemExcessiva() {
        const motivo = document.getElementById('motivoConsumoInput').value.trim();
        if (motivo.length < 10) {
            showErrorToast("O motivo deve ter pelo menos 10 caracteres.");
            return;
        }
        
        dadosConsumoPendentes.motivoMetragemExcessiva = motivo;
        modalMotivoConsumoInstance.close();
        registrarConsumoFinal(dadosConsumoPendentes);
    }

    function registrarConsumoFinal(dados) {
        showSuccessToast("Registrando consumo...");
        google.script.run
            .withSuccessHandler(onConsumoSuccess)
            .withFailureHandler(onSalvarErro)
            .registrarConsumoPorPedido(dados);
    }

    function onConsumoSuccess(resposta) {
        if (resposta.sucesso) {
            showSuccessToast(resposta.mensagem);
            consumoModalInstance.close();
            refreshPedidos();
        } else {
            onSalvarErro({ message: resposta.mensagem });
        }
        document.getElementById('btnConfirmarConsumo').disabled = false;
    }
    
    function abrirModalAtraso(linhaPlanilha, tipoFluxo) {
        document.getElementById('motivoAtrasoInput').value = '';
        document.getElementById('motivoAtrasoConfirmar').disabled = true;

        // Sobrescreve o clique do botão de confirmação
        document.getElementById('motivoAtrasoConfirmar').onclick = function() {
            const motivo = document.getElementById('motivoAtrasoInput').value.trim();
            if (!motivo || motivo.length < 5) {
                showErrorToast("O motivo do atraso é obrigatório (mín. 5 caracteres).");
                return;
            }
            modalAtrasoInstance.close();
            
            // Chama a função de finalização correta
            if (tipoFluxo === "DIGITAL") {
              executarFinalizacaoDigital(linhaPlanilha, motivo);
            } else {
              executarFinalizacao(linhaPlanilha, motivo); // Padrão é Flexo
            }
        };
        
        modalAtrasoInstance.open();
    }
    
    function checkMotivoAtrasoInput() {
        const input = document.getElementById('motivoAtrasoInput');
        const btn = document.getElementById('motivoAtrasoConfirmar');
        btn.disabled = input.value.trim().length === 0;
    }
    function onConfirmarAtrasoClick() { /* Sobrescrito pela lógica de abertura */ }
    
    function handleNumeroPedidoClick(linhaPlanilha) {
        const loading = document.getElementById('detalhes-loading');
        const content = document.getElementById('detalhes-conteudo');
        const grid = content.querySelector('.detalhes-pedido-grid-3-col');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        grid.innerHTML = ''; 
        content.querySelectorAll('.detalhes-pedido-secao').forEach(el => el.remove());
        
        modalDetalhesInstance.open();
        
        google.script.run
            .withSuccessHandler(onGetDetalhesSucesso)
            .withFailureHandler(onGetDetalhesErro)
            .getDetalhesCompletosDoPedido(linhaPlanilha); 
    }

    function onGetDetalhesSucesso(detalhes) {
        const loading = document.getElementById('detalhes-loading');
        const content = document.getElementById('detalhes-conteudo');
        const grid = content.querySelector('.detalhes-pedido-grid-3-col');
        grid.innerHTML = '';
        content.querySelectorAll('.detalhes-pedido-secao').forEach(el => el.remove());

        const addItem = (label, valor, span = 1, sufixo = '') => {
            const val = (valor || '---') + (valor ? sufixo : '');
            const item = document.createElement('div');
            item.className = `detalhes-pedido-item ${span === 2 ? 'span-2' : ''} ${span === 3 ? 'full-width' : ''}`;
            item.innerHTML = `<span class="detalhes-pedido-label">${label}</span><span class="detalhes-pedido-valor">${val}</span>`;
            grid.appendChild(item);
        };
        const addObs = (titulo, icone, valor, textoVazio) => {
            const secao = document.createElement('div');
            secao.className = 'detalhes-pedido-secao';
            let obsHtml = '';
            if (valor && valor.trim()) {
                let style = 'border-color: #ffc107; background-color: #fff3cd; color: #856404;'; // Amarelo
                if (titulo.includes('Problema') || titulo.includes('Cancelamento') || titulo.includes('Atraso')) {
                    style = 'border-color: #D32F2F; background-color: #FFEBEE; color: #B71C1C;'; // Vermelho
                }
                obsHtml = `<div class="detalhes-pedido-obs" style="${style}">${valor}</div>`;
            } else {
                obsHtml = `<div class="detalhes-pedido-obs vazio">${textoVazio}</div>`;
            }
            secao.innerHTML = `
                <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">${icone}</i> ${titulo}</h6>
                ${obsHtml}
            `;
            content.appendChild(secao);
        };

        // Preenche o Grid
        addItem('N° do Pedido', detalhes.numPedido);
        addItem('Data do Pedido', detalhes.dataPedido);
        addItem('Tipo de Pedido', detalhes.tipo);
        addItem('Quantidade Pedida', formatarNumero(detalhes.quantidade));
        addItem('Vendedora', detalhes.vendedora);
        addItem('Tipo de Expedição', detalhes.tipoExpedicao);
        addItem('Data de Entrega', detalhes.dataEntrega);
        addItem('Data de Conclusão', detalhes.dataConclusao);
        addItem('Status do Pedido', detalhes.status);
        addItem('Cód. Produto', detalhes.codProduto);
        addItem('Cliente', detalhes.cliente);
        addItem('Cód. Clichê', detalhes.idCliche)
        addItem('Descrição do Produto', detalhes.descricao, 2);
        addItem('Faca', detalhes.faca);
        addItem('Substrato', detalhes.substrato);
        addItem('Tipo de Cola', detalhes.tipoCola);
        addItem('Largura', detalhes.largura, 1, ' mm');
        addItem('Altura', detalhes.altura, 1, ' mm');
        addItem('Puxada', detalhes.puxada, 1, ' mm');
        addItem('Qtd. Cores', detalhes.qtdCores);
        addItem('Carreiras', detalhes.carreiras);
        addItem('Acabamento', detalhes.tipoAcabamento);
        addItem('Cold', detalhes.cold);
        addItem('Metragem Calculada', detalhes.metragem, 1, ' m');
        addItem('Sem Excedente?', (detalhes.semExcedente === 'true' || detalhes.semExcedente === 'VERDADEIRO') ? 'SIM' : 'NÃO');
        addItem('Máquina (Prod)', detalhes.maquina);
        addItem('Fila (Prod)', detalhes.fila);
        addItem('Impressor', detalhes.impressor);
        addItem('Data Início Produção', detalhes.dataInicioProd);
        addItem('Data Fim Produção', detalhes.dataFimProd);
        addItem('Fornecedor Substrato', detalhes.fornecedorSubstrato);
        addItem('Lote Substrato', detalhes.loteSubstrato);
        addItem('Metragem Real', detalhes.metragemReal, 1, ' m');
        addItem('Refugo', detalhes.refugoMetragem, 1, ' m');
        addItem('Unidade CQ', detalhes.unidadeCQ);
        addItem('Inspetor', detalhes.inspetor);
        addItem('Qtd. Aprovada CQ', formatarNumero(detalhes.qtdAprovadaCQ));

        // Preenche Observações
        addObs('Observações PCP', 'announcement', detalhes.obsPCP, 'Nenhuma observação.');
        addObs('Problemas da Produção', 'build', detalhes.problemasProducao, 'Nenhum problema relatado.');
        addObs('Observações/Problemas CQ', 'info', detalhes.obsCQ, 'Nenhuma observação.');
        addObs('Motivo Metragem a Mais', 'warning', detalhes.motivoMaisMetragem, 'Nenhum motivo informado.');
        addObs('Motivo Atraso', 'history', detalhes.motivoAtraso, 'Nenhum atraso ou motivo informado.');
        addObs('Motivo Cancelamento', 'cancel', detalhes.motivoCancelamento, 'Não cancelado.');

        loading.style.display = 'none';
        content.style.display = 'block';
    }

    function onGetDetalhesErro(err) {
      showErrorToast('Erro ao buscar detalhes: ' + err.message);
      modalDetalhesInstance.close();
    }
    
    // ===============================================
    // FUNÇÕES AUXILIARES GERAIS
    // ===============================================
    function formatarNumero(valor) {
      if (valor === null || valor === undefined || valor === "") return '0';
      let numeroLimpo = String(valor).replace(/\./g, '').replace(',', '.');
      let num = parseFloat(numeroLimpo);
      if (isNaN(num)) return valor;
      return num.toLocaleString('pt-BR', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
    }

    function gerarOptions(lista, valorSelecionado, comVazio = false) {
      let html = comVazio ? `<option value="" ${!valorSelecionado ? 'selected' : ''}>${comVazio === true ? 'Selecione' : comVazio}</option>` : '';
      lista.forEach(item => {
          const selected = item === valorSelecionado ? 'selected' : '';
          html += `<option value="${item}" ${selected}>${item}</option>`;
      });
      return html;
    }
    
    function parseDate(dateString) {
      if (!dateString || typeof dateString !== 'string') return new Date(0); 
      const parts = dateString.split('/');
      if (parts.length !== 3) return new Date(0);
      return new Date(parts[2], parts[1] - 1, parts[0]); 
    }
    
    function checkDataStatus(dateString) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const dataEntrega = parseDate(dateString);
      if (dataEntrega.getTime() === 0) return { classe: '', icone: '' }; 
      const diffTime = dataEntrega.getTime() - hoje.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return { classe: 'data-atrasada', icone: '<i class="material-icons data-status-icon">error_outline</i>' };
      if (diffDays <= 2) return { classe: 'data-alerta', icone: '<i class="material-icons data-status-icon">warning</i>' };
      return { classe: '', icone: '' };
    }

    function getStatusColorClass(status) {
      const statusNorm = (status || "").toLowerCase().replace(/ /g, '-').replace('(', '').replace(')', '');
      switch (statusNorm) {
          case "liberado-para-produção": return "status-liberado-prod";
          case "programado": return "status-programado";
          case "setup": return "status-setup";
          case "em-produção": return "status-em-producao";
          case "controlando": return "status-controlando";
          case "produção-finalizada": return "status-programado"; 
          case "aguardando-batida": return "status-aguardando-batida";
          case "na-expedição": return "status-na-expedicao";
          case "concluído": return "status-concluido";
          // Novos status digital
          case "setup-digital": return "status-setup-digital";
          case "imprimindo-digital": return "status-imprimindo-digital";
          case "cortando-digital": return "status-cortando-digital";
          case "aguardando-corte-digital": return "status-aguardando-corte-digital";
          default: return "";
      }
    }


// ... (código existente) ...

function _showLoadingReporte(show) {
    const loading = document.getElementById('problema_loading');
    // A primeira DIV.row é a do N° Pedido e Seleção de Insumo
    const content = document.querySelector('#modalReportarProblema .row:first-of-type'); 
    
    // Blocos condicionais
    const blocoCliche = document.getElementById('bloco_cliche');
    const blocoFaca = document.getElementById('bloco_faca');

    if (show) {
        loading.style.display = 'block';
        content.style.display = 'none';
        blocoCliche.style.display = 'none';
        blocoFaca.style.display = 'none';
        document.getElementById('btnCancelarReporte').disabled = true;
        problemaBtnConfirm.disabled = true;
    } else {
        loading.style.display = 'none';
        content.style.display = 'flex'; // Exibir a linha de Pedido/Ferramenta
        document.getElementById('btnCancelarReporte').disabled = false;
    }
}

function _resetReporteModal() {
    dadosInsumosReporte = null;
    problemaNumPedidoInput.value = '';
    
    // Limpa os selects
    problemaFerramentaSelect.value = '';
    // Corrigido: Inicializa o select de ferramenta sem "Aguardando..." para que a busca o preencha
    problemaFerramentaSelect.disabled = true; 
    problemaFerramentaSelect.innerHTML = '<option value="" disabled selected>Aguardando Nº Pedido...</option><option value="Clichê">Clichê</option><option value="Faca">Faca</option><option value="Ambos">Ambos</option>';
    
    document.getElementById('problema_id_lamina').innerHTML = '<option value="" disabled>Selecione (Jogo Inteiro)</option>';
    document.getElementById('problema_tipo_cliche').innerHTML = '<option value="" disabled selected>Escolha o Tipo de Problema</option>';
    document.getElementById('problema_tipo_faca').innerHTML = '<option value="" disabled selected>Escolha o Tipo de Problema</option>';
    
    // Limpa textareas
    document.getElementById('problema_descricao_cliche').value = '';
    document.getElementById('problema_descricao_faca').value = '';

    // Limpa Display da Faca
    document.getElementById('faca_modelo_display').textContent = '---';
    document.getElementById('faca_id_unico_display').textContent = '---';
    document.getElementById('faca_info_display').style.backgroundColor = '#f9f9f9';

    // Esconde blocos
    document.getElementById('bloco_cliche').style.display = 'none';
    document.getElementById('bloco_faca').style.display = 'none';
    
    problemaBtnConfirm.disabled = true;
    M.FormSelect.init(document.querySelectorAll('#modalReportarProblema select'), materializeSelectOptions);
    M.updateTextFields();
}

function abrirModalReportarProblema() {
    _resetReporteModal();
    problemaModalInstance.open();
    M.updateTextFields();
}

function handlePedidoReporteChange() {
    const numPedido = problemaNumPedidoInput.value.trim();
    if (numPedido.length < 5 || isNaN(parseInt(numPedido))) {
        _resetReporteModal();
        return;
    }

    // 1. Reset e Mostra Loading
    _resetReporteModal();
    _showLoadingReporte(true);

    // 2. Busca Dados
    executarComRetry(
        'getDadosInsumosParaReporte',
        [numPedido],
        (data) => {
            _showLoadingReporte(false);
            if (!data || data.erro || !data.numPedido) {
                showErrorToast(data.erro || `Pedido ${numPedido} não encontrado, já cancelado/concluído ou erro de servidor.`);
                return;
            }
            
            dadosInsumosReporte = data;
            _preencherDadosReporte(data);
        },
        (erro) => {
            _showLoadingReporte(false);
            showErrorToast(`Erro ao buscar dados: ${erro.message}`);
            dadosInsumosReporte = null;
        }
    );
}

function _preencherDadosReporte(data) {
    const isClichêNulo = !data.idCliche || data.idCliche === 'N/A';
    const isFacaNulo = !data.codFacaModelo || data.codFacaModelo === 'N/A';
    
    // Status atual do pedido (para verificar bloqueio de Aguardando Insumos)
    const statusAtual = todosPedidos.find(p => p.numPedido == data.numPedido)?.status || "";
    if (statusAtual.includes("Aguardando")) {
        showErrorToast("Este pedido já está em status de espera. Cancele e recrie a solicitação se necessário.");
        return;
    }

    // --- 1. Preencher Selects de Tipo de Problema (Clichê e Faca) ---
    const selectTipoCliche = document.getElementById('problema_tipo_cliche');
    const selectTipoFaca = document.getElementById('problema_tipo_faca');
    selectTipoCliche.innerHTML = gerarOptions(data.tiposProblemaCliche, null, "Escolha o Tipo de Problema");
    selectTipoFaca.innerHTML = gerarOptions(data.tiposProblemaFaca, null, "Escolha o Tipo de Problema");
    
    // --- 2. Preencher Select de Lâminas (Clichê) ---
    const selectLamina = document.getElementById('problema_id_lamina');
    selectLamina.innerHTML = '<option value="" disabled>Selecione (Jogo Inteiro)</option>';
    if (!isClichêNulo && data.laminasDoCliche && data.laminasDoCliche.length > 0) {
        data.laminasDoCliche.forEach(lamina => {
            selectLamina.innerHTML += `<option value="${lamina.idLamina}">Estação ${lamina.estacao}: ${lamina.tipoLamina} (${lamina.statusLamina})</option>`;
        });
    } else if (!isClichêNulo) {
        selectLamina.innerHTML += '<option value="" disabled selected>Clichê sem lâminas contáveis cadastradas!</option>';
    }

    // --- 3. Preencher Display da Faca ---
    const facaDisplay = document.getElementById('faca_info_display');
    if (!isFacaNulo) {
        document.getElementById('faca_modelo_display').textContent = data.codFacaModelo;
        document.getElementById('faca_id_unico_display').textContent = data.idUnicoFaca;
        facaDisplay.style.backgroundColor = '#E8F5E9'; // Light Green background
        if (data.codFacaModelo.toUpperCase().includes('DIGITAL')) {
            facaDisplay.style.backgroundColor = '#E1F5FE'; // Light Blue for Digital
        }
    }
    
    // --- 4. Habilitar a seleção de Ferramenta ---
    problemaFerramentaSelect.value = ''; // Reset selection
    problemaFerramentaSelect.disabled = false;
    
    // Exibe mensagem se ambos insumos estiverem nulos
    if (isClichêNulo && isFacaNulo) {
        showErrorToast("Erro: O pedido não tem Clichê ou Faca vinculados para reporte.");
        problemaFerramentaSelect.disabled = true;
    }

    M.FormSelect.init(document.querySelectorAll('#modalReportarProblema select'), materializeSelectOptions);
    M.updateTextFields();
}

function handleFerramentaReporteChange() {
    const ferramenta = problemaFerramentaSelect.value;
    const blocoCliche = document.getElementById('bloco_cliche');
    const blocoFaca = document.getElementById('bloco_faca');
    const isClichêNulo = dadosInsumosReporte && (!dadosInsumosReporte.idCliche || dadosInsumosReporte.idCliche === 'N/A');
    const isFacaNulo = dadosInsumosReporte && (!dadosInsumosReporte.codFacaModelo || dadosInsumosReporte.codFacaModelo === 'N/A');

    blocoCliche.style.display = 'none';
    blocoFaca.style.display = 'none';
    problemaBtnConfirm.disabled = true;

    if (ferramenta === 'Clichê' || ferramenta === 'Ambos') {
        if (isClichêNulo) {
            showErrorToast("Este pedido não tem um ID de Clichê vinculado ao produto!");
        } else {
            blocoCliche.style.display = 'block';
        }
    }
    if (ferramenta === 'Faca' || ferramenta === 'Ambos') {
        if (isFacaNulo) {
             showErrorToast("Este pedido não tem um MODELO de Faca vinculado ao produto!");
        } else {
            blocoFaca.style.display = 'block';
        }
    }
    
    checkReporteInputs();
}

function checkReporteInputs() {
    const ferramenta = problemaFerramentaSelect.value;
    const isClichêBlocoVisivel = document.getElementById('bloco_cliche').style.display === 'block';
    const isFacaBlocoVisivel = document.getElementById('bloco_faca').style.display === 'block';

    let validCliche = true;
    let validFaca = true;

    if (isClichêBlocoVisivel) {
        const tipoCliche = document.getElementById('problema_tipo_cliche').value;
        const descCliche = document.getElementById('problema_descricao_cliche').value.trim();
        validCliche = !!tipoCliche && descCliche.length >= 5;
    }

    if (isFacaBlocoVisivel) {
        const tipoFaca = document.getElementById('problema_tipo_faca').value;
        const descFaca = document.getElementById('problema_descricao_faca').value.trim();
        validFaca = !!tipoFaca && descFaca.length >= 5;
    }

    const isDataFetched = !!dadosInsumosReporte;
    
    problemaBtnConfirm.disabled = !(isDataFetched && validCliche && validFaca && (isClichêBlocoVisivel || isFacaBlocoVisivel));
}

function confirmarReporteProblema() {
    problemaBtnConfirm.disabled = true;
    _showLoadingReporte(true);

    const ferramenta = problemaFerramentaSelect.value;
    const isClichêBlocoVisivel = document.getElementById('bloco_cliche').style.display === 'block';
    const isFacaBlocoVisivel = document.getElementById('bloco_faca').style.display === 'block';
    
    // --- 1. Montar o Objeto de Dados
    const dados = {
        numPedido: problemaNumPedidoInput.value.trim(),
        ferramenta: ferramenta, // "Clichê", "Faca" ou "Ambos"
        
        // Dados Clichê (Só preenche se for visível)
        tipoCliche: isClichêBlocoVisivel ? document.getElementById('problema_tipo_cliche').value : "",
        descCliche: isClichêBlocoVisivel ? document.getElementById('problema_descricao_cliche').value.trim() : "",
        idsLaminas: isClichêBlocoVisivel ? M.FormSelect.getInstance(document.getElementById('problema_id_lamina')).getSelectedValues() : [],
        
        // Dados Faca (Só preenche se for visível)
        tipoFaca: isFacaBlocoVisivel ? document.getElementById('problema_tipo_faca').value : "",
        descFaca: isFacaBlocoVisivel ? document.getElementById('problema_descricao_faca').value.trim() : ""
    };

    // --- 2. Validação (Repetição)
    if (!dados.numPedido || !dados.ferramenta || (isClichêBlocoVisivel && (dados.tipoCliche === "" || dados.descCliche.length < 5)) || (isFacaBlocoVisivel && (dados.tipoFaca === "" || dados.descFaca.length < 5))) {
        showErrorToast("Preencha todos os campos obrigatórios (Pedido, Insumo e Descrições com no mínimo 5 caracteres).");
        problemaBtnConfirm.disabled = false;
        _showLoadingReporte(false);
        return;
    }

    showSuccessToast("Registrando problema, aguarde...");

    // --- 3. Chamada ao Backend
    google.script.run
        .withSuccessHandler(onSucessoReporte)
        .withFailureHandler(onFalhaReporte)
        .registrarProblemaProducaoIntegrado(dados);
}

function onSucessoReporte(msg) {
    showSuccessToast(msg);
    problemaModalInstance.close();
    _showLoadingReporte(false);
    problemaBtnConfirm.disabled = false;
    refreshPedidos(); // Atualiza a fila de produção
}

function onFalhaReporte(erro) {
    showErrorToast(`Falha: ${erro.message}`);
    _showLoadingReporte(false);
    problemaBtnConfirm.disabled = false;
}
    
    </script>
</body>
</html>
