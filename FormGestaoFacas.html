<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
/* ===============================================
 * CSS GESTÃO DE FACAS - v4.2 (Alinhamento Final)
 * =============================================== */
body {
  font-family: 'Roboto', sans-serif;
  padding-bottom: 80px;
  background-color: #F4F6F8;
}
#divObjetos {
  max-width: 98%; 
  margin: 20px auto; 
  padding: 0 10px;
}

/* --- Cabeçalho --- */
.header-container {
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  margin-bottom: 25px; 
  padding: 15px 25px;
  background-color: #FFFFFF; 
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  border-bottom: 1px solid #ddd; 
}
.header-container h4 {
  font-size: 1.6rem; 
  font-weight: 600; 
  color: #37417c;
  display: flex; 
  align-items: center; 
  margin: 0;
}
.header-container h4 > i {
  font-size: 2rem; 
  margin-right: 15px; 
  color: #37417c;
}
.header-logo { 
  max-height: 45px; 
  width: auto; 
}

/* --- Container de Tabela --- */
.tabela-container {
  background-color: #ffffff; 
  border-radius: 8px;
  overflow: hidden; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  margin-bottom: 30px;
  border: 1px solid #E0E0E0;
}
.mensagem-vazia {
  padding: 30px 20px; 
  text-align: center; 
  color: #666;
  font-style: italic; 
  background-color: #f9f9f9;
  border-radius: 4px; 
  margin: 20px;
}

/* --- Filtros --- */
.filtro-container {
  background-color: #ffffff;
  padding: 5px 20px 5px 20px;
  border-radius: 8px 8px 0 0;
  border-bottom: 2px solid #eee;
}
.filtro-container .row {
  margin-bottom: 0 !important;
}
.filtro-container .input-field {
  margin-top: 1.5rem !important;
  margin-bottom: 0.5rem !important;
}
.filtro-container .input-field.filtro-texto .prefix {
  top: 0.8rem !important;
  left: 1.2rem !important;
  color: #37417c;
}

/* --- Tabelas --- */
table.responsive-table { 
  width: 100%; 
  table-layout: auto; 
}
table thead { 
  background: #37417c; 
}
table thead th {
  padding: 12px 10px !important; 
  text-align: left !important;
  font-weight: 600 !important; 
  color: #ffffff !important; 
  text-transform: uppercase; 
  font-size: 0.75rem;
  letter-spacing: 0.5px; 
  border-right: 1px solid rgba(255,255,255,0.1);
}
table thead th:last-child { 
  border-right: none; 
}
table tbody td {
  padding: 10px 10px !important; 
  vertical-align: middle !important;
  text-align: left; 
  color: #333; 
  font-size: 0.85rem;
  border-bottom: 1px solid #e0e0e0; 
  word-wrap: break-word; 
}
table tbody tr:hover { 
  background-color: #f5f7fa !important; 
}

/* Colunas */
.col-id-unico { 
  width: 15%; 
  font-weight: 700; 
  color: #37417c; 
}
.col-cod-modelo { width: 15%; }
.col-local { width: 20%; }
.col-data-entrada { width: 15%; }
.col-status-geral { width: 15%; }
.col-acoes { 
  width: 10%; 
  text-align: center !important; 
}

/* Status */
.col-status-cell {
  font-weight: 600 !important; 
  font-size: 0.8rem !important;
  text-transform: uppercase; 
  text-align: center !important;
  color: #fff !important;
  padding: 6px 8px !important;
  border-radius: 4px;
}
.status-disponivel { background-color: #4CAF50 !important; }
.status-aguardando-confeccao, 
.status-em-fabricacao { 
  background-color: #FFC107 !important; 
  color: #333 !important; 
}
.status-danificada { background-color: #F44336 !important; }
.status-bloqueada { background-color: #9E9E9E !important; }

/* --- Rodapé Fixo --- */
#footer-bar {
  position: fixed; 
  bottom: 0; 
  left: 0; 
  width: 100%;
  background-color: #ffffff; 
  border-top: 1px solid #ddd;
  padding: 12px 30px; 
  display: flex;
  justify-content: flex-end; 
  align-items: center;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.08); 
  z-index: 999;
  gap: 12px;
}
#footer-bar .btn {
  height: 40px; 
  line-height: 40px;
  padding: 0 20px !important; 
  font-weight: 600; 
  margin: 0 !important;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}
#footer-bar .btn.green {
  background-color: #C8E154 !important;
  color: #333 !important;
}
#footer-bar .btn.blue {
  background-color: #37417c !important;
}

/* ===============================================
 * MODAIS
 * =============================================== */
.modal { 
  border-radius: 8px !important; 
  max-width: 900px !important; 
  width: 90% !important;
  max-height: 85% !important;
  background-color: #ffffff;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}
.modal .modal-content { 
  padding: 25px 30px 20px 30px !important;
  background-color: #ffffff;
  position: relative;
}

/* Botão X */
.modal .modal-content .close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 2rem;
  line-height: 1;
  color: #999;
  cursor: pointer;
  font-weight: 300;
  padding: 0;
  background: none;
  border: none;
  transition: color 0.2s;
}
.modal .modal-content .close-btn:hover {
  color: #333;
}

/* Título */
.modal h4 { 
  color: #37417c; 
  font-weight: 600;
  border-bottom: 2px solid #f0f0f0;
  padding-bottom: 15px; 
  margin-bottom: 25px !important;
  font-size: 1.5rem !important; 
  display: flex;
  align-items: center;
}
.modal h4 i { 
  color: #37417c !important;
  margin-right: 12px; 
  font-size: 1.8rem;
}

/* Subtítulos */
.modal h5 {
  font-size: 1.05rem; 
  font-weight: 600;
  color: #37417c; 
  margin: 15px 0 25px 0 !important;
  padding-top: 15px;
  border-top: 1px solid #eee;
  border-bottom: none !important;
}

/* Divider */
.modal .divider {
  background-color: #e0e0e0;
  margin: 20px 0 !important;
  height: 1px;
}

/* ===============================================
 * CAMPOS DOS MODAIS - ALINHAMENTO PERFEITO
 * =============================================== */
.modal .input-field {
  margin-top: 0.2rem !important;
  margin-bottom: 0.2rem !important;
  padding: 0 !important;
  position: relative;
}

/* Label */
.modal .input-field label {
  position: absolute !important;
  top: 0.85rem !important;
  margin-left: -8px !important;
  font-size: 0.75rem !important;
  color: #555 !important;
  font-weight: 500 !important;
  transform: none !important;
  transition: all 0.2s ease !important;
  pointer-events: none;
}

.modal .input-field label .inv_localizacao,
.modal .input-field label .inv_obs {
  top: 0.7rem !important;
}

/* Label com ícone */
.modal .input-field .prefix ~ label {
  left: 45px !important;
}

/* Label ativa (flutuante) */
.modal .input-field label.active {
  top: -20px !important;
  left: 0 !important;
  font-size: 0.72rem !important;
  color: #37417c !important;
  font-weight: 600 !important;
  transform: none !important;
  background-color: transparent;
  padding: 0 5px;
}

.modal .input-field input[type=text],
.modal .input-field input[type=number], 
.modal .input-field textarea.materialize-textarea {
  background-color: #f9f9f9 !important;
  border: 1px solid #e0e0e0 !important;
  border-radius: 6px !important;
  height: 2.8rem !important;
  line-height: 2.8rem !imporant;
  font-size: 0.95rem !important;
  color: #333 !important;
  margin: 0 !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  padding-right: 10px !important;
  padding-left: 10px; /* Valor padrão sem prefixo */
  box-sizing: border-box !important;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  transition: all 0.2s ease;
}

/* Textarea */
.modal .input-field textarea.materialize-textarea {
  height: auto !important;
  min-height: 100px !important;
  padding: 12px !important;
  line-height: 1.5 !important;
  resize: vertical;
}

/* Focus */
.modal .input-field input:focus,
.modal .input-field textarea:focus,
.modal .input-field .select-wrapper input.select-dropdown:focus {
  border: 1px solid #37417c !important;
  box-shadow: 0 0 0 3px rgba(55, 65, 124, 0.12) !important;
  background-color: #fff !important;
}

/* Readonly */
.modal .input-field input[readonly] {
  color: #37417c !important;
  border: 1px solid #ccc !important;
  background-color: #f9f9f9 !important;
  font-weight: 600 !important;
}

/* Ícones (Prefix) - ALINHAMENTO PERFEITO */
.modal .input-field .prefix {
  position: absolute;
  left: 10px;
  top: 0.65rem;
  font-size: 1.5rem;
  color: #37417c;
  line-height: 1;
  z-index: 1;
}

/* ===============================================
 * CORREÇÃO PARA INPUTS E SELECTS COM ÍCONES
 * =============================================== */

/* Regra de override para TEXTO, NÚMERO e TEXTAREA */
/* Aumentamos a especificidade para garantir que ela vença a regra base */
.modal .input-field .prefix ~ input[type=text],
.modal .input-field .prefix ~ input[type=number],
.modal .input-field .prefix ~ textarea {
  padding-left: 45px !important; 
}

/* Regra de override para SELECTS */
/* Também aumentamos a especificidade e removemos o 'width' que quebrava o layout */
.modal .input-field .prefix ~ .select-wrapper input.select-dropdown {
  padding-left: 45px !important;
  /* A linha 'width: calc(...)' foi REMOVIDA daqui pois ela causava o problema A */
}

/* Select Dropdown */
.modal .select-wrapper {
  padding: 0 !important;
  margin: 0 !important;
  border: none !important;
  position: relative; 
  z-index: 0;
}
.modal .select-wrapper .caret {
  fill: #37417c !important;
}

/* ===============================================
 * AJUSTES ESPECÍFICOS - DETALHES DA FACA
 * =============================================== */
#inv_obs {
  min-height: 85px !important;
}

/* ===============================================
 * DETALHES DA FACA (GRID ESTÁTICO)
 * =============================================== */
.detalhes-label {
  font-size: 0.7rem;
  color: #555;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 5px;
  display: block;
  letter-spacing: 0.5px;
}
.detalhes-valor {
  font-size: 0.95rem;
  color: #333;
  font-weight: 500;
  padding: 10px 12px;
  background-color: #f5f7fa;
  border-radius: 6px;
  border-left: 3px solid #37417c;
  display: block; 
  min-height: 40px; 
  box-sizing: border-box;
  line-height: 1.4;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.detalhes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important; 
  gap: 15px 18px;
  margin-top: 20px;
  margin-bottom: 20px;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

/* Sub-tabelas */
.sub-tabela-container {
  margin-top: 30px;
}
.sub-tabela-container h5 {
  display: flex;
  align-items: center;
  margin-top: 30px !important;
  padding-top: 25px;
  border-top: 2px solid #eee;
}
.sub-tabela-container h5 i {
  margin-right: 8px;
  font-size: 1.3rem;
}

/* Tabelas internas */
#detalhe-pedidos-table, 
#detalhe-problemas-table,
#detalhe-loguso-table { 
  table-layout: auto; 
  width: 100%;
  margin-top: 10px;
}
#detalhe-pedidos-table thead,
#detalhe-loguso-table thead { 
  background-color: #37417c; 
}
#detalhe-problemas-table thead {
  background-color: #c62828 !important;
}

#detalhe-pedidos-table tbody td,
#detalhe-problemas-table tbody td,
#detalhe-loguso-table tbody td {
  padding: 8px 10px !important;
  font-size: 0.85rem;
}

/* Botão de Recebimento */
.btn-receber {
  background-color: #4CAF50 !important;
  padding: 0 10px !important;
  height: 30px !important;
  line-height: 30px !important;
  font-size: 0.8rem !important;
  border-radius: 4px;
}
.btn-receber i {
  font-size: 1.1rem !important;
  line-height: 30px !important;
}

/* ===============================================
 * FOOTER DOS MODAIS
 * =============================================== */
.modal .modal-footer {
  background-color: #f9f9f9; 
  border-radius: 0 0 8px 8px;
  border-top: 1px solid #eee;
  padding: 15px 25px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
}
.modal .modal-footer .btn-flat { 
  color: #777 !important; 
  font-weight: 600;
  margin-right: auto;
}
.modal .modal-footer .btn-flat:hover {
  background-color: rgba(0,0,0,0.05) !important;
}
.modal .modal-footer .btn { 
  background-color: #37417c !important;
  height: 40px; 
  line-height: 40px;
  padding: 0 25px !important;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.12);
  margin: 0 !important;
  border-radius: 8px;
}
.modal .modal-footer .btn.green { 
  background-color: #C8E154 !important;
  color: #333 !important;
}
.modal .modal-footer .btn.blue { 
  background-color: #37417c !important;
}
.modal .modal-footer .btn.orange { 
  background-color: #FB8C00 !important; 
}
.modal .modal-footer .btn.red { 
  background-color: #E53935 !important; 
}

/* ===============================================
 * TOASTS
 * =============================================== */
#toast-custom-container {
  position: fixed; 
  top: 20px; 
  left: 50%;
  transform: translateX(-50%); 
  z-index: 10000;
}
.toast {
  border-radius: 6px; 
  min-width: unset; 
  width: auto;
  padding: 12px 20px; 
  font-size: 0.95rem;
  display: flex; 
  align-items: center;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.toast .material-icons { 
  margin-right: 10px; 
}

/* ===============================================
 * AJUSTES POR MODAL
 * =============================================== */
#modalDetalhesFaca {
  max-width: 1200px !important;
}
#modalPedirCopiaFaca,
#modalSubstituirFaca,
#modalReportarProblemaFaca {
  max-width: 700px !important;
  max-height: 900px !important;
}
#modalRecebimentoFaca {
  max-width: 500px !important;
  max-height: 900px !important;
}
#modalRecebimentoFaca .input-field {
  margin-top: 1.0rem !important;
  margin-bottom: 1.0rem !important
}
#modalReportarProblemaFaca .input-field {
  margin-top: 1.0rem !important;
  margin-bottom: 1.0rem !important
}

/* Loading */
#detalhes-loading {
  text-align: center; 
  padding: 40px;
}
#detalhes-loading p {
  color: #666;
  margin-top: 15px;
}

  </style>
</head>
<body>

  <div id="toast-custom-container"></div>

  <div id="divObjetos">
    
    <div class="header-container">
      <h4><i class="material-icons">content_cut</i> Gestão de Facas</h4>
      <img src="[meucodebase64]" alt="Logo" class="header-logo">
    </div>
    
    <div id="tabela-inventario-container" class="tabela-container">
      
      <div class="filtro-container">
        <div class="row">
          <div class="input-field col s6 filtro-texto">
            <i class="material-icons prefix">search</i>
            <input id="filtro-pesquisa-inventario" type="text" placeholder="Pesquisar por ID Faca, Modelo ou Local">
          </div>
          <div class="input-field col s3 filtro-status">
            <select id="filtro-status-inventario">
              <option value="">Todos os Status</option>
              <option value="Disponível">Disponível</option>
              <option value="Aguardando Confecção">Aguardando Confecção</option>
              <option value="Em Fabricação">Em Fabricação</option>
              <option value="Danificada">Danificada</option>
              <option value="Bloqueada">Bloqueada</option>
            </select>
            <label>Filtrar por Status</label>
          </div>
        </div>
      </div>
         
      <table id="tabela-inventario-mestre" class="striped highlight responsive-table">
        <thead>
          <tr>
            <th class="col-id-unico">ID Único (Item)</th>
            <th class="col-cod-modelo">Cód. Faca (Modelo)</th>
            <th class="col-local">Localização</th>
            <th class="col-data-entrada">Data de Entrada</th>
            <th class="col-status-geral">Status</th>
            <th class="col-acoes">Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-inventario-corpo">
          </tbody>
      </table>
      <p id="msg-sem-inventario" class="mensagem-vazia" style="display: none;">
        Nenhuma faca encontrada no inventário.
      </p>
    </div>
  </div> 
  
  <div id="footer-bar">
     <button id="btnCadastrarModelo" class="btn waves-effect waves-light blue" onclick="abrirModalModeloFaca()">
       <i class="material-icons left">add_circle_outline</i>
       Cadastrar Novo Modelo
     </button>
     <button id="btnPedirNovaCopia" class="btn waves-effect waves-light green" onclick="abrirModalPedirCopia()">
       <i class="material-icons left">add_shopping_cart</i>
       Solicitar Faca
     </button>
  </div>
  
  <div id="modalModeloFaca" class="modal">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">architecture</i> Cadastrar Modelo de Faca</h4>
      
      <div class="row">
        <div class="input-field col s12">
          <i class="material-icons prefix">search</i>
          <input type="text" id="faca_busca" list="listaFacasBusca">
          <label for="faca_busca">Pesquisar Modelo de Faca (para editar)</label>
          <datalist id="listaFacasBusca"></datalist>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <h5 style="border:none; margin-top: 20px !important;">Dados do Modelo</h5>
      
      <input type="hidden" id="faca_linha"> <div class="row">
        <div class="input-field col s6">
          <i class="material-icons prefix">style</i>
          <input type="text" id="faca_nome">
          <label for="faca_nome">Cód. Faca (Ex: FX 278)</label>
        </div>
        <div class="input-field col s6">
          <i class="material-icons prefix">tune</i>
          <select id="faca_tipo">
            <option value="" disabled selected>Escolha o tipo</option>
            <option value="Magnética">Magnética</option>
            <option value="Maciça">Maciça</option>
          </select>
        </div>
      </div>
      
      <div class="row">
        <div class="input-field col s4">
          <i class="material-icons prefix">swap_horiz</i>
          <input type="text" id="faca_largura">
          <label for="faca_largura">Largura (mm)</label>
        </div>
        <div class="input-field col s4">
          <i class="material-icons prefix">swap_vert</i>
          <input type="text" id="faca_altura">
          <label for="faca_altura">Altura (mm)</label>
        </div>
        <div class="input-field col s4">
          <i class="material-icons prefix">compare_arrows</i>
          <input type="text" id="faca_puxada">
          <label for="faca_puxada">Puxada (mm)</label>
        </div>
      </div>
      
      <div class="row">
        <div class="input-field col s4">
          <i class="material-icons prefix">filter_2</i>
          <input type="text" id="faca_carreiras">
          <label for="faca_carreiras">Carreiras</label>
        </div>
        <div class="input-field col s4">
          <i class="material-icons prefix">loop</i>
          <input type="text" id="faca_repeticoes">
          <label for="faca_repeticoes">Repetições</label>
        </div>
        <div class="input-field col s4">
          <i class="material-icons prefix">space_bar</i>
          <input type="text" id="faca_entre_repeticoes">
          <label for="faca_entre_repeticoes">Espaço entre Rep. (mm)</label>
        </div>
      </div>
      
      <div class="row">
        <div class="input-field col s12">
          <i class="material-icons prefix">view_carousel</i>
          <select id="faca_cilindro">
            <option value="" disabled selected>Selecione o Cilindro (Z)</option>
            <? for (var i = 0; i < listas.cilindros.length; i++) { ?>
              <option value="<?= listas.cilindros[i]; ?>"><?= listas.cilindros[i]; ?></option>
            <? } ?>
          </select>
        </div>
      </div>
      
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect red" id="btnExcluirFaca" onclick="excluirModeloFaca()" style="display: none;">Excluir</button>
      <button class="btn waves-effect blue" id="btnLimparFaca" onclick="limparModalModeloFaca()">Limpar</button>
      <button class="btn waves-effect green" id="btnSalvarFaca" onclick="salvarModeloFaca()">Salvar Modelo</button>
    </div>
  </div>
  
  <div id="modalPedirCopiaFaca" class="modal" style="max-width: 700px !important;">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">add_shopping_cart</i> Solicitação de Faca (Nova/Cópia)</h4>
      
      <div class="row">
        <div class="input-field col s12">
          <i class="material-icons prefix">search</i>
          <input type="text" id="copia_faca_busca" list="listaFacasCopiaBusca">
          <label for="copia_faca_busca">1. Selecione o Modelo da Faca (Ex: FX 278)</label>
          <datalist id="listaFacasCopiaBusca"></datalist>
        </div>
      </div>

      <div class="row">
        <div class="input-field col s6">
          <i class="material-icons prefix">person</i>
          <select id="copia_solicitante">
            <option value="" disabled selected>Selecione o Solicitante</option>
            <? for (var i = 0; i < listas.solicitantes.length; i++) { ?>
              <option value="<?= listas.solicitantes[i]; ?>"><?= listas.solicitantes[i]; ?></option>
            <? } ?>
          </select>
        </div>
        <div class="input-field col s6">
          <i class="material-icons prefix">store</i>
          <select id="copia_fornecedor">
            <option value="" disabled selected>Selecione o Fornecedor</option>
             <? for (var i = 0; i < listas.fornecedores.length; i++) { ?>
              <option value="<?= listas.fornecedores[i]; ?>"><?= listas.fornecedores[i]; ?></option>
            <? } ?>
          </select>
        </div>
      </div>
      
      <p>Esta ação irá criar um novo item de inventário (ex: FX 278/1 ou FX 278/2...) com o status "Em Fabricação" e registrará um pedido de compra do tipo "Faca Nova".</p>
      
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect green" id="btnConfirmarCopiaFaca" onclick="salvarPedidoNovaCopia()" disabled>
        Confirmar Pedido de Faca
      </button>
    </div>
  </div>
  
  <div id="modalDetalhesFaca" class="modal" style="max-width: 1200px !important;">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">edit</i> Detalhes da Faca</h4>
      
      <div id="detalhes-loading" style="text-align: center; padding: 40px; display: none;">
         <div class="preloader-wrapper big active">
            <div class="spinner-layer spinner-blue-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div><div class="gap-patch">
                <div class="circle"></div>
              </div><div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
         <p>Buscando dados completos da faca...</p>
      </div>
      
      <div id="detalhes-conteudo" style="display:none;">
      
        <input type="hidden" id="inv_id_unico">
        <input type="hidden" id="inv_cod_modelo_hidden">
        
        <div class="row">
          <div class="input-field col s4">
            <i class="material-icons prefix">fingerprint</i>
            <input type="text" id="inv_id_unico_display" readonly>
            <label for="inv_id_unico_display" class="active">ID Único - Faca/Nº</label>
          </div>
          <div class="input-field col s4">
            <i class="material-icons prefix">style</i>
            <input type="text" id="inv_cod_modelo_display" readonly>
            <label for="inv_cod_modelo_display" class="active">Cód. Faca (FX / E-)</label>
          </div>
          <div class="input-field col s4">
            <i class="material-icons prefix">shield</i>
            <select id="inv_status">
              <option value="Disponível">Disponível</option>
              <option value="Aguardando Confecção">Aguardando Confecção</option>
              <option value="Em Fabricação">Em Fabricação</option>
              <option value="Danificada">Danificada</option>
              <option value="Bloqueada">Bloqueada</option>
            </select>
          </div>
        </div>
        
        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">location_on</i>
            <input type="text" id="inv_localizacao">
            <label for="inv_localizacao">Localização</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">notes</i>
            <textarea id="inv_obs" class="materialize-textarea"></textarea>
           <label for="inv_obs">Observações</label>
          </div>
          </div>
        <div class="detalhes-grid">
           <div>
              <span class="detalhes-label">Tipo de Faca</span>
              <span id="detalhe_tipo_faca" class="detalhes-valor">---</span>
           </div>
           <div>
              <span class="detalhes-label">Formato (LxA)</span>
              <span id="detalhe_formato" class="detalhes-valor">---</span>
           </div>
           <div>
              <span class="detalhes-label">Puxada</span>
              <span id="detalhe_puxada" class="detalhes-valor">---</span>
           </div>
           <div>
              <span class="detalhes-label">Carreiras / Repetições</span>
              <span id="detalhe_carreiras_rep" class="detalhes-valor">---</span>
           </div>
           <div>
              <span class="detalhes-label">Entre Repetições</span>
              <span id="detalhe_entre_rep" class="detalhes-valor">---</span>
            </div>
           <div>
              <span class="detalhes-label">Cilindro (Z)</span>
              <span id="detalhe_cilindro" class="detalhes-valor">---</span>
           </div>
           <div>
              <span class="detalhes-label">Total Metros Usados</span>
              <span id="detalhe_total_metros" class="detalhes-valor" style="color: #37417c; font-weight: 700;">---</span>
           </div>
        </div>
        
        <div class="sub-tabela-container">
          <h5><i class="material-icons" style="font-size: 1.2rem; margin-right: 8px;">timeline</i> Histórico de Uso em Pedidos</h5>
          <table id="detalhe-loguso-table">
            <thead>
              <tr>
                <th style="width: 15%;">Data de Uso</th>
                <th style="width: 15%;">Nº Pedido</th>
                <th style="width: 50%;">Cliente / Produto (do Pedido)</th>
                <th style="width: 20%; text-align: left !important;">Metros Consumidos</th>
              </tr>
            </thead>
            <tbody id="detalhe-loguso-corpo"></tbody>
          </table>
          <p id="detalhe-loguso-vazio" class="mensagem-vazia" style="margin: 10px 0 0 0; display: none;">
            Esta faca nunca foi usada.
          </p>
        </div>

        <div class="sub-tabela-container">
          <h5><i class="material-icons" style="font-size: 1.2rem; margin-right: 8px;">shopping_cart</i> Histórico de Pedidos de Compra</h5>
          <table id="detalhe-pedidos-table">
            <thead>
              <tr>
                <th style="width: 12%;">Data Solic.</th>
                <th style="width: 15%;">Solicitante</th>
                <th style="width: 15%;">Fornecedor</th>
                <th style="width: 20%;">Tipo de Pedido</th> 
                <th style="width: 10%;">Data Prev.</th>
                <th style="width: 10%;">Data Receb.</th>
                <th style="width: 10%;">Status</th>
                <th style="width: 8%;">Ação</th>
              </tr>
            </thead>
            <tbody id="detalhe-pedidos-corpo"></tbody>
          </table>
          <p id="detalhe-pedidos-vazio" class="mensagem-vazia" style="margin: 10px 0 0 0; display: none;">
            Nenhum pedido de compra registrado para esta faca.
          </p>
        </div>
        
        <div class="sub-tabela-container">
          <h5><i class="material-icons" style="color:#c62828; font-size: 1.2rem; margin-right: 8px;">report</i> Histórico de Problemas</h5>
            <table id="detalhe-problemas-table">
              <thead>
              <tr>
                <th style="width: 15%;">Data de Reporte</th>
                <th style="width: 25%;">Tipo de Problema</th>
                <th style="width: 60%;">Descrição</th>
              </tr>
              </thead>
              <tbody id="detalhe-problemas-corpo"></tbody>
            </table>
            <p id="detalhe-problemas-vazio" class="mensagem-vazia" style="margin: 10px 0 0 0; display: none;">
              Nenhum problema reportado para esta faca.
            </p>
        </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect waves-light red" id="btnAbrirModalReportarProblema" onclick="abrirModalReportarProblema()">
        <i class="material-icons left">report_problem</i>
        Reportar Problema
      </button>
      <button class="btn waves-effect waves-light orange" id="btnAbrirModalSubstituicao" onclick="abrirModalSubstituirFaca()">
        <i class="material-icons left">add_shopping_cart</i>
        Pedir Substituição
      </button>
      <button class="btn waves-effect green" id="btnSalvarDetalhes" onclick="salvarItemInventario()">
        Salvar Alterações
      </button>
    </div>
  </div>

  <div id="modalRecebimentoFaca" class="modal" style="max-width: 500px !important;">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">local_shipping</i> Receber Pedido de Faca</h4>
      <p>Preencha os dados de recebimento para o Pedido <strong id="receber_id_pedido_faca">...</strong></p>
      
      <input type="hidden" id="receber_id_unico_faca">
      
      <div class="row" style="margin-bottom: 0 !important;">
        <div class="input-field col s12">
          <i class="material-icons prefix">event_available</i>
          <input id="receber_data" type="text" class="datepicker">
          <label for="receber_data" class="active">Data de Recebimento</label>
        </div>
        <div class="input-field col s12">
          <i class="material-icons prefix">attach_money</i>
          <input id="receber_valor_nf" type="number" step="0.01">
          <label for="receber_valor_nf">Valor (R$)</label>
        </div>
        <div class="input-field col s12">
          <i class="material-icons prefix">receipt</i>
          <input id="receber_num_nf" type="text">
          <label for="receber_num_nf">Nº NF / Documento</label>
        </div>
      </div>
      
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect green" id="btnConfirmarRecebimento" onclick="confirmarRecebimentoFaca()">
        Confirmar Recebimento
      </button>
    </div>
  </div>

  <div id="modalReportarProblemaFaca" class="modal" style="max-width: 700px !important;">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">report_problem</i> Reportar Problema na Faca</h4>
      <p>Descreva o problema encontrado na faca: <strong id="problema_id_unico_display">...</strong></p>
      
      <input type="hidden" id="problema_id_unico">
      
      <div class="row" style="margin-bottom: 0 !important;">
        <div class="input-field col s12">
          <i class="material-icons prefix">error_outline</i>
          <select id="problema_tipo">
            <option value="" disabled selected>1. Selecione o Tipo de Problema</option>
            <? for (var i = 0; i < listas.tiposProblemaFaca.length; i++) { ?>
              <option value="<?= listas.tiposProblemaFaca[i]; ?>"><?= listas.tiposProblemaFaca[i]; ?></option>
            <? } ?>
          </select>
        </div>
        
        <div class="input-field col s12">
          <i class="material-icons prefix">edit</i>
          <textarea id="problema_motivo_descricao" class="materialize-textarea"></textarea>
          <label for="problema_motivo_descricao">2. Descreva o Problema (Obrigatório)</label>
        </div>
      </div>
      
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect red" id="btnConfirmarReporte" onclick="salvarReporteProblema()">
        Confirmar Problema
      </button>
    </div>
  </div>
  
  <div id="modalSubstituirFaca" class="modal" style="max-width: 700px !important;">
    <div class="modal-content">
      <button class="modal-close close-btn" title="Fechar">&times;</button>
      <h4><i class="material-icons">build_circle</i> Pedir Substituição de Faca</h4>
      <p>Criar um novo pedido de compra para o item: <strong id="subs_id_unico_display">...</strong></p>

      <input type="hidden" id="subs_id_unico">
      <input type="hidden" id="subs_cod_modelo">
      
      <div class="row">
        <div class="input-field col s6">
          <i class="material-icons prefix">person</i>
          <select id="subs_solicitante">
            <option value="" disabled selected>Selecione o Solicitante</option>
            <? for (var i = 0; i < listas.solicitantes.length; i++) { ?>
              <option value="<?= listas.solicitantes[i]; ?>"><?= listas.solicitantes[i]; ?></option>
            <? } ?>
          </select>
          <label>1. Solicitante</label>
        </div>
        <div class="input-field col s6">
          <i class="material-icons prefix">store</i>
          <select id="subs_fornecedor">
            <option value="" disabled selected>Selecione o Fornecedor</option>
             <? for (var i = 0; i < listas.fornecedores.length; i++) { ?>
              <option value="<?= listas.fornecedores[i]; ?>"><?= listas.fornecedores[i]; ?></option>
            <? } ?>
          </select>
          <label>2. Fornecedor</label>
        </div>
      </div>
      
      <div class="row">
        <div class="input-field col s12">
          <i class="material-icons prefix">help_outline</i>
          <select id="subs_tipo_pedido">
            <option value="" disabled selected>3. Selecione o Motivo</option>
            <? for (var i = 0; i < listas.tiposCompraFaca.length; i++) { ?>
              <option value="<?= listas.tiposCompraFaca[i]; ?>"><?= listas.tiposCompraFaca[i]; ?></option>
            <? } ?>
          </select>
          <label>Motivo do Pedido</label>
        </div>
      </div>
      <div class="row" id="subs_descricao_motivo_wrapper" style="display: none;">
        <div class="input-field col s12">
          <i class="material-icons prefix">edit</i>
          <textarea id="subs_descricao_motivo" class="materialize-textarea"></textarea>
          <label for="subs_descricao_motivo">4. Descrição (Obrigatório se Faca Danificada)</label>
        </div>
      </div>
      
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
      <button class="btn waves-effect green" id="btnConfirmarSubstituicao" onclick="salvarPedidoSubstituicao()">
        Confirmar Pedido de Substituição
      </button>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
 <script>
    // ==================================================================
    // JAVASCRIPT - GESTÃO DE FACAS (v3.2 - Layout Corrigido)
    // ==================================================================

    // --- Variáveis Globais ---
    var dadosIniciais = <?!= JSON.stringify(dados).replace(/</g, '\\u003c') ?>;
    var listasGlobais = <?!= JSON.stringify(listas).replace(/</g, '\\u003c') ?>;
    
    let facasModelos = dadosIniciais.facasModelos || [];
    let facasInventario = dadosIniciais.facasInventario || [];
    let mapaInventario = dadosIniciais.mapaInventario || {};
    let facasPedidos = dadosIniciais.facasPedidos || {};
    let facasProblemas = dadosIniciais.facasProblemas || {};
    let facasLogUso = dadosIniciais.facasLogUso || {};
    
    let mapaModelosAutocomplete = dadosIniciais.mapaModelosAutocomplete || {};
    let modeloSelecionadoParaCopia = null;
    let itemSelecionadoGlobal = null; 
    let pedidoParaReceber = null;

    let modalModeloInstance, modalCopiaInstance, 
        modalDetalhesInstance, modalRecebimentoInstance, 
        modalReportarProblemaInstance, modalSubstituirInstance;

    const materializeSelectOptions = {
      dropdownOptions: { container: document.body, constrainWidth: false }
    };

    // ===============================================
    // INICIALIZAÇÃO
    // ===============================================
    document.addEventListener('DOMContentLoaded', function() {
        
        M.Modal.init(document.querySelectorAll('.modal'), { 
          dismissible: true // (MUDANÇA) Permite fechar clicando fora
        });
        M.FormSelect.init(document.querySelectorAll('select'), materializeSelectOptions);
        M.Datepicker.init(document.querySelectorAll('.datepicker'), {
          format: 'dd/mm/yyyy', autoClose: true, container: document.body,
          i18n: { months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'], weekdaysShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'], cancel: 'Cancelar', done: 'Ok' }
        });

        modalModeloInstance = M.Modal.getInstance(document.getElementById('modalModeloFaca'));
        modalCopiaInstance = M.Modal.getInstance(document.getElementById('modalPedirCopiaFaca'));
        modalDetalhesInstance = M.Modal.getInstance(document.getElementById('modalDetalhesFaca'));
        modalRecebimentoInstance = M.Modal.getInstance(document.getElementById('modalRecebimentoFaca'));
        modalReportarProblemaInstance = M.Modal.getInstance(document.getElementById('modalReportarProblemaFaca'));
        modalSubstituirInstance = M.Modal.getInstance(document.getElementById('modalSubstituirFaca'));
        
        prepararDadosAutocomplete();
        setupListeners();
        renderizarTabelaInventario();
    });

    function prepararDadosAutocomplete() {
        M.Autocomplete.init(document.getElementById('faca_busca'), {
            data: mapaModelosAutocomplete,
            limit: 5,
            onAutocomplete: onModeloSelecionadoParaEditar,
            dropdownOptions: { container: document.body }
        });
        
        M.Autocomplete.init(document.getElementById('copia_faca_busca'), {
            data: mapaModelosAutocomplete,
            limit: 5,
            onAutocomplete: onModeloSelecionadoParaCopia,
            dropdownOptions: { container: document.body }
        });
        
        const selSolicitante = document.getElementById('copia_solicitante');
        selSolicitante.innerHTML = '<option value="" disabled selected>Selecione o Solicitante</option>';
        (listasGlobais.solicitantes || []).forEach(nome => selSolicitante.innerHTML += `<option value="${nome}">${nome}</option>`);
        
        const selFornecedor = document.getElementById('copia_fornecedor');
        selFornecedor.innerHTML = '<option value="" disabled selected>Selecione o Fornecedor</option>';
        (listasGlobais.fornecedores || []).forEach(nome => selFornecedor.innerHTML += `<option value="${nome}">${nome}</option>`);
    }

    function setupListeners() {
        document.getElementById('filtro-pesquisa-inventario').addEventListener('input', renderizarTabelaInventario);
        document.getElementById('filtro-status-inventario').addEventListener('change', renderizarTabelaInventario);
        
        document.getElementById('tabela-inventario-corpo').addEventListener('click', (e) => {
            const botaoEditar = e.target.closest('button[data-action="editar"]');
            
            if (botaoEditar) {
                e.preventDefault();
                e.stopPropagation(); 
                const idUnico = botaoEditar.closest('tr').dataset.idUnico;
                abrirModalDetalhesCompletos(idUnico); 
            }
        });
        
        document.getElementById('detalhe-pedidos-corpo').addEventListener('click', (e) => {
          const botao = e.target.closest('button.btn-receber');
          if(botao) {
            e.preventDefault();
            abrirModalRecebimento(
              botao.dataset.idPedidoFaca,
              botao.dataset.idUnicoFaca
            );
          }
        });

        document.getElementById('subs_tipo_pedido').addEventListener('change', (e) => {
           const wrapper = document.getElementById('subs_descricao_motivo_wrapper');
           const motivo = e.target.value || "";
           if (motivo.includes("Danificada")) {
             wrapper.style.display = 'block';
             M.textareaAutoResize(document.getElementById('subs_descricao_motivo'));
           } else {
             wrapper.style.display = 'none';
           }
        });
    }

    // ===============================================
    // LÓGICA DA TELA PRINCIPAL (INVENTÁRIO)
    // ===============================================

    function renderizarTabelaInventario() {
        const filtroTexto = document.getElementById('filtro-pesquisa-inventario').value.toUpperCase();
        const filtroStatus = document.getElementById('filtro-status-inventario').value;
        const corpoTabela = document.getElementById('tabela-inventario-corpo');
        const msgVazia = document.getElementById('msg-sem-inventario');
        
        corpoTabela.innerHTML = '';
        let contador = 0;
        
        const facasFiltradas = facasInventario.filter(faca => {
            const statusMatch = !filtroStatus || faca.status === filtroStatus;
            const textoMatch = !filtroTexto ||
                                 faca.idUnico.toUpperCase().includes(filtroTexto) ||
                                 faca.codFacaModelo.toUpperCase().includes(filtroTexto) ||
                                 (faca.localizacao && faca.localizacao.toUpperCase().includes(filtroTexto));
            return statusMatch && textoMatch;
        });
        
        facasFiltradas.sort((a, b) => a.idUnico.localeCompare(b.idUnico));

        facasFiltradas.forEach(faca => {
            corpoTabela.appendChild(criarLinhaInventario(faca));
            contador++;
        });
        
        msgVazia.style.display = (contador === 0) ? 'block' : 'none';
        corpoTabela.style.display = (contador === 0) ? 'none' : '';
    }

    function criarLinhaInventario(faca) {
        const tr = document.createElement('tr');
        tr.dataset.idUnico = faca.idUnico;

        const statusClasseMap = {
            "Disponível": "status-disponivel",
            "Aguardando Confecção": "status-aguardando-confeccao",
            "Em Fabricação": "status-em-fabricacao",
            "Danificada": "status-danificada",
            "Bloqueada": "status-bloqueada"
        };
        const statusTexto = faca.status || "N/A";
        const statusClasse = statusClasseMap[statusTexto] || "status-outro";

        tr.innerHTML = `
            <td class="col-id-unico">${faca.idUnico}</td>
            <td class="col-cod-modelo" title="${faca.codFacaModelo}">${faca.codFacaModelo}</td>
            <td class="col-local" title="${faca.localizacao || ''}">${faca.localizacao || "---"}</td>
            <td class="col-data-entrada">${faca.dataEntrada}</td>
            <td class="col-status-geral col-status-cell ${statusClasse}">
                ${statusTexto}
            </td>
            <td class="col-acoes">
                <button class="btn-small waves-effect waves-light blue" data-action="editar" title="Ver Detalhes / Editar">
                    <i class="material-icons">edit</i>
                </button>
            </td>
        `;
        return tr;
    }
    
    // (Funções de Toast)
    function showToast(message, type = 'green') {
      const icon = type === 'green' ? 'check_circle' : 'error';
      M.toast({
        html: `<i class="material-icons">${icon}</i> ${message}`,
        classes: type === 'green' ? 'green darken-1' : 'red darken-2',
        displayLength: 4000,
        container: '#toast-custom-container'
      });
    }
    function showErrorToast(error) {
      const msg = (typeof error === 'object' && error.message) ? error.message : error;
      showToast(msg, 'red');
    }

    // (Callback genérico de sucesso - FECHA TUDO)
    function onSalvoComSucesso(novosDados) {
        showToast("Operação realizada com sucesso!", "green");
        
        facasModelos = novosDados.facasModelos || [];
        facasInventario = novosDados.facasInventario || [];
        mapaInventario = novosDados.mapaInventario || {};
        facasPedidos = novosDados.facasPedidos || {};
        facasProblemas = novosDados.facasProblemas || {};
        facasLogUso = novosDados.facasLogUso || {};
        mapaModelosAutocomplete = novosDados.mapaModelosAutocomplete || {};
        
        prepararDadosAutocomplete();
        renderizarTabelaInventario();
        
        modalModeloInstance.close();
        modalCopiaInstance.close();
        modalDetalhesInstance.close();
        modalRecebimentoInstance.close();
        modalReportarProblemaInstance.close();
        modalSubstituirInstance.close();
        
        document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
    }

    // (Callback de sucesso - MANTÉM MODAL DETALHES ABERTO)
    function onSalvoComSucesso_AtualizarDetalhes(novosDados) {
        showToast("Operação realizada com sucesso!", "green");
        
        facasModelos = novosDados.facasModelos || [];
        facasInventario = novosDados.facasInventario || [];
        mapaInventario = novosDados.mapaInventario || {};
        facasPedidos = novosDados.facasPedidos || {};
        facasProblemas = novosDados.facasProblemas || {};
        facasLogUso = novosDados.facasLogUso || {};
        
        renderizarTabelaInventario(); 
        
        // Fecha APENAS os modais "filhos"
        modalRecebimentoInstance.close();
        modalReportarProblemaInstance.close();
        modalSubstituirInstance.close();
        
        if (itemSelecionadoGlobal && itemSelecionadoGlobal.idUnico) {
            // Atualiza o item global com os novos dados
            itemSelecionadoGlobal = novosDados.mapaInventario[itemSelecionadoGlobal.idUnico];
            // Recarrega o modal
            if (itemSelecionadoGlobal) {
              abrirModalDetalhesCompletos(itemSelecionadoGlobal.idUnico);
            } else {
              modalDetalhesInstance.close(); // Fecha se o item sumiu
            }
        }

        document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
    }
    
    function onSalvarErro(err) {
        showErrorToast(err.message);
        document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
    }

    // ===============================================
    // LÓGICA MODAL 1: CADASTRAR/EDITAR MODELO (FormFaca)
    // ===============================================
    
    function abrirModalModeloFaca() {
        limparModalModeloFaca();
        modalModeloInstance.open();
    }
    
    function onModeloSelecionadoParaEditar(nomeFaca) {
        google.script.run
            .withSuccessHandler(preencherModalModeloFaca)
            .withFailureHandler(showErrorToast)
            .buscarFacaPeloNome(nomeFaca);
    }
    function preencherModalModeloFaca(faca) {
        document.getElementById('faca_linha').value = faca.linha;
        document.getElementById('faca_nome').value = faca.nome;
        document.getElementById('faca_tipo').value = faca.tipo;
        document.getElementById('faca_largura').value = faca.largura;
        document.getElementById('faca_altura').value = faca.altura;
        document.getElementById('faca_puxada').value = faca.puxada;
        document.getElementById('faca_carreiras').value = faca.carreiras;
        document.getElementById('faca_repeticoes').value = faca.repeticoes;
        document.getElementById('faca_cilindro').value = faca.cilindro;

           // ✅ CORREÇÃO: Verifica se o valor existe antes de preencher
        const entreRepField = document.getElementById('faca_entre_repeticoes');
        if (faca.entreRepeticoes !== undefined && faca.entreRepeticoes !== null) {
            entreRepField.value = faca.entreRepeticoes;
            console.log("✅ Entre Repetições preenchido:", faca.entreRepeticoes);
        } else {
            entreRepField.value = '';
            console.warn("⚠️ Campo 'entreRepeticoes' não veio do backend!");
        }

        document.getElementById('faca_nome').disabled = true;
        document.getElementById('btnSalvarFaca').textContent = "Salvar Alterações";
        document.getElementById('btnExcluirFaca').style.display = 'inline-block';
        
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalModeloFaca select'), materializeSelectOptions);
    }
    function limparModalModeloFaca() {
        document.getElementById('faca_linha').value = '';
        document.getElementById('faca_nome').value = '';
        document.getElementById('faca_tipo').value = '';
        document.getElementById('faca_largura').value = '';
        document.getElementById('faca_altura').value = '';
        document.getElementById('faca_puxada').value = '';
        document.getElementById('faca_carreiras').value = '';
        document.getElementById('faca_repeticoes').value = '';
        document.getElementById('faca_cilindro').value = '';
        document.getElementById('faca_entre_repeticoes').value = '';
        document.getElementById('faca_busca').value = '';

        document.getElementById('faca_nome').disabled = false;
        document.getElementById('btnSalvarFaca').textContent = "Salvar Modelo";
        document.getElementById('btnExcluirFaca').style.display = 'none';

        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalModeloFaca select'), materializeSelectOptions);
    }
    function salvarModeloFaca() {
        const faca = {
            linha: document.getElementById('faca_linha').value,
            nome: document.getElementById('faca_nome').value,
            tipo: document.getElementById('faca_tipo').value,
            largura: document.getElementById('faca_largura').value,
            altura: document.getElementById('faca_altura').value,
            puxada: document.getElementById('faca_puxada').value,
            carreiras: document.getElementById('faca_carreiras').value,
            repeticoes: document.getElementById('faca_repeticoes').value,
            cilindro: document.getElementById('faca_cilindro').value,
            entreRepeticoes: document.getElementById('faca_entre_repeticoes').value
        };

        if (!faca.nome || !faca.tipo) {
            showErrorToast("Nome da Faca e Tipo são obrigatórios.");
            return;
        }
        
        document.getElementById('btnSalvarFaca').disabled = true;
        showToast("Salvando modelo...", "green");
        
        const isEdit = !!faca.linha;
        
        if (isEdit) {
            google.script.run
                .withSuccessHandler(onSalvoComSucesso)
                .withFailureHandler(onSalvarErro)
                .alterarFaca(faca);
        } else {
            google.script.run
                .withSuccessHandler(onSalvoComSucesso)
                .withFailureHandler(onSalvarErro)
                .salvarFaca(faca); // (MUDANÇA) Chama a V3.2 (que não cria item)
        }
    }
    function excluirModeloFaca() {
        const nomeFaca = document.getElementById('faca_nome').value;
        if (!nomeFaca) {
            showErrorToast("Nenhuma faca carregada para excluir."); return;
        }
        if (!confirm(`Tem certeza que deseja EXCLUIR o MODELO '${nomeFaca}'? Esta ação não pode ser desfeita.`)) {
            return;
        }
        document.getElementById('btnExcluirFaca').disabled = true;
        
        google.script.run
            .withSuccessHandler(onSalvoComSucesso)
            .withFailureHandler(onSalvarErro)
            .excluirFaca(nomeFaca);
    }
    
    // ===============================================
    // LÓGICA MODAL 2: PEDIR NOVA CÓPIA (INVENTÁRIO)
    // ===============================================
    
    function abrirModalPedirCopia() {
        modeloSelecionadoParaCopia = null;
        document.getElementById('copia_faca_busca').value = '';
        document.getElementById('copia_solicitante').value = '';
        document.getElementById('copia_fornecedor').value = '';
        document.getElementById('btnConfirmarCopiaFaca').disabled = true;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalPedirCopiaFaca select'), materializeSelectOptions);
        modalCopiaInstance.open();
    }
    
    function onModeloSelecionadoParaCopia(nomeFaca) {
        modeloSelecionadoParaCopia = nomeFaca;
        document.getElementById('btnConfirmarCopiaFaca').disabled = false;
    }
    
    function salvarPedidoNovaCopia() {
        if (!modeloSelecionadoParaCopia) {
            showErrorToast("Selecione um modelo de faca válido."); return;
        }
        const solicitante = document.getElementById('copia_solicitante').value;
        const fornecedor = document.getElementById('copia_fornecedor').value;

        if (!solicitante || !fornecedor) {
            showErrorToast("Solicitante e Fornecedor são obrigatórios."); return;
        }
        
        document.getElementById('btnConfirmarCopiaFaca').disabled = true;
        showToast("Solicitando nova cópia...", "green");
        
        google.script.run
            .withSuccessHandler(onSalvoComSucesso)
            .withFailureHandler(onSalvarErro)
            .salvarPedidoNovaCopiaFaca({
                codFacaModelo: modeloSelecionadoParaCopia,
                solicitante: solicitante,
                fornecedor: fornecedor
            });
    }
    
    // ===============================================
    // LÓGICA MODAL 4: DETALHES COMPLETOS (UNIFICADO)
    // ===============================================
    
    function abrirModalDetalhesCompletos(idUnico) {
      document.getElementById('detalhes-loading').style.display = 'block';
      document.getElementById('detalhes-conteudo').style.display = 'none';
      
      modalDetalhesInstance.open();
      
      google.script.run
        .withSuccessHandler(preencherModalDetalhes)
        .withFailureHandler((err) => {
          showErrorToast(err.message);
          modalDetalhesInstance.close();
        })
        .getDetalhesFacaInventario(idUnico);
    }
    
    // (MUDANÇA) Função auxiliar que preenche os campos editáveis
    function _preencherCamposModalDetalhes(item, modelo) {
        itemSelecionadoGlobal = item;
        if (!itemSelecionadoGlobal) {
            showErrorToast("Erro: Item do inventário não encontrado.");
            return false;
        }
        
        // Modal de Detalhes (Campos Editáveis)
        document.getElementById('inv_id_unico').value = item.idUnico;
        document.getElementById('inv_id_unico_display').value = item.idUnico;
        document.getElementById('inv_cod_modelo_hidden').value = item.codFacaModelo;
        document.getElementById('inv_cod_modelo_display').value = item.codFacaModelo;
        document.getElementById('inv_status').value = item.status;
        document.getElementById('inv_localizacao').value = item.localizacao;
        document.getElementById('inv_obs').value = item.obs || ""; // (NOVO)
        
        // Modal de Detalhes (Grid Estático do Modelo)
        if (modelo) {
          document.getElementById('detalhe_tipo_faca').textContent = modelo.tipo || "N/A";
          document.getElementById('detalhe_formato').textContent = `${modelo.largura || '0'} x ${modelo.altura || '0'} mm`;
          document.getElementById('detalhe_puxada').textContent = `${modelo.puxada || '0'} mm`;
          document.getElementById('detalhe_carreiras_rep').textContent = `${modelo.carreiras || '0'} Car. / ${modelo.repeticoes || '0'} Rep.`;
          document.getElementById('detalhe_entre_rep').textContent = `${modelo.entreRepeticoes || '0'} mm`;
          document.getElementById('detalhe_cilindro').textContent = modelo.cilindro || "N/A";
        }
        
        M.textareaAutoResize(document.getElementById('inv_obs')); // (NOVO)
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalDetalhesFaca select'), materializeSelectOptions);
        return true;
    }
    
    
    function preencherModalDetalhes(data) {
      if (!data.sucesso) {
        showErrorToast(data.mensagem);
        modalDetalhesInstance.close();
        return;
      }
      
      const item = data.item;
      const modelo = data.modelo;
      const pedidos = data.pedidos || [];
      const problemas = data.problemas || [];
      const logUso = data.logUso || [];
      
      // Seção 1: Preenche os campos de edição e o grid estático
      _preencherCamposModalDetalhes(item, modelo);

      // Seção 2: Histórico de Uso (UPGRADE 3)
      const logCorpo = document.getElementById('detalhe-loguso-corpo');
      logCorpo.innerHTML = '';
      let totalMetros = 0;
      if (logUso.length === 0) {
        document.getElementById('detalhe-loguso-vazio').style.display = 'block';
      } else {
        document.getElementById('detalhe-loguso-vazio').style.display = 'none';
        logUso.sort((a,b) => new Date(b.dataUso.split('/').reverse().join('-')) - new Date(a.dataUso.split('/').reverse().join('-'))); // Mais recente primeiro
        
        logUso.forEach(log => {
          totalMetros += log.metrosConsumidos;
          // Nova string formatada para a coluna Cliente/Produto
          const clienteProduto = `(${log.codProduto} | ${log.nomeCliente} - ${log.descricaoProduto})`; 
          
          logCorpo.innerHTML += `
            <tr>
              <td>${log.dataUso}</td>
              <td>${log.numPedidoFeira}</td>
              <td>${clienteProduto}</td>               <td style="text-align: left !important;">${log.metrosConsumidos.toFixed(2)} m</td>
            </tr>`;
        });
      }
      document.getElementById('detalhe_total_metros').textContent = `${totalMetros.toFixed(0)} m`;

      // Seção 3: Histórico de Pedidos de Compra (UPGRADE 1)
      const pedidosCorpo = document.getElementById('detalhe-pedidos-corpo');
      pedidosCorpo.innerHTML = '';
      if (pedidos.length === 0) {
        document.getElementById('detalhe-pedidos-vazio').style.display = 'block';
      } else {
        document.getElementById('detalhe-pedidos-vazio').style.display = 'none';
        pedidos.sort((a,b) => new Date(b.dataSolicitacao.split('/').reverse().join('-')) - new Date(a.dataSolicitacao.split('/').reverse().join('-')));
        
        pedidos.forEach(p => {
          let btnReceber = '';
          if (!p.dataRecebimento) { 
            btnReceber = `<button class="btn-small btn-receber waves-effect" 
                                  title="Registrar Recebimento"
                                  data-id-pedido-faca="${p.idPedidoFaca}"
                                  data-id-unico-faca="${p.idUnicoFaca}">
                                <i class="material-icons">local_shipping</i>
                          </button>`;
          }
          let statusClasse = 'status-aguardando-confeccao';
          if(p.statusRecebimento === 'No Prazo') statusClasse = 'status-disponivel';
          if(p.statusRecebimento === 'Atrasado') statusClasse = 'status-danificada';
          
          pedidosCorpo.innerHTML += `
            <tr>
              <td>${p.dataSolicitacao}</td>
              <td>${p.solicitante}</td>
              <td>${p.fornecedor}</td>
              <td>${p.tipoPedido || 'N/A'}</td>
              <td>${p.dataPrevista}</td>
              <td>${p.dataRecebimento || "---"}</td>
              <td class="col-status-cell ${statusClasse}">${p.statusRecebimento || 'Pendente'}</td>
              <td>${btnReceber}</td>
            </tr>`;
        });
      }
      
      // Seção 4: Histórico de Problemas (UPGRADE 2)
      const problemasCorpo = document.getElementById('detalhe-problemas-corpo');
      problemasCorpo.innerHTML = '';
      if (problemas.length === 0) {
        document.getElementById('detalhe-problemas-vazio').style.display = 'block';
      } else {
        document.getElementById('detalhe-problemas-vazio').style.display = 'none';
        problemas.sort((a,b) => new Date(b.dataReporte.split('/').reverse().join('-')) - new Date(a.dataReporte.split('/').reverse().join('-')));

        problemas.forEach(p => {
          let tipoProblema = p.descricaoMotivo;
          let descProblema = "";
          if (p.descricaoMotivo && p.descricaoMotivo.includes(':')) {
             const partes = p.descricaoMotivo.split(':');
             tipoProblema = partes[0].trim();
             descProblema = partes.slice(1).join(':').trim();
          }

          problemasCorpo.innerHTML += `
            <tr>
              <td>${p.dataReporte}</td>
              <td>${tipoProblema}</td>
              <td>${descProblema}</td>
            </tr>`;
        });
      }

      document.getElementById('detalhes-loading').style.display = 'none';
      document.getElementById('detalhes-conteudo').style.display = 'block';
    }
    
    // (MUDANÇA) Salva os campos editáveis (incluindo OBS)
    function salvarItemInventario() {
        const btnDetalhes = document.getElementById('btnSalvarDetalhes');
        btnDetalhes.disabled = true;
        
        const item = {
            idUnico: document.getElementById('inv_id_unico').value,
            codFacaModelo: document.getElementById('inv_cod_modelo_hidden').value,
            status: document.getElementById('inv_status').value,
            localizacao: document.getElementById('inv_localizacao').value,
            obs: document.getElementById('inv_obs').value // (NOVO)
        };
        
        google.script.run
            .withSuccessHandler(onSalvoComSucesso_AtualizarDetalhes) 
            .withFailureHandler(onSalvarErro)
            .atualizarItemInventarioFaca(item); // (MUDANÇA) Chama a V3.1
    }

    // ===============================================
    // LÓGICA MODAL 5: RECEBIMENTO (NF/VALOR)
    // ===============================================
    
    function abrirModalRecebimento(idPedidoFaca, idUnicoFaca) {
        pedidoParaReceber = { idPedidoFaca, idUnicoFaca };
        
        document.getElementById('receber_id_pedido_faca').textContent = idPedidoFaca;
        document.getElementById('receber_id_unico_faca').value = idUnicoFaca;
        document.getElementById('receber_valor_nf').value = '';
        document.getElementById('receber_num_nf').value = '';
        
        const datepicker = M.Datepicker.getInstance(document.getElementById('receber_data'));
        datepicker.setDate(new Date());
        
        M.updateTextFields();
        modalRecebimentoInstance.open();
    }
    
    function confirmarRecebimentoFaca() {
        const btn = document.getElementById('btnConfirmarRecebimento');
        btn.disabled = true;
        
        const datepicker = M.Datepicker.getInstance(document.getElementById('receber_data'));
        const dataRecebimento = datepicker.toString();
        
        const dados = {
          idPedidoFaca: pedidoParaReceber.idPedidoFaca,
          idUnicoFaca: pedidoParaReceber.idUnicoFaca,
          dataRecebimento: dataRecebimento,
          valorNF: document.getElementById('receber_valor_nf').value,
          numNF: document.getElementById('receber_num_nf').value
        };

        if (!dados.dataRecebimento || !dados.valorNF || !dados.numNF) {
            showErrorToast("Erro: Data, Valor e Nº da NF são obrigatórios.");
            btn.disabled = false; return;
        }
        
        showToast("Registrando recebimento...", "green");
        google.script.run
            .withSuccessHandler(onSalvoComSucesso_AtualizarDetalhes) 
            .withFailureHandler(onSalvarErro)
            .receberPedidoFaca(dados);
    }
    
    // ===============================================
    // LÓGICA MODAL 6: REPORTAR PROBLEMA (UPGRADE 2)
    // ===============================================
    
    function abrirModalReportarProblema() {
        if (!itemSelecionadoGlobal) {
            showErrorToast("Erro: Nenhum item de faca selecionado.");
            modalDetalhesInstance.close();
            return;
        }
        
        document.getElementById('problema_id_unico').value = itemSelecionadoGlobal.idUnico;
        document.getElementById('problema_id_unico_display').textContent = itemSelecionadoGlobal.idUnico;
        
        document.getElementById('problema_tipo').value = '';
        document.getElementById('problema_motivo_descricao').value = '';
        
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalReportarProblemaFaca select'), materializeSelectOptions);
        modalReportarProblemaInstance.open();
    }
    
    function salvarReporteProblema() {
        const btn = document.getElementById('btnConfirmarReporte');
        btn.disabled = true;

        const idUnico = document.getElementById('problema_id_unico').value;
        const tipoProblema = document.getElementById('problema_tipo').value;
        const descricao = document.getElementById('problema_motivo_descricao').value;
        
        if (!tipoProblema || !descricao || descricao.trim().length < 5) {
            showErrorToast("Erro: Tipo e Descrição (mín. 5 caracteres) são obrigatórios.");
            btn.disabled = false; return;
        }
        
        const motivoFormatado = `${tipoProblema}: ${descricao}`;
        
        showToast("Reportando problema...", "green");
        google.script.run
            .withSuccessHandler(onSalvoComSucesso_AtualizarDetalhes) 
            .withFailureHandler(onSalvarErro)
            .reportarProblemaFaca(idUnico, motivoFormatado);
    }

    // ===============================================
    // (NOVO) LÓGICA MODAL 7: PEDIR SUBSTITUIÇÃO (UPGRADE 1)
    // ===============================================

    function abrirModalSubstituirFaca() {
        if (!itemSelecionadoGlobal) {
            showErrorToast("Erro: Nenhum item de faca selecionado.");
            modalDetalhesInstance.close();
            return;
        }
        
        document.getElementById('subs_id_unico').value = itemSelecionadoGlobal.idUnico;
        document.getElementById('subs_cod_modelo').value = itemSelecionadoGlobal.codFacaModelo;
        document.getElementById('subs_id_unico_display').textContent = itemSelecionadoGlobal.idUnico;
        
        document.getElementById('subs_solicitante').value = '';
        document.getElementById('subs_fornecedor').value = '';
        document.getElementById('subs_tipo_pedido').value = '';
        document.getElementById('subs_descricao_motivo').value = '';
        document.getElementById('subs_descricao_motivo_wrapper').style.display = 'none';
        
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('#modalSubstituirFaca select'), materializeSelectOptions);
        modalSubstituirInstance.open();
    }

    function salvarPedidoSubstituicao() {
        const btn = document.getElementById('btnConfirmarSubstituicao');
        btn.disabled = true;

        const dados = {
          idUnicoFaca: document.getElementById('subs_id_unico').value,
          codFacaModelo: document.getElementById('subs_cod_modelo').value,
          solicitante: document.getElementById('subs_solicitante').value,
          fornecedor: document.getElementById('subs_fornecedor').value,
          tipoPedido: document.getElementById('subs_tipo_pedido').value,
          descricaoMotivo: document.getElementById('subs_descricao_motivo').value
        };

        if (!dados.solicitante || !dados.fornecedor || !dados.tipoPedido) {
            showErrorToast("Erro: Solicitante, Fornecedor e Motivo são obrigatórios.");
            btn.disabled = false; return;
        }
        if (dados.tipoPedido.includes("Danificada") && !dados.descricaoMotivo) {
             showErrorToast("Erro: A Descrição é obrigatória para Faca Danificada.");
            btn.disabled = false; return;
        }
        
        showToast("Salvando pedido de substituição...", "green");
        
        google.script.run
            .withSuccessHandler(onSalvoComSucesso_AtualizarDetalhes) 
            .withFailureHandler(onSalvarErro)
            .salvarPedidoReposicaoFaca(dados); 
    }

  </script>

</body>
</html>
