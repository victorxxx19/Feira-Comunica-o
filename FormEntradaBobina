<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    
    <style>
        body { background-color: #f9faff; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex: 1 0 auto; padding: 20px 30px; }
        
        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 30px; background-color: #ffffff;
            border-bottom: 2px solid;
            border-image: linear-gradient(to right, #0047BB, #C8E154) 1;
        }
        .header-container h4 {
            font-size: 1.8rem; font-weight: 600; color: #0047BB;
            display: flex; align-items: center; margin: 0;
        }
        .header-container h4 > i { font-size: 2.2rem; margin-right: 10px; }

        .input-field input:focus + label, .input-field textarea:focus + label { color: #0047BB !important; }
        .input-field input:focus, .input-field textarea:focus {
            border-bottom: 1px solid #0047BB !important;
            box-shadow: 0 1px 0 0 #0047BB !important;
        }
        .btn, .btn-large { background-color: #0047BB !important; }
        .btn:hover, .btn-large:hover { background-color: #003a9a !important; }
        .btn-secundario { background-color: #C8E154 !important; color: #333 !important; }
        .btn-secundario:hover { background-color: #afc741 !important; }
        .btn-green { background-color: #4CAF50 !important; }
        .btn-green:hover { background-color: #43a047 !important; }

        .select-wrapper input.select-dropdown:focus { border-bottom: 1px solid #0047BB !important; }
        .dropdown-content li > span { color: #0047BB !important; }
        
        .section-card {
            background: #ffffff; border-radius: 8px; padding: 25px;
            margin-top: 25px; border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 1.3rem; font-weight: 600; color: #0047BB;
            display: flex; align-items: center; margin: -5px 0 25px 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section-title i { margin-right: 10px; }
        
        #loader-container { display: none; text-align: center; margin-top: 20px; }

        /* Card de Sucesso */
        #success-card {
            display: none; /* Começa escondido */
            text-align: center;
        }
        #success-card h5 {
            color: #4CAF50;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }
        #success-card h5 i {
            font-size: 2.5rem;
            margin-right: 10px;
        }
        #success-card p {
            font-size: 1.1rem;
            color: #555;
        }
        
        /* Estilo do Checkbox */
        [type="checkbox"]:checked+span:not(.lever):before {
            border-right-color: #0047BB !important;
            border-bottom-color: #0047BB !important;
        }
    </style>
</head>

<body>
    <div class="header-container">
        <h4>
            <i class="material-icons">receipt_long</i>
            Entrada de Bobinas
        </h4>
    </div>

    <main>
        
        <div id="form-container">
            <div class="section-card">
                <h5 class="section-title"><i class="material-icons">label</i>Passo 1: Identificação do Lote</h5>
                <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s12 m8">
                        <input id="lote_fornecedor" type="text" placeholder="Escaneie ou digite o lote do fornecedor (Ex: P00045608)">
                        <label for="lote_fornecedor">Lote do Fornecedor</label>
                    </div>
                    <div class="input-field col s12 m4">
                        <select id="fornecedor">
                            <option value="" disabled selected>Carregando...</option>
                        </select>
                        <label>Fornecedor</label>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h5 class="section-title"><i class="material-icons">layers</i>Passo 2: Detalhes do Material</h5>
                <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s12">
                        <select id="substrato">
                            <option value="" disabled selected>Carregando...</option>
                        </select>
                        <label>Substrato</label>
                    </div>
                </div>

                <div class="row" style="margin-bottom: 0;">
                <div class="input-field col s12">
                    <select id="tipo_de_cola">
                        <option value="" disabled selected>Carregando...</option>
                    </select>
                    <label>Tipo de Cola</label>
                </div>
            </div>

            </div>

            <div class="section-card">
                <h5 class="section-title"><i class="material-icons">straighten</i>Passo 3: Medidas e Quantidade</h5>
                <div class="row">
                    <div class="input-field col s12 m4">
                        <input id="largura_inicial" type="text" placeholder="Ex: 1,5 ou 0,250">
                        <label for="largura_inicial">Largura Inicial (em metros)</label>
                    </div>
                    <div class="input-field col s12 m4">
                        <input id="comprimento_inicial" type="text" placeholder="Ex: 1000">
                        <label for="comprimento_inicial">Comprimento Inicial (em metros)</label>
                    </div>
                    <div class="input-field col s12 m4">
                        <input id="quantidade_bobinas" type="number" min="1" value="1">
                        <label for="quantidade_bobinas">Quantidade de Bobinas</label>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 15px; margin-bottom: 0;">
                    <div class="col s12">
                        <label>
                            <input type="checkbox" id="is_pre_cortada" />
                            <span>Esta é uma Bobina **Pré-Cortada** (Gerar etiquetas de "Filha" automaticamente)</span>
                        </label>
                    </div>
                </div>
                
            </div>
            
            <div class="row" style="text-align: center; margin-top: 40px;">
                <div class="col s12">
                    <button id="btnSalvar" class="btn-large waves-effect waves-light btn-secundario">
                        <i class="material-icons left">add_circle</i>
                        Registrar e Gerar Etiquetas
                    </button>
                    <div id="loader-container">
                        <div class="preloader-wrapper big active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="success-card" class="section-card">
            <h5><i class="material-icons">check_circle</i>Sucesso! Bobinas Registradas.</h5>
            <p>O PDF com as etiquetas foi gerado. Clique no botão abaixo para imprimir.</p>
            <p>Depois, feche a aba de impressão e clique em "Registrar Nova Entrada".</p>
            <br>
            <a id="btnImprimirPDF" href="#" target="_blank" class="btn-large waves-effect waves-light btn-green">
                <i class="material-icons left">print</i>
                Abrir PDF para Impressão
            </a>
            <br><br>
            <button id="btnRegistrarNovo" class="btn-flat waves-effect waves-light">
                <i class="material-icons left">refresh</i>
                Registrar Nova Entrada
            </button>
        </div>

    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            M.FormSelect.init(document.querySelectorAll('select'));
            // M.Checkbox.init(...) // <-- ESTA ERA A LINHA COM BUG. FOI REMOVIDA.
            M.updateTextFields();
            
            google.script.run
                .withSuccessHandler(onDadosIniciaisSuccess)
                .withFailureHandler(onFailure)
                .getDadosIniciaisBobina();

            document.getElementById('btnSalvar').addEventListener('click', salvarEntrada);
            document.getElementById('btnRegistrarNovo').addEventListener('click', resetarFormulario);
        });

        function onDadosIniciaisSuccess(dados) {
            const selFornecedor = document.getElementById('fornecedor');
            selFornecedor.innerHTML = '<option value="" disabled selected>Selecione</option>';
            dados.fornecedores.forEach(f => {
                selFornecedor.innerHTML += `<option value="${f}">${f}</option>`;
            });
            
            const selSubstrato = document.getElementById('substrato');
            selSubstrato.innerHTML = '<option value="" disabled selected>Selecione</option>';
            dados.substratos.forEach(s => {
                selSubstrato.innerHTML += `<option value="${s}">${s}</option>`;
            });

            const selCola = document.getElementById('tipo_de_cola');
            selCola.innerHTML = '<option value="" disabled selected>Selecione</option>';
            dados.tipoDeCola.forEach(c => {
            selCola.innerHTML += `<option value="${c}">${c}</option>`;
            });

            M.FormSelect.init(document.querySelectorAll('select'));
        }

        function salvarEntrada() {
            const dados = {
                lote: document.getElementById('lote_fornecedor').value,
                quantidade: document.getElementById('quantidade_bobinas').value,
                fornecedor: document.getElementById('fornecedor').value,
                substrato: document.getElementById('substrato').value,
                tipoDeCola: document.getElementById('tipo_de_cola').value,
                largura: document.getElementById('largura_inicial').value,
                comprimento: document.getElementById('comprimento_inicial').value,
                isPreCortada: document.getElementById('is_pre_cortada').checked 
            };
            
            if (!dados.lote || !dados.quantidade || !dados.fornecedor || !dados.substrato || !dados.tipoDeCola || !dados.largura || !dados.comprimento) {
            M.toast({html: 'Erro: Todos os campos são obrigatórios.', classes: 'red darken-2'});
            return;
            }

            showLoader(true);

            google.script.run
                .withSuccessHandler(onSalvarSuccess) 
                .withFailureHandler(onFailure)
                .salvarEntradaBobina(dados);
        }
        
        function onSalvarSuccess(resposta) {
            showLoader(false);
            if (resposta.sucesso) {
                M.toast({html: resposta.mensagem, classes: 'green', displayLength: 2500});
                
                document.getElementById('btnImprimirPDF').href = resposta.pdfLink;
                
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('success-card').style.display = 'block';

            } else {
                onFailure({ message: resposta.mensagem });
            }
        }

        function resetarFormulario() {
            document.getElementById('success-card').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';

            document.getElementById('lote_fornecedor').value = "";
            document.getElementById('quantidade_bobinas').value = "1";
            document.getElementById('largura_inicial').value = "";
            document.getElementById('comprimento_inicial').value = "";
            document.getElementById('is_pre_cortada').checked = false;
            
            document.getElementById('fornecedor').value = "";
            document.getElementById('substrato').value = "";
            document.getElementById('tipo_de_cola').value = "";
            M.FormSelect.init(document.querySelectorAll('select')); 
            
            M.updateTextFields();
            document.getElementById('lote_fornecedor').focus();
        }
        
        function onFailure(erro) {
            showLoader(false);
            M.toast({html: 'Erro: ' + erro.message, classes: 'red darken-2'});
        }

        function showLoader(isLoading) {
            document.getElementById('loader-container').style.display = isLoading ? 'block' : 'none';
            document.getElementById('btnSalvar').disabled = isLoading;
        }
    </script>
</body>
</html>
