<!DOCTYPE html>
<html>
<head>
<base target="_top">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<style>
/* ===================================================
   ESTILOS GERAIS (Baseado no FormProducao)
=================================================== */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f0f2f5;
  margin: 0;
  padding: 0 0 80px 0;
}
.header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 25px;
  background-color: #ffffff;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.header-title {
  display: flex;
  align-items: center;
  font-size: 1.6rem;
  font-weight: 600;
  color: #37417c;
}
.header-title i {
  font-size: 2.0rem;
  margin-right: 12px;
  color: #37417c;
}
.header-logo {
  max-height: 45px;
  width: auto;
}
#divObjetos {
  max-width: 1600px;
  margin: 0 auto;
  padding: 5px 20px 20px 20px; 
  box-shadow: none !important;
  background-color: transparent; 
  opacity: 1;
  transition: opacity 0.3s ease;
}
.subtitulo-descricao {
  font-style: italic;
  color: #555;
  margin-bottom: 15px;
  text-align: left;
  padding-left: 5px;
}
.section-container {
  margin-bottom: 25px;
}
.section-header {
  display: flex;
  align-items: center;
  padding-bottom: 10px;
  border-bottom: 2px solid #C8E154;
  margin-bottom: 15px;
}
.section-header i {
  font-size: 2.0rem;
  color: #37417c;
  margin-right: 10px;
}
.section-header span {
  font-size: 1.5rem;
  font-weight: 400;
  color: #37417c;
  text-transform: uppercase;
}
.section-content {
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* ===================================================
   ESTILOS DA TABELA (Simplificado)
=================================================== */
.tabela-cq {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.tabela-cq thead th {
  background-color: #37417c;
  color: #ffffff;
  padding: 10px 10px !important;
  font-size: 0.85rem;
  text-transform: uppercase;
  border-bottom: 2px solid #ccc;
  text-align: center !important;
  font-weight: bold;
  word-wrap: break-word;
  vertical-align: middle;
}
.tabela-cq tbody td {
  padding: 8px 5px !important;
  vertical-align: middle !important;
  text-align: center;
  color: #000;
  line-height: 1.4;
  font-weight: 500;
  font-size: 0.8rem;
  word-wrap: break-word;
}

/* Larguras Tabela 1 (Para Iniciar) */
#tabela-para-controlar thead th:nth-child(1) { width: 8%; } /* N° Pedido */
#tabela-para-controlar thead th:nth-child(2) { width: 10%; } /* Data Entrega */
#tabela-para-controlar thead th:nth-child(3) { width: 22%; } /* Cliente */
#tabela-para-controlar thead th:nth-child(4) { width: 25%; } /* Descrição */
#tabela-para-controlar thead th:nth-child(5) { width: 10%; } /* Qtd. Pedido */
#tabela-para-controlar thead th:nth-child(6) { width: 15%; } /* Status Atual */
#tabela-para-controlar thead th:nth-child(7) { width: 10%; } /* Ação */

/* Larguras Tabela 2 (Em Controle) */
#tabela-em-controle thead th:nth-child(1) { width: 8%; } /* N° Pedido */
#tabela-em-controle thead th:nth-child(2) { width: 10%; } /* Data Entrega */
#tabela-em-controle thead th:nth-child(3) { width: 20%; } /* Cliente */
#tabela-em-controle thead th:nth-child(4) { width: 10%; } /* Qtd. Pedido */
#tabela-em-controle thead th:nth-child(5) { width: 12%; } /* Qtd. Aprovada */
#tabela-em-controle thead th:nth-child(6) { width: 10%; } /* Qtd. Reprovada */
#tabela-em-controle thead th:nth-child(7) { width: 5%; } /* Lotes */
#tabela-em-controle thead th:nth-child(8) { width: 25%; } /* Ações */

/* Estilos de Ação */
td.col-acao-cq {
  text-align: center;
  padding: 5px 2px !important;
  vertical-align: middle;
}
td.col-acao-cq .btn,
td.col-acao-cq .btn-small {
  padding: 0 0.8rem;
  height: 28px;
  line-height: 28px;
  font-size: 0.75rem;
  text-transform: none; 
  margin: 2px 2px;
}
.btn-iniciar-cq { background-color: #00897B !important; } /* Teal */
.btn-lancar-lote { background-color: #1E88E5 !important; } /* Blue */
.btn-ver-lotes { background-color: #757575 !important; } /* Grey */
.btn-finalizar-cq { background-color: #43A047 !important; } /* Green */

/* Números Clicáveis e Status */
.num-pedido-clicavel { cursor: pointer !important; color: #37417c; font-weight: bold; text-decoration: underline; }
.data-alerta { color: #FF9800 !important; font-weight: bold; }
.data-atrasada { color: #D32F2F !important; font-weight: bold; }
.data-status-icon { font-size: 1rem; vertical-align: bottom; margin-left: 2px;}
.status-producao-finalizada { background-color: #E1BEE7 !important; color: #6A1B9A !important; }
.status-controlando { background-color: #BBDEFB !important; color: #1565C0 !important; }

/* Tooltip (para resumo de lotes) */
.chip.tooltipped {
  cursor: help;
  display: inline-block;
  padding: 4px 8px;
  font-size: 0.8rem;
  height: auto;
  line-height: 1.2;
}
.qtd-aprovada, .qtd-reprovada {
  font-weight: bold;
}
.qtd-aprovada.excedente-ok { color: #2E7D32; } /* Verde */
.qtd-aprovada.excedente-falta { color: #E65100; } /* Laranja */
.qtd-aprovada.excedente-excesso { color: #D32F2F; } /* Vermelho */
.qtd-reprovada { color: #D32F2F; }

/* Rodapé Fixo */
#footer-bar {
  position: fixed;
  bottom: 0; 
  left: 0;
  width: 100%;
  background-color: #ffffff;
  border-top: 1px solid #ddd;
  padding: 12px 24px;
  display: flex;
  justify-content: flex-end;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  z-index: 999;
}
#btnReportarProblema {
  background-color: #E53935 !important; /* Vermelho */
  color: #ffffff !important;
  font-weight: bold;
}

/* ===================================================
   PADRONIZAÇÃO DE MODAIS (NOVO)
=================================================== */

/* --- 1. Estilo Padrão para Títulos H4 de TODOS os modais --- */
.modal h4 {
  border-bottom: 2px solid;
  border-image: linear-gradient(to right, #37417c, #C8E154) 1;
  padding-bottom: 15px;
  margin-bottom: 20px !important;
  color: #37417c;
  font-weight: 600;
  font-size: 1.5rem !important;
  display: flex;
  align-items: center;
}
.modal h4 i {
    margin-right: 10px;
}
/* Ajusta o tamanho do modal de detalhes */
#detalhes-pedido-modal { 
  max-width: 1200px !important; 
  width: 95% !important; 
  max-height: 90% !important;
}
#modal-lancar-lote, #modal-reportar-problema-cq { max-width: 600px; }
#modal-ver-lotes { max-width: 800px; }

/* --- 2. Estilos para Modais de INPUT (Lançar Lote, Reportar Problema) --- */
/* Esta é a adaptação do .detalhes-pedido-valor para os .input-field */

#modal-lancar-lote .input-field,
#modal-reportar-problema-cq .input-field {
  display: flex;
  flex-direction: column; /* Força o label a ficar em cima */
  background-color: #f5f7fa;
  border-radius: 6px;
  border-left: 3px solid #37417c;
  padding: 8px 12px 4px 12px; /* Padding para o label e o input */
  margin-top: 20px; /* Espaço para o label "flutuar" */
  margin-bottom: 15px;
  box-sizing: border-box;
}

/* Força o Label a parecer o .detalhes-pedido-label */
#modal-lancar-lote .input-field label,
#modal-reportar-problema-cq .input-field label {
  position: static; /* Remove o comportamento de flutuação */
  transform: none !important; /* Remove o comportamento de flutuação */
  font-size: 0.75rem !important;
  color: #37417c !important; /* Azul, não cinza */
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  pointer-events: none; /* Não interage com o clique */
  width: 100%;
}
/* Faz o label da textarea ficar alinhado */
#modal-lancar-lote .input-field label[for^="lote-motivo"],
#modal-reportar-problema-cq .input-field label[for^="problema-cq-descricao"] {
  margin-bottom: 8px;
}


/* Remove as bordas/sombras dos inputs/selects internos */
#modal-lancar-lote .input-field input[type=number],
#modal-lancar-lote .input-field input[type=text],
#modal-lancar-lote .input-field .select-wrapper input.select-dropdown,
#modal-reportar-problema-cq .input-field input[type=text],
#modal-reportar-problema-cq .input-field .select-wrapper input.select-dropdown {
  border-bottom: none !important;
  box-shadow: none !important;
  margin: 0 !important;
  height: 1.8rem !important; /* Altura menor para o input */
  line-height: 1.8rem !important;
  font-size: 0.95rem !important;
  color: #000 !important;
  font-weight: 500 !important;
  padding: 0 !important; /* Remove padding interno do input */
  background-color: transparent !important;
}

/* Ajustes finos para o input não ter padding extra */
#modal-lancar-lote .input-field .select-wrapper,
#modal-reportar-problema-cq .input-field .select-wrapper {
    padding: 0;
    margin: 0;
    display: block;
    height: 1.8rem;
}
#modal-lancar-lote .input-field .select-wrapper .caret,
#modal-reportar-problema-cq .input-field .select-wrapper .caret {
    fill: #37417c;
    top: 2px; /* Ajuste vertical da seta */
}

/* Ajuste para Textarea */
#modal-lancar-lote .input-field textarea.materialize-textarea,
#modal-reportar-problema-cq .input-field textarea.materialize-textarea {
  height: 6rem !important; /* Altura maior para textarea */
  padding: 0 !important;
  margin: 0 !important;
  line-height: 1.4rem;
  border-bottom: none !important;
  box-shadow: none !important;
  background-color: transparent;
}

/* --- 3. Estilos do Modal de DETALHES (Copiados do FormProducao) --- */
/* (Estes já estavam no seu FormQualidade original, mas estão aqui para garantir) */
.detalhes-pedido-grid-3-col {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px 24px;
  margin-bottom: 20px;
}
.detalhes-pedido-item { display: flex; flex-direction: column; }
.detalhes-pedido-label {
  font-size: 0.75rem; color: #666;
  text-transform: uppercase;
  font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px;
}
.detalhes-pedido-valor {
  font-size: 0.95rem;
  color: #000; font-weight: 500;
  padding: 8px 12px; background-color: #f5f7fa;
  border-radius: 6px; border-left: 3px solid #37417c;
  min-height: 38px; word-wrap: break-word;
}
.detalhes-pedido-item.full-width { grid-column: 1 / -1; }
.detalhes-pedido-item.span-2 { grid-column: span 2; }
.detalhes-pedido-secao {
  margin-top: 24px;
  padding-top: 20px; border-top: 1px solid #e0e0e0;
}
.detalhes-pedido-secao-titulo {
  font-size: 0.85rem;
  color: #37417c; text-transform: uppercase;
  font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px;
  display: flex; align-items: center;
}
.detalhes-pedido-secao-titulo i { margin-right: 8px; font-size: 1.1rem; }
.detalhes-pedido-obs {
  background-color: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 12px 16px; border-radius: 6px; color: #856404;
  font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;
  word-wrap: break-word;
}
.detalhes-pedido-obs.vazio {
  background-color: #f5f7fa; border-left-color: #ccc;
  color: #999; font-style: italic;
}

/* --- 4. Estilos específicos do Modal VER LOTES --- */
#modal-ver-lotes .modal-content { padding-bottom: 10px; }
#tabela-lotes-cq { width: 100%; margin-top: 15px; }
#tabela-lotes-cq th { background: #f4f4f4; color: #333; text-align: center; padding: 8px 5px; font-size: 0.8rem; }
#tabela-lotes-cq td { text-align: center; padding: 8px 5px; font-size: 0.8rem; border-bottom: 1px solid #eee; }
#lotes-resumo-container {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 2px solid #37417c;
}
.resumo-item { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 8px;}
.resumo-label { color: #555; }
.resumo-valor { font-weight: bold; color: #000; }
#resumo-lotes-status,
#finalizar-status-validacao {
  font-weight: bold;
  font-size: 1.1rem;
  text-align: center;
  padding: 8px;
  border-radius: 4px;
}
/* Cores do status de validação */
.validacao-ok { background-color: #E8F5E9; color: #2E7D32; }
.validacao-erro { background-color: #FFEBEE; color: #C62D2D; }


/* --- 5. Outros Estilos --- */
#msg-sem-pedidos,
#msg-sem-cq {
  font-style: italic;
  color: #777;
  padding: 20px; 
  text-align: center;
  margin: 0;
}
.modal .modal-footer .btn-flat { color: #E53935 !important; }
.modal .modal-footer .btn { background-color: #37417c !important; }
.modal .modal-footer .btn.green { background-color: #4CAF50 !important; }
.modal .modal-footer .btn.red { background-color: #E53935 !important; }

/* Loader (mantido) */
#page-loader { 
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
  background: rgba(255,255,255,0.7); 
  z-index: 9998; 
  display: flex; 
  justify-content: center; 
  align-items: center;
}
</style>
</head>
<body>

<div id="toast-custom-container"></div>

<div id="page-loader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9998; display: flex; justify-content: center; align-items: center;">
  <div class="preloader-wrapper active">
    <div class="spinner-layer spinner-blue-only">
      <div class="circle-clipper left"><div class="circle"></div></div>
      <div class="gap-patch"><div class="circle"></div></div>
      <div class="circle-clipper right"><div class="circle"></div></div>
    </div>
  </div>
</div>

<div class="header-container z-depth-1">
  <div class="header-title">
    <i class="material-icons">verified</i> <span>Controle de Qualidade</span>
  </div>
  <img src="[meucodebase64]" alt="Logo" class="header-logo">
</div>

<div id="divObjetos">
  
  <p class="subtitulo-descricao">
    Pedidos liberados da produção para iniciar o controle de qualidade.
  </p>

  <div class="section-container">
    <div class="section-header">
      <i class="material-icons">playlist_add</i>
      <span>Para Iniciar Controle</span>
    </div>
    <div class="section-content z-depth-1">
      <div id="tabela-para-controlar-container">
        <table id="tabela-para-controlar" class="tabela-cq striped highlight">
          <thead>
            <tr>
              <th>N° do Pedido</th>
              <th>Data de Entrega</th>
              <th>Cliente</th>
              <th>Descrição</th>
              <th>Qtd. Pedido</th>
              <th>Status Atual</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody id="tabela-para-controlar-corpo"></tbody>
        </table>
        <p id="msg-sem-pedidos" style="display: none;">
          Não há pedidos "Produção Finalizada" aguardando o início do controle.
        </p>
      </div>
    </div>
  </div>

  <div class="section-container">
    <div class="section-header">
      <i class="material-icons">rule</i>
      <span>Em Controle de Qualidade</span>
    </div>
    <div class="section-content z-depth-1">
      <div id="tabela-em-controle-container">
        <table id="tabela-em-controle" class="tabela-cq striped highlight">
          <thead>
            <tr>
              <th>N° do Pedido</th>
              <th>Data Entrega</th>
              <th>Cliente</th>
              <th>Qtd. Pedido</th>
              <th>Qtd. Aprovada</th>
              <th>Qtd. Reprovada</th>
              <th>Lotes</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabela-em-controle-corpo"></tbody>
        </table>
      </div>
      <p id="msg-sem-cq" style="display: none;">
        Não há pedidos "Controlando" na fila de qualidade.
      </p>
    </div>
  </div>

</div> <div id="footer-bar">
  <button id="btnReportarProblema" class="btn waves-effect" onclick="abrirModalReportarProblema()">
    Reportar Problema
    <i class="material-icons right">report_problem</i>
  </button>
</div>

<div id="modal-lancar-lote" class="modal">
  <div class="modal-content">
    <h4><i class="material-icons left">add_task</i>Lançar Lote de Inspeção</h4>
    <p>Registre um lote de inspeção para o Pedido: <strong id="lote-num-pedido-label">---</strong></p>
    <div class="row" style="margin-top: 20px;">
      <div class="input-field col s6">
        <select id="lote-unidade-cq">
          </select>
        <label>Unidade CQ</label>
      </div>
      <div class="input-field col s6">
        <select id="lote-inspetor">
          </select>
        <label>Inspetor</label>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s6">
        <input id="lote-qtd-aprovada" type="number" step="1">
        <label for="lote-qtd-aprovada">Qtd. Aprovada</label>
      </div>
      <div class="input-field col s6">
        <input id="lote-qtd-reprovada" type="number" step="1" value="0">
        <label for="lote-qtd-reprovada">Qtd. Reprovada</label>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s12">
        <select id="lote-motivo-reprova">
          <option value="" disabled selected>Selecione o motivo (Obrigatório se Qtd. Reprovada > 0)</option>
          <option value="Variação de Impressão">Variação de Impressão</option>
          <option value="Desencaixe de Impressão">Desencaixe de Impressão</option>
          <option value="Falha de Impressão (Pontos, riscos)">Falha de Impressão (Pontos, riscos)</option>
          <option value="Falta de Tinta / Tinta Fraca">Falta de Tinta / Tinta Fraca</option>
          <option value="Excesso de Tinta / Borrão">Excesso de Tinta / Borrão</option>
          <option value="Degolando Liner">Degolando Liner</option>
          <option value="Corte com Rebarba">Corte com Rebarba</option>
          <option value="Corte Fora de Padrão">Corte Fora de Padrão</option>
          <option value="Contaminação / Manchas">Contaminação / Manchas</option>
          <option value="Material Fora de Especificação">Material Fora de Especificação</option>
          <option value="Outro (Reportar no Log de Problemas)">Outro (Reportar no Log de Problemas)</option>
        </select>
        <label for="lote-motivo-reprova">Motivo da Reprova (se houver)</label>
      </div>
    </div>
    <input type="hidden" id="lote-num-pedido-hidden">
  </div>
  <div class="modal-footer">
    <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
    <button class="waves-effect btn green" id="btn-salvar-lote">Salvar Lote</button>
  </div>
</div>

<div id="modal-ver-lotes" class="modal">
  <div class="modal-content">
    <h4><i class="material-icons left">list_alt</i>Lotes Inspecionados</h4>
    <p>Pedido: <strong id="ver-lotes-num-pedido">---</strong></p>
    
    <div id="ver-lotes-loading" style="text-align: center; padding: 20px; display: none;">
      <div class="preloader-wrapper active small">
        <div class="spinner-layer spinner-blue-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div>
      </div>
      <p>Buscando lotes...</p>
    </div>

    <table id="tabela-lotes-cq" class="striped">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Unidade CQ</th>
          <th>Inspetor</th>
          <th>Qtd. Aprovada</th>
          <th>Qtd. Reprovada</th>
          <th>Motivo Reprova</th>
        </tr>
      </thead>
      <tbody id="corpo-tabela-lotes">
        </tbody>
    </table>
    
    <div id="lotes-resumo-container">
      <div class="resumo-item">
        <span class="resumo-label">Qtd. Pedido Original:</span>
        <span class="resumo-valor" id="resumo-lotes-qtd-pedido">---</span>
      </div>
      <div class="resumo-item">
        <span class="resumo-label">Total Aprovado:</span>
        <span class="resumo-valor" id="resumo-lotes-total-aprovado">---</span>
      </div>
      <div class="resumo-item">
        <span class="resumo-label">Total Reprovado:</span>
        <span class="resumo-valor" id="resumo-lotes-total-reprovado">---</span>
      </div>
      <div id="resumo-lotes-status" style="margin-top: 15px;">
        </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="modal-close waves-effect waves-grey btn-flat">Fechar</button>
  </div>
</div>

<div id="modal-confirmar-finalizar" class="modal">
  <div class="modal-content">
    <h4 id="finalizar-titulo"><i class="material-icons left green-text">check_circle</i>Finalizar Controle?</h4>
    <p>Você está prestes a finalizar o controle do Pedido <strong id="finalizar-num-pedido">---</strong> e enviá-lo para a Expedição.</p>
    
    <div id="finalizar-resumo-container" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
      </div>
    
    <div id="finalizar-motivo-atraso-container" style="display: none; margin-top: 15px;">
      <p class="red-text text-darken-2" style="font-weight: bold;"><i class="material-icons left">warning</i>Este pedido está sendo finalizado COM ATRASO.</p>
      <div class="input-field">
        <textarea id="finalizar-motivo-atraso-input" class="materialize-textarea" placeholder="Obrigatório"></textarea>
        <label for="finalizar-motivo-atraso-input">Motivo do Atraso</label>
      </div>
    </div>

    <input type="hidden" id="finalizar-linha-planilha">
  </div>
  <div class="modal-footer">
    <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
    <button class="waves-effect btn green" id="btn-confirmar-finalizacao">Confirmar e Enviar</button>
  </div>
</div>

<div id="modal-reportar-problema-cq" class="modal">
  <div class="modal-content">
    <h4><i class="material-icons left red-text">report_problem</i>Reportar Problema de Qualidade</h4>
    <p>Reporte um problema identificado durante a inspeção. Isso <strong>não</strong> altera o status do pedido, apenas registra o problema.</p>
    <div class="row">
      <div class="input-field col s12">
        <input id="problema-cq-num-pedido" type="text" class="validate">
        <label for="problema-cq-num-pedido">Nº do Pedido (Obrigatório)</label>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s12">
        <select id="problema-cq-inspetor">
          </select>
        <label>Inspetor (Obrigatório)</label>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s12">
        <select id="problema-cq-tipo">
          <option value="" disabled selected>Escolha o Tipo de Problema</option>
          <option value="Tonalidade Fora do Padrão">Tonalidade Fora do Padrão</option>
          <option value="Falha de Registro (Gráfico)">Falha de Registro (Gráfico)</option>
          <option value="Falha de Corte (Faca)">Falha de Corte (Faca)</option>
          <option value="Material/Substrato Incorreto">Material/Substrato Incorreto</option>
          <option value="Contaminação (Manchas, Sujeira)">Contaminação (Manchas, Sujeira)</option>
          <option value="Problema no Tubete/Acabamento">Problema no Tubete/Acabamento</option>
          <option value="Outro (Descrever)">Outro (Descrever)</option>
        </select>
        <label>Tipo de Problema (Obrigatório)</label>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s12">
        <textarea id="problema-cq-descricao" class="materialize-textarea" placeholder="Descreva o problema em detalhes..."></textarea>
        <label for="problema-cq-descricao">Descrição Detalhada (Obrigatório)</label>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="modal-close waves-effect waves-grey btn-flat">Cancelar</button>
    <button class="waves-effect btn red" id="btn-confirmar-reporte-cq">Reportar Problema</button>
  </div>
</div>

<div id="detalhes-pedido-modal" class="modal">
    <div class="modal-content">
      <h4 id="detalhes-titulo">Detalhes do Pedido</h4>
      <div id="detalhes-loading" style="text-align: center; padding: 40px;">
        <div class="preloader-wrapper active">
          <div class="spinner-layer spinner-blue-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div>
        </div>
        <p>Buscando dados...</p>
      </div>
      <div id="detalhes-conteudo" style="display: none;">
  <div class="detalhes-pedido-grid-3-col">
    
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">N° Pedido</span><span id="detalhe-num-pedido" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Pedido</span><span id="detalhe-data-pedido" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Pedido</span><span id="detalhe-tipo-pedido" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Quantidade Pedida</span><span id="detalhe-quantidade" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Vendedora</span><span id="detalhe-vendedora" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Expedição</span><span id="detalhe-tipo-expedicao" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Entrega</span><span id="detalhe-data-entrega" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Conclusão</span><span id="detalhe-data-conclusao" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Status do Pedido</span><span id="detalhe-status" class="detalhes-pedido-valor"></span></div>
    
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cód. Produto</span><span id="detalhe-cod-produto" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cliente</span><span id="detalhe-cliente" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item span-2"><span class="detalhes-pedido-label">Descrição do Produto</span><span id="detalhe-descricao" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Faca</span><span id="detalhe-faca" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Substrato</span><span id="detalhe-substrato" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Tipo de Cola</span><span id="detalhe-tipo-cola" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Largura (mm)</span><span id="detalhe-largura" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Altura (mm)</span><span id="detalhe-altura" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Puxada (mm)</span><span id="detalhe-puxada" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Qtd. Cores</span><span id="detalhe-qtd-cores" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Carreiras</span><span id="detalhe-carreiras" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Acabamento</span><span id="detalhe-tipo-acabamento" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Cold</span><span id="detalhe-cold" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Metragem Calculada (m)</span><span id="detalhe-metragem" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Sem Excedente?</span><span id="detalhe-sem-excedente" class="detalhes-pedido-valor"></span></div>

    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Máquina (Prod)</span><span id="detalhe-maquina" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Fila (Prod)</span><span id="detalhe-fila" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Impressor</span><span id="detalhe-impressor" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Início Produção</span><span id="detalhe-data-inicio-prod" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Data Fim Produção</span><span id="detalhe-data-fim-prod" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Fornecedor Substrato</span><span id="detalhe-fornecedor-substrato" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Lote Substrato</span><span id="detalhe-lote-substrato" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Metragem Real (m)</span><span id="detalhe-metragem-real" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Refugo (m)</span><span id="detalhe-refugo-metragem" class="detalhes-pedido-valor"></span></div>
    
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Unidade CQ</span><span id="detalhe-unidade-cq" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Inspetor</span><span id="detalhe-inspetor" class="detalhes-pedido-valor"></span></div>
    <div class="detalhes-pedido-item"><span class="detalhes-pedido-label">Qtd. Aprovada CQ</span><span id="detalhe-qtd-aprovada-cq" class="detalhes-pedido-valor"></span></div>
    
  </div>

  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">announcement</i> Observações PCP</h6>
    <div id="detalhe-obs-pcp" class="detalhes-pedido-obs vazio">Nenhuma observação.</div>
  </div>
  
  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">build</i> Problemas da Produção</h6>
    <div id="detalhe-problemas-producao" class="detalhes-pedido-obs vazio">Nenhum problema relatado.</div>
  </div>

  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">info</i> Observações/Problemas CQ</h6>
    <div id="detalhe-obs-cq" class="detalhes-pedido-obs vazio">Nenhuma observação.</div>
  </div>
  
  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">warning</i> Motivo Metragem a Mais</h6>
    <div id="detalhe-motivo-mais-metragem" class="detalhes-pedido-obs vazio">Nenhum motivo informado.</div>
  </div>
  
  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">history</i> Motivo Atraso</h6>
    <div id="detalhe-motivo-atraso" class="detalhes-pedido-obs vazio">Nenhum atraso ou motivo informado.</div>
  </div>
  
  <div class="detalhes-pedido-secao">
    <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">cancel</i> Motivo Cancelamento</h6>
    <div id="detalhe-motivo-cancelamento" class="detalhes-pedido-obs vazio">Não cancelado.</div>
  </div>

</div>
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat">Fechar</button>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
// ===================================================
// JAVASCRIPT (FormQualidade) - v2.0 (Modelo de Log)
// ===================================================

// --- Variáveis Globais ---
let todosPedidos = [];
let todosLotesInspecao = {}; // Mapa { numPedido: [...] }
let listaInspetores = [];
let listaUnidadesCQ = ["Mesa-01", "Mesa-02", "Mesa-03", "Vemax", "Revisora One"]; // Lista fixa

// Instâncias de Modais
let modalLancarLote, modalVerLotes, modalFinalizar, modalReportarProblema, modalDetalhesInstance;

// --- Inicialização ---
document.addEventListener('DOMContentLoaded', function() {
  // Inicializa todos os modais
  modalLancarLote = M.Modal.init(document.getElementById('modal-lancar-lote'), { dismissible: true });
  modalVerLotes = M.Modal.init(document.getElementById('modal-ver-lotes'), { dismissible: true });
  modalFinalizar = M.Modal.init(document.getElementById('modal-confirmar-finalizar'), { dismissible: false });
  modalReportarProblema = M.Modal.init(document.getElementById('modal-reportar-problema-cq'), { dismissible: true });
  modalDetalhesInstance = M.Modal.init(document.getElementById('detalhes-pedido-modal'), { dismissible: true });

  showPageLoader(true);
  google.script.run
    .withSuccessHandler(onDadosCarregados)
    .withFailureHandler(onCarregarErro)
    .buscarPedidosParaQualidade_v2(); // <- Nova função de backend

  setupListeners(); 
});

// --- Callbacks do Backend ---
function onDadosCarregados(dadosDoBackend) {
  if (dadosDoBackend && dadosDoBackend.sucesso) {
    todosPedidos = dadosDoBackend.pedidos || [];
    todosLotesInspecao = dadosDoBackend.lotesInspecao || {};
    listaInspetores = dadosDoBackend.inspetores || [];
    
    // Popula dropdowns que só precisam ser preenchidos uma vez
    populateDropdownsFixos();
    
    renderizarTabelas();
  } else {
    onCarregarErro({ message: dadosDoBackend.erro || "O backend não retornou dados válidos." });
  }
  showPageLoader(false);
}

function onCarregarErro(err) {
  showPageLoader(false);
  showErrorToast("Falha ao carregar dados: " + (err.message || "Erro desconhecido."));
}

// --- Funções de Renderização ---

function populateDropdownsFixos() {
  const selectUnidade = document.getElementById('lote-unidade-cq');
  const selectInspetorLote = document.getElementById('lote-inspetor');
  const selectInspetorProblema = document.getElementById('problema-cq-inspetor');
  
  selectUnidade.innerHTML = gerarOptions(listaUnidadesCQ, "", true, "Selecione a Unidade");
  selectInspetorLote.innerHTML = gerarOptions(listaInspetores, "", true, "Selecione o Inspetor");
  selectInspetorProblema.innerHTML = gerarOptions(listaInspetores, "", true, "Selecione o Inspetor");
  
  // Re-inicializa selects dos modais (os da tabela são inicializados no render)
  M.FormSelect.init(document.querySelectorAll('#modal-lancar-lote select, #modal-reportar-problema-cq select'));
}

function renderizarTabelas() {
  const controlarCorpo = document.getElementById('tabela-para-controlar-corpo');
  const emControleCorpo = document.getElementById('tabela-em-controle-corpo');
  const msgSemPedidos = document.getElementById('msg-sem-pedidos');
  const msgSemCQ = document.getElementById('msg-sem-cq');
  
  controlarCorpo.innerHTML = "";
  emControleCorpo.innerHTML = "";
  
  let pedidosParaControlar = [];
  let pedidosEmControle = [];

  todosPedidos.forEach(pedido => {
    const statusNormal = normalizarStatus(pedido.status);
    // ADICIONADO "emproducao" A ESTA LISTA
    if (statusNormal === 'producaofinalizada' || statusNormal === 'emproducao') {
      pedidosParaControlar.push(pedido);
    } else if (statusNormal === 'controlando') {
      pedidosEmControle.push(pedido);
    }
  });

  // Renderiza Tabela 1
  if (pedidosParaControlar.length === 0) {
    msgSemPedidos.style.display = 'block';
  } else {
    msgSemPedidos.style.display = 'none';
    pedidosParaControlar.sort((a, b) => parseDate(a.dataEntrega) - parseDate(b.dataEntrega));
    pedidosParaControlar.forEach(pedido => {
      controlarCorpo.appendChild(criarLinhaParaControlar(pedido));
    });
  }
  
  // Renderiza Tabela 2
  if (pedidosEmControle.length === 0) {
    msgSemCQ.style.display = 'block';
  } else {
    msgSemCQ.style.display = 'none';
    pedidosEmControle.sort((a, b) => parseDate(a.dataEntrega) - parseDate(b.dataEntrega));
    pedidosEmControle.forEach(pedido => {
      // Pega os lotes agregados que o backend já processou
      const agregados = todosLotesInspecao[pedido.numPedido] || { totalAprovado: 0, totalReprovado: 0, count: 0 };
      emControleCorpo.appendChild(criarLinhaEmControle(pedido, agregados));
    });
  }
  
  // Re-inicializa tooltips
  M.Tooltip.init(document.querySelectorAll('.tooltipped'), { position: 'top' });
}

function criarLinhaParaControlar(pedido) {
  const tr = document.createElement('tr');
  tr.dataset.linhaPlanilha = pedido.linhaPlanilha;
  const dataStatus = checkDataStatus(pedido.dataEntrega);
  
  tr.innerHTML = `
    <td class="num-pedido-clicavel">${pedido.numPedido}</td>
    <td class="${dataStatus.classe}">${pedido.dataEntrega} ${dataStatus.icone}</td>
    <td class_name="col-cliente" style="text-align: left;">${pedido.cliente}</td>
    <td class_name="col-descricao" style="text-align: left;">${pedido.descricao}</td>
    <td>${formatarNumero(pedido.quantidade)}</td>
    <td class="${getStatusColorClass(pedido.status)}">${pedido.status}</td>
    <td class="col-acao-cq">
      <button class="btn btn-small btn-iniciar-cq" data-linha="${pedido.linhaPlanilha}">
        Iniciar Controle <i class="material-icons right" style="font-size: 1rem; margin-left: 2px;">play_arrow</i>
      </button>
    </td>
  `;
  return tr;
}

function criarLinhaEmControle(pedido, agregados) {
  const tr = document.createElement('tr');
  tr.dataset.linhaPlanilha = pedido.linhaPlanilha;
  tr.dataset.numPedido = pedido.numPedido;
  const dataStatus = checkDataStatus(pedido.dataEntrega);
  
  const qtdPedidoNum = parseFloat(String(pedido.quantidade).replace(/\./g, '').replace(',', '.')) || 0;
  
  // Valida a quantidade aprovada
  const { classe, tooltip } = validarQtdAprovada(
    qtdPedidoNum, 
    agregados.totalAprovado, 
    pedido.semExcedente
  );

  tr.innerHTML = `
    <td class="num-pedido-clicavel">${pedido.numPedido}</td>
    <td class="${dataStatus.classe}">${pedido.dataEntrega} ${dataStatus.icone}</td>
    <td class_name="col-cliente" style="text-align: left;">${pedido.cliente}</td>
    <td>${formatarNumero(pedido.quantidade)}</td>
    <td class="qtd-aprovada ${classe}" data-tooltip="${tooltip}">${formatarNumero(agregados.totalAprovado)}</td>
    <td class="qtd-reprovada">${formatarNumero(agregados.totalReprovado)}</td>
    <td><span class="chip tooltipped" data-tooltip="Qtd. de lotes inspecionados">${agregados.count}</span></td>
    <td class="col-acao-cq">
      <button class="btn-small btn-lancar-lote" title="Lançar novo lote de inspeção"><i class="material-icons">add_task</i></button>
      <button class="btn-small btn-ver-lotes" title="Ver lotes lançados"><i class="material-icons">list_alt</i></button>
      <button class="btn btn-small btn-finalizar-cq" title="Finalizar CQ e Enviar p/ Expedição">
        Finalizar <i class="material-icons right" style="font-size: 1rem; margin-left: 2px;">check</i>
      </button>
    </td>
  `;
  return tr;
}

// --- Funções de Ação e Eventos ---

function setupListeners() {
  // Tabela 1: Iniciar Controle
  document.getElementById('tabela-para-controlar-corpo').addEventListener('click', function(event) {
    const btn = event.target.closest('.btn-iniciar-cq');
    if (btn) {
      handleIniciarControle(btn.dataset.linha);
    }
  });

  // Tabela 2: Ações (Lançar, Ver, Finalizar)
  document.getElementById('tabela-em-controle-corpo').addEventListener('click', function(event) {
    const tr = event.target.closest('tr[data-num-pedido]');
    if (!tr) return;
    
    const numPedido = tr.dataset.numPedido;
    const linhaPlanilha = tr.dataset.linhaPlanilha;

    if (event.target.closest('.btn-lancar-lote')) {
      abrirModalLancarLote(numPedido);
    }
    if (event.target.closest('.btn-ver-lotes')) {
      abrirModalVerLotes(numPedido);
    }
    if (event.target.closest('.btn-finalizar-cq')) {
      abrirModalFinalizar(numPedido, linhaPlanilha);
    }
  });

  // Salvar (Modal 1: Lançar Lote)
  document.getElementById('btn-salvar-lote').addEventListener('click', handleSalvarLote);
  
  // Confirmar (Modal 3: Finalizar)
  document.getElementById('btn-confirmar-finalizacao').addEventListener('click', handleFinalizarCQ);
  
  // Reportar Problema (Modal 4)
  document.getElementById('btn-confirmar-reporte-cq').addEventListener('click', handleReportarProblema);
  
  // Detalhes do Pedido (Ambas as tabelas)
  document.getElementById('divObjetos').addEventListener('click', function(event) {
    const pedidoCell = event.target.closest('.num-pedido-clicavel');
    if (pedidoCell) {
      const tr = pedidoCell.closest('tr[data-linha-planilha]');
      if (tr) {
        handleNumeroPedidoClick(tr.dataset.linhaPlanilha);
      }
    }
  });
}

// Ação: Tabela 1 -> Mover para Tabela 2
function handleIniciarControle(linhaPlanilha) {
  showPageLoader(true);
  google.script.run
    .withSuccessHandler(onDadosCarregados) // Recarrega tudo
    .withFailureHandler(onCarregarErro)
    .salvarInicioCQ(linhaPlanilha);
}

// Ação: Tabela 2 -> Abrir Modal 1 (Lançar Lote)
function abrirModalLancarLote(numPedido) {
  // Limpa o modal
  document.getElementById('lote-num-pedido-label').textContent = numPedido;
  document.getElementById('lote-num-pedido-hidden').value = numPedido;
  document.getElementById('lote-qtd-aprovada').value = "";
  document.getElementById('lote-qtd-reprovada').value = "0";
  document.getElementById('lote-motivo-reprova').value = "";
  
  // Reseta selects (Materialize)
  M.FormSelect.init(document.querySelectorAll('#modal-lancar-lote select'));
  M.updateTextFields(); // Atualiza labels
  
  modalLancarLote.open();
}

// Ação: Salvar (Modal 1)
function handleSalvarLote() {
  const dadosLote = {
    numPedido: document.getElementById('lote-num-pedido-hidden').value,
    unidadeCQ: document.getElementById('lote-unidade-cq').value,
    inspetor: document.getElementById('lote-inspetor').value,
    qtdAprovada: document.getElementById('lote-qtd-aprovada').value,
    qtdReprovada: document.getElementById('lote-qtd-reprovada').value || "0",
    motivoReprova: document.getElementById('lote-motivo-reprova').value
  };

  // Validação
  if (!dadosLote.unidadeCQ || !dadosLote.inspetor) {
    showErrorToast("Unidade CQ e Inspetor são obrigatórios.");
    return;
  }
  const qtdAprov = parseFloat(dadosLote.qtdAprovada) || 0;
  const qtdReprov = parseFloat(dadosLote.qtdReprovada) || 0;
  if (qtdAprov <= 0 && qtdReprov <= 0) {
    showErrorToast("A Qtd. Aprovada ou Reprovada deve ser maior que 0.");
    return;
  }
  if (qtdReprov > 0 && !dadosLote.motivoReprova) {
    showErrorToast("O Motivo da Reprova é obrigatório se Qtd. Reprovada > 0.");
    return;
  }

  showPageLoader(true);
  modalLancarLote.close();
  google.script.run
    .withSuccessHandler(onDadosCarregados) // Recarrega tudo
    .withFailureHandler(onCarregarErro)
    .salvarNovoLoteCQ(dadosLote);
}

// Ação: Tabela 2 -> Abrir Modal 2 (Ver Lotes)
function abrirModalVerLotes(numPedido) {
  const pedido = todosPedidos.find(p => p.numPedido == numPedido);
  if (!pedido) return;

  const agregados = todosLotesInspecao[numPedido] || { totalAprovado: 0, totalReprovado: 0, count: 0 };
  const qtdPedidoNum = parseFloat(String(pedido.quantidade).replace(/\./g, '').replace(',', '.')) || 0;

  // Preenche o resumo no modal
  document.getElementById('ver-lotes-num-pedido').textContent = numPedido;
  document.getElementById('resumo-lotes-qtd-pedido').textContent = formatarNumero(pedido.quantidade);
  document.getElementById('resumo-lotes-total-aprovado').textContent = formatarNumero(agregados.totalAprovado);
  document.getElementById('resumo-lotes-total-reprovado').textContent = formatarNumero(agregados.totalReprovado);
  
  // Atualiza o status de validação
  const { classe, mensagem } = validarQtdAprovada(qtdPedidoNum, agregados.totalAprovado, pedido.semExcedente, true);
  const statusEl = document.getElementById('resumo-lotes-status');
  statusEl.textContent = mensagem;
  statusEl.className = classe; // Define a cor (validacao-ok ou validacao-erro)

  // Mostra o loader e limpa a tabela
  document.getElementById('ver-lotes-loading').style.display = 'block';
  document.getElementById('corpo-tabela-lotes').innerHTML = "";
  modalVerLotes.open();

  // Busca os detalhes dos lotes
  google.script.run
    .withSuccessHandler(onDetalhesLoteRecebidos)
    .withFailureHandler(onCarregarErro)
    .getDetalhesInspecaoCQ(numPedido);
}

// Callback: Quando os detalhes dos lotes chegam (Modal 2)
function onDetalhesLoteRecebidos(lotes) {
  const corpoTabela = document.getElementById('corpo-tabela-lotes');
  corpoTabela.innerHTML = ""; // Limpa
  
  if (lotes && lotes.length > 0) {
    lotes.forEach(lote => {
      corpoTabela.innerHTML += `
        <tr>
          <td>${lote.data}</td>
          <td>${lote.unidadeCQ}</td>
          <td>${lote.inspetor}</td>
          <td>${formatarNumero(lote.qtdAprovada)}</td>
          <td>${formatarNumero(lote.qtdReprovada)}</td>
          <td style="text-align: left; max-width: 200px; white-space: pre-wrap;">${lote.motivoReprova}</td>
        </tr>
      `;
    });
  } else {
    corpoTabela.innerHTML = `<tr><td colspan="6">Nenhum lote lançado para este pedido.</td></tr>`;
  }
  
  document.getElementById('ver-lotes-loading').style.display = 'none';
}

// Ação: Tabela 2 -> Abrir Modal 3 (Finalizar)
function abrirModalFinalizar(numPedido, linhaPlanilha) {
  const pedido = todosPedidos.find(p => p.numPedido == numPedido);
  if (!pedido) return;

  const agregados = todosLotesInspecao[numPedido] || { totalAprovado: 0, totalReprovado: 0 };
  const qtdPedidoNum = parseFloat(String(pedido.quantidade).replace(/\./g, '').replace(',', '.')) || 0;
  
  // Preenche dados
  document.getElementById('finalizar-num-pedido').textContent = numPedido;
  document.getElementById('finalizar-linha-planilha').value = linhaPlanilha;

  // Valida
  const { valido, mensagem, classe } = validarQtdAprovada(qtdPedidoNum, agregados.totalAprovado, pedido.semExcedente, true);

  // Preenche o resumo no modal
  const resumoHTML = `
    <div class="resumo-item">
      <span class="resumo-label">Qtd. Pedido Original:</span>
      <span class="resumo-valor">${formatarNumero(pedido.quantidade)}</span>
    </div>
    <div class="resumo-item">
      <span class="resumo-label">Total Aprovado:</span>
      <span class="resumo-valor">${formatarNumero(agregados.totalAprovado)}</span>
    </div>
    <div class="resumo-item">
      <span class="resumo-label">Total Reprovado:</span>
      <span class="resumo-valor">${formatarNumero(agregados.totalReprovado)}</span>
    </div>
    <div id="finalizar-status-validacao" class="${classe}" style="margin-top: 15px; text-align: center; padding: 8px; font-weight: bold; border-radius: 4px;">
      ${mensagem}
    </div>
  `;
  document.getElementById('finalizar-resumo-container').innerHTML = resumoHTML;

  // Verifica Atraso
  const dataStatus = checkDataStatus(pedido.dataEntrega);
  const containerAtraso = document.getElementById('finalizar-motivo-atraso-container');
  const inputAtraso = document.getElementById('finalizar-motivo-atraso-input');
  if (dataStatus.classe === 'data-atrasada') {
    containerAtraso.style.display = 'block';
    inputAtraso.value = "";
    M.textareaAutoResize(inputAtraso);
    M.updateTextFields();
  } else {
    containerAtraso.style.display = 'none';
    inputAtraso.value = ""; // Limpa por segurança
  }

  // Habilita/Desabilita botão de confirmação
  document.getElementById('btn-confirmar-finalizacao').disabled = !valido;
  
  modalFinalizar.open();
}

// Ação: Salvar (Modal 3)
function handleFinalizarCQ() {
  const numPedido = document.getElementById('finalizar-num-pedido').textContent;
  const linhaPlanilha = document.getElementById('finalizar-linha-planilha').value;
  const motivoAtraso = document.getElementById('finalizar-motivo-atraso-input').value;
  const isAtrasado = document.getElementById('finalizar-motivo-atraso-container').style.display === 'block';

  if (isAtrasado && !motivoAtraso) {
    showErrorToast("O Motivo do Atraso é obrigatório.");
    return;
  }

  showPageLoader(true);
  modalFinalizar.close();
  google.script.run
    .withSuccessHandler(onDadosCarregados) // Recarrega tudo
    .withFailureHandler(onCarregarErro)
    .finalizarControleQualidade_v2(numPedido, linhaPlanilha, motivoAtraso);
}

// Ação: Footer -> Abrir Modal 4 (Reportar Problema)
function abrirModalReportarProblema() {
  // Limpa o modal
  document.getElementById('problema-cq-num-pedido').value = "";
  document.getElementById('problema-cq-descricao').value = "";
  // Reseta selects (Materialize)
  M.FormSelect.init(document.querySelectorAll('#modal-reportar-problema-cq select'));
  M.updateTextFields();
  modalReportarProblema.open();
}

// Ação: Salvar (Modal 4)
function handleReportarProblema() {
  const dadosProblema = {
    numPedido: document.getElementById('problema-cq-num-pedido').value,
    inspetor: document.getElementById('problema-cq-inspetor').value,
    tipoProblema: document.getElementById('problema-cq-tipo').value,
    descricao: document.getElementById('problema-cq-descricao').value
  };

  // Validação
  if (!dadosProblema.numPedido || !dadosProblema.inspetor || !dadosProblema.tipoProblema || !dadosProblema.descricao) {
    showErrorToast("Todos os campos são obrigatórios para reportar um problema.");
    return;
  }

  showPageLoader(true);
  modalReportarProblema.close();
  google.script.run
    .withSuccessHandler(function(msg) {
      showPageLoader(false);
      showSuccessToast(msg); // Não precisa recarregar a tela inteira por isso
    })
    .withFailureHandler(onCarregarErro)
    .reportarProblemaCQ_v2(dadosProblema);
}

function handleNumeroPedidoClick(linhaPlanilha) {
        const loading = document.getElementById('detalhes-loading');
        const content = document.getElementById('detalhes-conteudo');
        const grid = content.querySelector('.detalhes-pedido-grid-3-col');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        grid.innerHTML = ''; 
        content.querySelectorAll('.detalhes-pedido-secao').forEach(el => el.remove());
        
        modalDetalhesInstance.open();
        
        google.script.run
            .withSuccessHandler(onGetDetalhesSucesso)
            .withFailureHandler(onGetDetalhesErro)
            .getDetalhesCompletosDoPedido(linhaPlanilha); 
    }

    function onGetDetalhesSucesso(detalhes) {
        const loading = document.getElementById('detalhes-loading');
        const content = document.getElementById('detalhes-conteudo');
        const grid = content.querySelector('.detalhes-pedido-grid-3-col');
        grid.innerHTML = '';
        content.querySelectorAll('.detalhes-pedido-secao').forEach(el => el.remove());

        const addItem = (label, valor, span = 1, sufixo = '') => {
            const val = (valor || '---') + (valor ? sufixo : '');
            const item = document.createElement('div');
            item.className = `detalhes-pedido-item ${span === 2 ? 'span-2' : ''} ${span === 3 ? 'full-width' : ''}`;
            item.innerHTML = `<span class="detalhes-pedido-label">${label}</span><span class="detalhes-pedido-valor">${val}</span>`;
            grid.appendChild(item);
        };
        const addObs = (titulo, icone, valor, textoVazio) => {
            const secao = document.createElement('div');
            secao.className = 'detalhes-pedido-secao';
            let obsHtml = '';
            if (valor && valor.trim()) {
                let style = 'border-color: #ffc107; background-color: #fff3cd; color: #856404;'; // Amarelo
                if (titulo.includes('Problema') || titulo.includes('Cancelamento') || titulo.includes('Atraso')) {
                    style = 'border-color: #D32F2F; background-color: #FFEBEE; color: #B71C1C;'; // Vermelho
                }
                obsHtml = `<div class="detalhes-pedido-obs" style="${style}">${valor}</div>`;
            } else {
                obsHtml = `<div class="detalhes-pedido-obs vazio">${textoVazio}</div>`;
            }
            secao.innerHTML = `
                <h6 class="detalhes-pedido-secao-titulo"><i class="material-icons">${icone}</i> ${titulo}</h6>
                ${obsHtml}
            `;
            content.appendChild(secao);
        };

        // Preenche o Grid
        addItem('N° do Pedido', detalhes.numPedido);
        addItem('Data do Pedido', detalhes.dataPedido);
        addItem('Tipo de Pedido', detalhes.tipo);
        addItem('Quantidade Pedida', formatarNumero(detalhes.quantidade));
        addItem('Vendedora', detalhes.vendedora);
        addItem('Tipo de Expedição', detalhes.tipoExpedicao);
        addItem('Data de Entrega', detalhes.dataEntrega);
        addItem('Data de Conclusão', detalhes.dataConclusao);
        addItem('Status do Pedido', detalhes.status);
        addItem('Cód. Produto', detalhes.codProduto);
        addItem('Cliente', detalhes.cliente);
        addItem('Cód. Clichê', detalhes.idCliche)
        addItem('Descrição do Produto', detalhes.descricao, 2);
        addItem('Faca', detalhes.faca);
        addItem('Substrato', detalhes.substrato);
        addItem('Tipo de Cola', detalhes.tipoCola);
        addItem('Largura', detalhes.largura, 1, ' mm');
        addItem('Altura', detalhes.altura, 1, ' mm');
        addItem('Puxada', detalhes.puxada, 1, ' mm');
        addItem('Qtd. Cores', detalhes.qtdCores);
        addItem('Carreiras', detalhes.carreiras);
        addItem('Acabamento', detalhes.tipoAcabamento);
        addItem('Cold', detalhes.cold);
        addItem('Metragem Calculada', detalhes.metragem, 1, ' m');
        addItem('Sem Excedente?', (detalhes.semExcedente === 'true' || detalhes.semExcedente === 'VERDADEIRO') ? 'SIM' : 'NÃO');
        addItem('Máquina (Prod)', detalhes.maquina);
        addItem('Fila (Prod)', detalhes.fila);
        addItem('Impressor', detalhes.impressor);
        addItem('Data Início Produção', detalhes.dataInicioProd);
        addItem('Data Fim Produção', detalhes.dataFimProd);
        addItem('Fornecedor Substrato', detalhes.fornecedorSubstrato);
        addItem('Lote Substrato', detalhes.loteSubstrato);
        addItem('Metragem Real', detalhes.metragemReal, 1, ' m');
        addItem('Refugo', detalhes.refugoMetragem, 1, ' m');
        addItem('Unidade CQ', detalhes.unidadeCQ);
        addItem('Inspetor', detalhes.inspetor);
        addItem('Qtd. Aprovada CQ', formatarNumero(detalhes.qtdAprovadaCQ));

        // Preenche Observações
        addObs('Observações PCP', 'announcement', detalhes.obsPCP, 'Nenhuma observação.');
        addObs('Problemas da Produção', 'build', detalhes.problemasProducao, 'Nenhum problema relatado.');
        addObs('Observações/Problemas CQ', 'info', detalhes.obsCQ, 'Nenhuma observação.');
        addObs('Motivo Metragem a Mais', 'warning', detalhes.motivoMaisMetragem, 'Nenhum motivo informado.');
        addObs('Motivo Atraso', 'history', detalhes.motivoAtraso, 'Nenhum atraso ou motivo informado.');
        addObs('Motivo Cancelamento', 'cancel', detalhes.motivoCancelamento, 'Não cancelado.');

        loading.style.display = 'none';
        content.style.display = 'block';
    }

    function onGetDetalhesErro(err) {
      showErrorToast('Erro ao buscar detalhes: ' + err.message);
      modalDetalhesInstance.close();
    }


// (SUBSTITUA ESTA FUNÇÃO no <script> do FormQualidade.html)

function validarQtdAprovada(qtdPedido, qtdAprovada, semExcedente, gerarMensagem = false) {
  const isSemExcedente = (semExcedente === true || String(semExcedente).toUpperCase() === "TRUE");
  let valido = false;
  let mensagem = "";
  let classe = "";

  // Define os limites com base na regra
  let limiteMin = 0;
  let limiteMaxSobra = 0; // Limite que o cliente paga (acima disso vira sobra)

  if (isSemExcedente) {
    // --- REGRA 1: Sem Excedente ---
    limiteMin = qtdPedido;
    limiteMaxSobra = qtdPedido;
    valido = (qtdAprovada >= limiteMin); // Validação é só o MÍNIMO

    if (!valido) {
      mensagem = `INVÁLIDO: Qtd. Aprovada (${formatarNumero(qtdAprovada)}) deve ser NO MÍNIMO 100% (${formatarNumero(limiteMin)}).`;
      classe = "validacao-erro";
    } else {
      // Se for válido (>= 100%), verifica se há sobra
      const sobra = qtdAprovada - limiteMaxSobra;
      if (sobra > 0) {
        mensagem = `VALIDADO (com ${formatarNumero(sobra)} de sobra p/ estoque)`;
        classe = "validacao-ok";
      } else {
        mensagem = "VALIDADO (Exato)";
        classe = "validacao-ok";
      }
    }
  } else {
    // --- REGRA 2: Com Excedente ---
    limiteMin = Math.round(qtdPedido * 0.90);
    limiteMaxSobra = Math.round(qtdPedido * 1.10);
    valido = (qtdAprovada >= limiteMin); // Validação é só o MÍNIMO

    if (!valido) {
      mensagem = `INVÁLIDO: Qtd. Aprovada (${formatarNumero(qtdAprovada)}) está abaixo da tolerância mínima de 90% (${formatarNumero(limiteMin)}).`;
      classe = "validacao-erro";
    } else {
      // Se for válido (>= 90%), verifica se há sobra
      const sobra = qtdAprovada - limiteMaxSobra;
      if (sobra > 0) {
        mensagem = `VALIDADO (Dentro da tolerância, com ${formatarNumero(sobra)} de sobra p/ estoque)`;
        classe = "validacao-ok";
      } else {
        mensagem = "VALIDADO (Dentro da tolerância 10%)";
        classe = "validacao-ok";
      }
    }
  }

  // Retorno para os Modais (que usam gerarMensagem = true)
  if (gerarMensagem) {
    return { valido, mensagem, classe };
  } 
  
  // Retorno para a Tabela (CSS)
  else {
    let classeTabela = "";
    if (qtdAprovada > 0) {
      if (valido) {
        classeTabela = 'excedente-ok'; // Se passou na validação (>= 90% ou >= 100%), fica verde
      } else {
        classeTabela = 'excedente-falta'; // A única forma de falhar é estar abaixo do mínimo
      }
    }
    return { classe: classeTabela, tooltip: mensagem };
  }
}
function showPageLoader(show) {
  const loader = document.getElementById('page-loader');
  if (loader) loader.style.display = show ? 'flex' : 'none';
  document.getElementById('divObjetos').style.opacity = show ? 0.5 : 1;
  document.getElementById('footer-bar').style.display = show ? 'none' : 'flex';
}
function normalizarStatus(str) {
  if (!str) return "";
  return str.toLowerCase().replace(/[áàâã]/g, 'a').replace(/[éèê]/g, 'e').replace(/[íìî]/g, 'i').replace(/[óòôõ]/g, 'o').replace(/[úùûü]/g, 'u').replace(/ç/g, 'c').trim().replace(/\s/g, '');
}
function getStatusColorClass(status) {
  const statusLower = normalizarStatus(status);
  switch (statusLower) {
    case "producaofinalizada": return "status-producao-finalizada"; 
    case "controlando": return "status-controlando";
    default: return "";
  }
}
function showSuccessToast(message) { M.toast({ html: '<i class="material-icons left">check_circle</i> ' + message, classes: 'green darken-1', displayLength: 3000, container: '#toast-custom-container' }); }
function showErrorToast(error) { const msg = (typeof error === 'object' && error.message) ? error.message : error; M.toast({ html: '<i class="material-icons left">error</i> ' + msg, classes: 'red darken-2', displayLength: 5000, container: '#toast-custom-container' }); }
function formatarNumero(valor) { if (valor === null || valor === undefined || valor === "") return '0'; let numeroLimpo = String(valor).replace(/\./g, "").replace(',', '.'); let num = parseFloat(numeroLimpo); if (isNaN(num)) return valor; return num.toLocaleString('pt-BR', { maximumFractionDigits: 0, minimumFractionDigits: 0 }); }
function gerarOptions(lista, valorSelecionado, comVazio, textoVazio = "Selecione") {
  if (!lista) lista = [];
  let html = comVazio ? `<option value="" disabled ${!valorSelecionado ? 'selected' : ''}>${textoVazio}</option>` : '';
  lista.forEach(item => {
    const selected = item === valorSelecionado ? 'selected' : '';
    html += `<option value="${item}" ${selected}>${item}</option>`;
  });
  return html;
}
function parseDate(dateString) { if (!dateString) return new Date(0); const parts = dateString.split('/'); if (parts.length !== 3) return new Date(0); return new Date(parts[2], parts[1] - 1, parts[0]); }
function checkDataStatus(dateString) {
  if (!dateString) return { classe: "", icone: "" };
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const dataEntrega = parseDate(dateString); 
  if (isNaN(dataEntrega.getTime()) || dataEntrega.getTime() === 0) return { classe: "", icone: "" };
  const diffTime = dataEntrega.getTime() - hoje.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  if (diffDays < 0) {
    return { classe: 'data-atrasada', icone: '<i class="material-icons data-status-icon" style="font-size: 1rem; vertical-align: bottom;">error_outline</i>' };
  }
  if (diffDays <= 2) {
    return { classe: 'data-alerta', icone: '<i class="material-icons data-status-icon" style="font-size: 1rem; vertical-align: bottom;">warning</i>' };
  }
  return { classe: "", icone: '' };
}
</script>
</body>
</html>
